<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¦· ì•ì„ ì¼€ì–´ - ìë£Œ ê´€ë¦¬</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, system-ui, sans-serif; background: #f9fafb; color: #1a1a1a; line-height: 1.6; font-size: 14px; }
        .app-layout { display: flex; min-height: 100vh; }

        /* ì‚¬ì´ë“œë°” (ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œì™€ ë™ì¼) */
        .sidebar { width: 260px; background: #1f2937; display: flex; flex-direction: column; position: fixed; height: 100vh; z-index: 100; }
        .sidebar-header { padding: 20px; border-bottom: 1px solid #374151; }
        .logo { display: flex; align-items: center; gap: 12px; }
        .logo-icon { width: 40px; height: 40px; background: linear-gradient(135deg, #fbbf24, #f59e0b); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 18px; }
        .logo-text { font-size: 18px; font-weight: 700; color: white; }
        .logo-sub { font-size: 11px; color: #9ca3af; }
        .nav-section { flex: 1; padding: 16px 12px; overflow-y: auto; }
        .nav-group-title { font-size: 10px; font-weight: 600; color: #6b7280; text-transform: uppercase; letter-spacing: 1px; padding: 8px 12px 4px; }
        .nav-item { display: flex; align-items: center; gap: 10px; padding: 10px 12px; border-radius: 8px; color: #d1d5db; text-decoration: none; transition: all 0.2s; margin-bottom: 2px; font-size: 14px; }
        .nav-item:hover { background: #374151; color: white; }
        .nav-item.active { background: #f59e0b; color: #1f2937; font-weight: 600; }
        .nav-icon { font-size: 16px; width: 20px; text-align: center; }
        .nav-badge { background: #374151; color: #d1d5db; font-size: 11px; padding: 2px 8px; border-radius: 10px; margin-left: auto; }
        .nav-divider { height: 1px; background: #374151; margin: 8px 12px; }
        .sidebar-footer { padding: 16px; border-top: 1px solid #374151; }
        .user-card { display: flex; align-items: center; gap: 10px; }
        .user-avatar { width: 36px; height: 36px; background: #f59e0b; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; color: #1f2937; font-size: 14px; }
        .user-info { flex: 1; }
        .user-name { font-size: 13px; font-weight: 600; color: white; }
        .user-role { font-size: 11px; color: #9ca3af; }
        .logout-btn { background: none; border: none; color: #6b7280; cursor: pointer; font-size: 18px; padding: 4px; border-radius: 6px; }
        .logout-btn:hover { background: #374151; color: white; }

        /* ë©”ì¸ ì½˜í…ì¸  */
        .main-content { flex: 1; margin-left: 260px; }
        .top-header { display: flex; align-items: center; justify-content: space-between; padding: 20px 32px; background: white; border-bottom: 1px solid #e5e7eb; }
        .page-title h1 { font-size: 22px; font-weight: 700; }
        .page-title p { font-size: 13px; color: #6b7280; margin-top: 2px; }
        .header-actions { display: flex; gap: 10px; }

        .content-area { padding: 24px 32px; }

        /* ë²„íŠ¼ */
        .btn { padding: 10px 18px; border: none; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .btn-primary { background: #f59e0b; color: #1f2937; }
        .btn-primary:hover { background: #d97706; }
        .btn-secondary { background: #f3f4f6; color: #374151; }
        .btn-secondary:hover { background: #e5e7eb; }
        .btn-success { background: #10b981; color: white; }
        .btn-success:hover { background: #059669; }
        .btn-sm { padding: 6px 12px; font-size: 12px; }

        /* í†µê³„ ìš”ì•½ ì¹´ë“œ */
        .summary-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px; }
        .summary-card { background: white; border-radius: 12px; padding: 20px; border: 1px solid #e5e7eb; }
        .summary-card .label { font-size: 12px; color: #6b7280; margin-bottom: 4px; }
        .summary-card .value { font-size: 28px; font-weight: 700; color: #1f2937; }
        .summary-card .sub { font-size: 12px; color: #9ca3af; margin-top: 4px; }
        .summary-card .icon { font-size: 24px; float: right; margin-top: -4px; }

        /* í•„í„° ë°” */
        .filter-bar { display: flex; align-items: center; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; }
        .filter-bar input, .filter-bar select { padding: 9px 14px; border: 1.5px solid #e5e7eb; border-radius: 8px; font-size: 13px; background: white; }
        .filter-bar input:focus, .filter-bar select:focus { outline: none; border-color: #f59e0b; }

        /* ì¹´ë“œ */
        .card { background: white; border-radius: 14px; border: 1px solid #e5e7eb; overflow: hidden; margin-bottom: 24px; }
        .card-header { display: flex; align-items: center; justify-content: space-between; padding: 18px 24px; border-bottom: 1px solid #f3f4f6; }
        .card-title { font-size: 16px; font-weight: 700; }
        .card-body { padding: 0; }

        /* ë°ì´í„° í…Œì´ë¸” */
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th { padding: 12px 16px; text-align: left; font-size: 12px; font-weight: 600; color: #6b7280; background: #f9fafb; border-bottom: 1px solid #e5e7eb; white-space: nowrap; }
        .data-table td { padding: 14px 16px; border-bottom: 1px solid #f3f4f6; font-size: 13px; }
        .data-table tr:hover { background: #fffbeb; }
        .data-table tr:last-child td { border-bottom: none; }

        .hospital-name-cell { font-weight: 600; color: #1f2937; }
        .hospital-id-cell { font-size: 11px; color: #9ca3af; }

        /* KPI ë±ƒì§€ */
        .kpi-badge { display: inline-block; padding: 3px 10px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .kpi-badge.excellent { background: #d1fae5; color: #065f46; }
        .kpi-badge.good { background: #fef3c7; color: #92400e; }
        .kpi-badge.average { background: #fee2e2; color: #991b1b; }
        .kpi-badge.none { background: #f3f4f6; color: #9ca3af; }

        .trend-up { color: #10b981; font-weight: 600; }
        .trend-down { color: #ef4444; font-weight: 600; }
        .trend-neutral { color: #6b7280; }

        /* ìƒì„¸ë³´ê¸° ëª¨ë‹¬ */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 9999; opacity: 0; visibility: hidden; transition: all 0.3s; }
        .modal-overlay.show { opacity: 1; visibility: visible; }
        .modal { background: white; border-radius: 16px; width: 90%; max-width: 800px; max-height: 85vh; display: flex; flex-direction: column; box-shadow: 0 20px 60px rgba(0,0,0,0.2); }
        .modal-header { display: flex; align-items: center; justify-content: space-between; padding: 20px 24px; border-bottom: 1px solid #e5e7eb; }
        .modal-header h3 { font-size: 18px; font-weight: 700; }
        .modal-close { width: 36px; height: 36px; background: #f3f4f6; border: none; border-radius: 8px; font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .modal-close:hover { background: #e5e7eb; }
        .modal-body { padding: 24px; overflow-y: auto; flex: 1; }
        .modal-footer { padding: 16px 24px; border-top: 1px solid #e5e7eb; display: flex; gap: 10px; justify-content: flex-end; }

        /* ëª¨ë‹¬ ë‚´ë¶€ KPI ê·¸ë¦¬ë“œ */
        .detail-kpi-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 20px; }
        .detail-kpi { background: #f9fafb; border-radius: 10px; padding: 16px; text-align: center; border: 1px solid #e5e7eb; }
        .detail-kpi .val { font-size: 22px; font-weight: 700; color: #1f2937; }
        .detail-kpi .lbl { font-size: 11px; color: #6b7280; margin-top: 4px; }

        .detail-section-title { font-size: 14px; font-weight: 700; color: #374151; margin: 20px 0 10px 0; padding-bottom: 8px; border-bottom: 2px solid #f59e0b; }
        .detail-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .detail-table th { padding: 10px 12px; background: #f9fafb; font-weight: 600; color: #6b7280; text-align: center; border: 1px solid #e5e7eb; }
        .detail-table td { padding: 10px 12px; text-align: center; border: 1px solid #f3f4f6; }

        /* ë¹ˆ ìƒíƒœ */
        .empty-state { text-align: center; padding: 60px 20px; color: #9ca3af; }
        .empty-state .icon { font-size: 48px; margin-bottom: 16px; }
        .empty-state .title { font-size: 18px; font-weight: 600; color: #6b7280; margin-bottom: 8px; }

        /* í† ìŠ¤íŠ¸ */
        .toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(100px); padding: 14px 28px; border-radius: 10px; font-size: 14px; font-weight: 500; z-index: 9999; opacity: 0; transition: all 0.3s; }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        .toast.success { background: #10b981; color: white; }
        .toast.error { background: #ef4444; color: white; }

        /* ë¡œë”© */
        .loading-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.9); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; opacity: 0; visibility: hidden; transition: all 0.3s; }
        .loading-overlay.show { opacity: 1; visibility: visible; }
        .loading-spinner { width: 48px; height: 48px; border: 4px solid #fef3c7; border-top-color: #f59e0b; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 16px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { color: #6b7280; font-size: 14px; }

        /* ë™ì˜ ìƒíƒœ ë±ƒì§€ */
        .consent-badge { font-size: 11px; padding: 2px 8px; border-radius: 10px; font-weight: 600; }
        .consent-badge.yes { background: #d1fae5; color: #065f46; }
        .consent-badge.no { background: #fee2e2; color: #991b1b; }

        /* ë°˜ì‘í˜• */
        @media (max-width: 1024px) {
            .sidebar { display: none; }
            .main-content { margin-left: 0; }
            .summary-grid { grid-template-columns: repeat(2, 1fr); }
            .detail-kpi-grid { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 640px) {
            .summary-grid { grid-template-columns: 1fr; }
            .top-header { flex-direction: column; gap: 12px; align-items: flex-start; }
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">ë¡œë”© ì¤‘...</div>
    </div>
    <div class="toast" id="toast"></div>

    <div class="app-layout">
        <!-- ì‚¬ì´ë“œë°” -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <div class="logo-icon">ğŸ¦·</div>
                    <div>
                        <div class="logo-text">ì•ì„ ì¼€ì–´</div>
                        <div class="logo-sub">Admin Console</div>
                    </div>
                </div>
            </div>

            <nav class="nav-section">
                <div class="nav-group-title">ëŒ€ì‹œë³´ë“œ</div>
                <a class="nav-item" href="apsencare_admin_firebase.html">
                    <span class="nav-icon">ğŸ“Š</span>
                    <span class="nav-label">ì „ì²´ í˜„í™©</span>
                </a>

                <div class="nav-divider"></div>

                <div class="nav-group-title">ë³‘ì› ê´€ë¦¬</div>
                <a class="nav-item" href="#">
                    <span class="nav-icon">ğŸ¥</span>
                    <span class="nav-label">ë³‘ì› ëª©ë¡</span>
                </a>
                <a class="nav-item" href="#">
                    <span class="nav-icon">ğŸ«</span>
                    <span class="nav-label">ì´ˆëŒ€ì½”ë“œ</span>
                </a>

                <div class="nav-divider"></div>

                <div class="nav-group-title">ì½˜í…ì¸  ê´€ë¦¬</div>
                <a class="nav-item active" href="apsencare_admin_data.html">
                    <span class="nav-icon">ğŸ“</span>
                    <span class="nav-label">ìë£Œ ê´€ë¦¬</span>
                </a>
                <a class="nav-item" href="#">
                    <span class="nav-icon">ğŸ“¢</span>
                    <span class="nav-label">ê³µì§€ì‚¬í•­</span>
                </a>
                <a class="nav-item" href="#">
                    <span class="nav-icon">ğŸ“</span>
                    <span class="nav-label">êµìœ¡ ê´€ë¦¬</span>
                </a>

                <div class="nav-divider"></div>

                <div class="nav-group-title">ì‹œìŠ¤í…œ</div>
                <a class="nav-item" href="#">
                    <span class="nav-icon">ğŸ“ˆ</span>
                    <span class="nav-label">ì „ì²´ í†µê³„</span>
                </a>
                <a class="nav-item" href="#">
                    <span class="nav-icon">âš™ï¸</span>
                    <span class="nav-label">ì„¤ì •</span>
                </a>
            </nav>

            <div class="sidebar-footer">
                <div class="user-card">
                    <div class="user-avatar" id="userAvatar">-</div>
                    <div class="user-info">
                        <div class="user-name" id="userName">ë¡œë”© ì¤‘...</div>
                        <div class="user-role">Super Admin</div>
                    </div>
                    <button class="logout-btn" title="ë¡œê·¸ì•„ì›ƒ" onclick="handleLogout()">ğŸšª</button>
                </div>
            </div>
        </aside>

        <!-- ë©”ì¸ ì½˜í…ì¸  -->
        <main class="main-content">
            <header class="top-header">
                <div class="page-title">
                    <h1>ğŸ“ ìë£Œ ê´€ë¦¬</h1>
                    <p>ë³‘ì›ë³„ ë¶„ì„ í†µê³„ ë°ì´í„° ì¡°íšŒ Â· ë…¼ë¬¸ìš© ë°ì´í„° ë‚´ë³´ë‚´ê¸°</p>
                </div>
                <div class="header-actions">
                    <button class="btn btn-secondary" onclick="loadAllStats()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
                    <button class="btn btn-success" onclick="exportAllCSV()">ğŸ“¥ ì „ì²´ CSV ë‚´ë³´ë‚´ê¸°</button>
                </div>
            </header>

            <div class="content-area">
                <!-- ìš”ì•½ ì¹´ë“œ -->
                <div class="summary-grid">
                    <div class="summary-card">
                        <span class="icon">ğŸ¥</span>
                        <div class="label">ë¶„ì„ ì™„ë£Œ ë³‘ì›</div>
                        <div class="value" id="sumAnalyzed">-</div>
                        <div class="sub">í†µê³„ ë°ì´í„° ë³´ìœ </div>
                    </div>
                    <div class="summary-card">
                        <span class="icon">ğŸ“Š</span>
                        <div class="label">í‰ê·  ìœ ì§€ìœ¨</div>
                        <div class="value" id="sumAvgRetention">-</div>
                        <div class="sub">ì „ì²´ ë³‘ì› í‰ê· </div>
                    </div>
                    <div class="summary-card">
                        <span class="icon">ğŸ’°</span>
                        <div class="label">í‰ê·  YoY ì„±ì¥ë¥ </div>
                        <div class="value" id="sumAvgGrowth">-</div>
                        <div class="sub">ìˆ˜ë‚©ì•¡ ê¸°ì¤€</div>
                    </div>
                    <div class="summary-card">
                        <span class="icon">âœ…</span>
                        <div class="label">ë°ì´í„° í™œìš© ë™ì˜</div>
                        <div class="value" id="sumConsented">-</div>
                        <div class="sub">ì—°êµ¬ í™œìš© ê°€ëŠ¥</div>
                    </div>
                </div>

                <!-- í•„í„° -->
                <div class="filter-bar">
                    <input type="text" id="searchInput" placeholder="ğŸ” ë³‘ì›ëª… ê²€ìƒ‰..." oninput="filterTable()">
                    <select id="filterType" onchange="filterTable()">
                        <option value="all">ì „ì²´ ë³´ê¸°</option>
                        <option value="hasGrowth">ìˆ˜ë‚© ë¶„ì„ ì™„ë£Œ</option>
                        <option value="hasRetention">ìœ ì§€ìœ¨ ë¶„ì„ ì™„ë£Œ</option>
                        <option value="hasBoth">ë‘˜ ë‹¤ ì™„ë£Œ</option>
                        <option value="consented">ì—°êµ¬ ë™ì˜ ì™„ë£Œ</option>
                    </select>
                </div>

                <!-- ë³‘ì›ë³„ í†µê³„ í…Œì´ë¸” -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">ğŸ“‹ ë³‘ì›ë³„ ë¶„ì„ í†µê³„</h3>
                        <span style="font-size: 12px; color: #6b7280;" id="tableCount">0ê°œ ë³‘ì›</span>
                    </div>
                    <div class="card-body" style="overflow-x: auto;">
                        <table class="data-table" id="statsTable">
                            <thead>
                                <tr>
                                    <th>ë³‘ì›ëª…</th>
                                    <th style="text-align:center;">ìœ ì§€ìœ¨</th>
                                    <th style="text-align:center;">ì´íƒˆìœ¨</th>
                                    <th style="text-align:center;">YoY ì„±ì¥ë¥ </th>
                                    <th style="text-align:center;">ìµœê·¼ ìˆ˜ë‚©</th>
                                    <th style="text-align:center;">ê°ë‹¨ê°€</th>
                                    <th style="text-align:center;">ë¹„ê¸‰ì—¬ ë¹„ìœ¨</th>
                                    <th style="text-align:center;">ì—°êµ¬ ë™ì˜</th>
                                    <th style="text-align:center;">ê´€ë¦¬</th>
                                </tr>
                            </thead>
                            <tbody id="statsTableBody">
                                <tr><td colspan="9" class="empty-state"><div class="icon">ğŸ“Š</div><div class="title">ë¡œë”© ì¤‘...</div></td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- ìƒì„¸ë³´ê¸° ëª¨ë‹¬ -->
    <div class="modal-overlay" id="detailModal" onclick="closeDetailModal()">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3 id="detailModalTitle">ë³‘ì› ìƒì„¸ í†µê³„</h3>
                <button class="modal-close" onclick="closeDetailModal()">âœ•</button>
            </div>
            <div class="modal-body" id="detailModalBody"></div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeDetailModal()">ë‹«ê¸°</button>
                <button class="btn btn-success" id="exportSingleBtn" onclick="exportSingleCSV()">ğŸ“¥ ì´ ë³‘ì› CSV ë‚´ë³´ë‚´ê¸°</button>
            </div>
        </div>
    </div>

    <script>
        // ==================== Firebase ì´ˆê¸°í™” ====================
        const firebaseConfig = {
            apiKey: "AIzaSyDrU3rYs4fxlMkr8r0sjo70Mt0Al-HUtyg",
            authDomain: "apseoncare-platform.firebaseapp.com",
            projectId: "apseoncare-platform",
            storageBucket: "apseoncare-platform.firebasestorage.app",
            messagingSenderId: "515333523928",
            appId: "1:515333523928:web:e19a9db63c522d8484caad"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // ì „ì—­ ë³€ìˆ˜
        let allHospitalStats = [];
        let currentDetailHospital = null;

        // ==================== ì¸ì¦ ì²´í¬ ====================
        auth.onAuthStateChanged(async (user) => {
            if (!user) { window.location.href = 'index.html'; return; }
            await loadUserInfo(user.uid);
            await loadAllStats();
        });

        async function loadUserInfo(uid) {
            try {
                const userDoc = await db.collection('users').doc(uid).get();
                if (userDoc.exists) {
                    const d = userDoc.data();
                    if (d.userType !== 'admin') {
                        alert('ê´€ë¦¬ì ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
                        window.location.href = 'apsencare_hospital_home_firebase.html';
                        return;
                    }
                    document.getElementById('userAvatar').textContent = d.name ? d.name.charAt(0) : 'ê´€';
                    document.getElementById('userName').textContent = d.name || d.email;
                }
            } catch (e) { console.error('ì‚¬ìš©ì ì •ë³´ ì˜¤ë¥˜:', e); }
        }

        async function handleLogout() {
            if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) { await auth.signOut(); window.location.href = 'index.html'; }
        }

        // ==================== ì „ì²´ í†µê³„ ë¡œë“œ ====================
        async function loadAllStats() {
            showLoading('ë³‘ì› í†µê³„ ë°ì´í„° ë¡œë”© ì¤‘...');
            try {
                // 1. hospitalStats ì»¬ë ‰ì…˜ì—ì„œ ê° ë³‘ì›ì˜ ìµœì‹  ìš”ì•½ ë¡œë“œ
                const statsSnap = await db.collection('hospitalStats').get();

                // 2. users ì»¬ë ‰ì…˜ì—ì„œ ë™ì˜ ì •ë³´ ë¡œë“œ
                const usersSnap = await db.collection('users').where('userType', '==', 'hospital').get();
                const consentMap = {};
                usersSnap.forEach(doc => {
                    const u = doc.data();
                    if (u.hospitalId) {
                        consentMap[u.hospitalId] = {
                            dataResearchUsage: u.consent?.dataResearchUsage || false,
                            consentDate: u.consent?.consentDate || null
                        };
                    }
                });

                allHospitalStats = [];
                statsSnap.forEach(doc => {
                    const d = doc.data();
                    const hospitalId = doc.id;
                    allHospitalStats.push({
                        hospitalId,
                        hospitalName: d.hospitalName || hospitalId,
                        // ìˆ˜ë‚© ì„±ì¥ë¥ 
                        hasGrowth: !!d.lastGrowthAnalysis,
                        growth: d.lastGrowthAnalysis || null,
                        // ìœ ì§€ìœ¨/ì´íƒˆìœ¨
                        hasRetention: !!d.lastRetentionAnalysis,
                        retention: d.lastRetentionAnalysis || null,
                        // ë™ì˜ ì •ë³´
                        consent: consentMap[hospitalId] || { dataResearchUsage: false },
                        // ìµœì¢… ì—…ë°ì´íŠ¸
                        updatedAt: d.updatedAt
                    });
                });

                renderStatsTable(allHospitalStats);
                updateSummary(allHospitalStats);
                hideLoading();
                console.log(`âœ… ${allHospitalStats.length}ê°œ ë³‘ì› í†µê³„ ë¡œë“œ ì™„ë£Œ`);
            } catch (err) {
                hideLoading();
                console.error('âŒ í†µê³„ ë¡œë“œ ì˜¤ë¥˜:', err);
                showToast('ë°ì´í„° ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + err.message, 'error');
            }
        }

        // ==================== ìš”ì•½ ì¹´ë“œ ì—…ë°ì´íŠ¸ ====================
        function updateSummary(data) {
            document.getElementById('sumAnalyzed').textContent = data.length;

            // í‰ê·  ìœ ì§€ìœ¨
            const retentionVals = data.filter(d => d.hasRetention && d.retention.retentionRate !== 'ì‹ ê·œ')
                .map(d => parseFloat(d.retention.retentionRate));
            if (retentionVals.length > 0) {
                const avg = (retentionVals.reduce((a, b) => a + b, 0) / retentionVals.length).toFixed(1);
                document.getElementById('sumAvgRetention').textContent = avg + '%';
            } else {
                document.getElementById('sumAvgRetention').textContent = '-';
            }

            // í‰ê·  YoY ì„±ì¥ë¥ 
            const growthVals = data.filter(d => d.hasGrowth && d.growth.yoyGrowth !== null)
                .map(d => d.growth.yoyGrowth);
            if (growthVals.length > 0) {
                const avg = (growthVals.reduce((a, b) => a + b, 0) / growthVals.length).toFixed(1);
                document.getElementById('sumAvgGrowth').textContent = (avg > 0 ? '+' : '') + avg + '%';
            } else {
                document.getElementById('sumAvgGrowth').textContent = '-';
            }

            // ì—°êµ¬ ë™ì˜ ìˆ˜
            const consented = data.filter(d => d.consent.dataResearchUsage).length;
            document.getElementById('sumConsented').textContent = consented + 'ê°œ';
        }

        // ==================== í…Œì´ë¸” ë Œë”ë§ ====================
        function renderStatsTable(data) {
            const tbody = document.getElementById('statsTableBody');
            document.getElementById('tableCount').textContent = data.length + 'ê°œ ë³‘ì›';

            if (data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="9"><div class="empty-state"><div class="icon">ğŸ“Š</div><div class="title">ë¶„ì„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div><p>ë³‘ì›ì—ì„œ ë¶„ì„ì„ ì‹¤í–‰í•˜ë©´ ì—¬ê¸°ì— í†µê³„ê°€ í‘œì‹œë©ë‹ˆë‹¤</p></div></td></tr>`;
                return;
            }

            const fmtWon = v => { if (!v && v !== 0) return '-'; if (v >= 1e8) return (v/1e8).toFixed(1)+'ì–µ'; if (v >= 1e4) return (v/1e4).toFixed(0)+'ë§Œ'; return v.toLocaleString(); };

            tbody.innerHTML = data.map((h, idx) => {
                // ìœ ì§€ìœ¨
                let retHtml = '<span class="kpi-badge none">ë¯¸ë¶„ì„</span>';
                if (h.hasRetention) {
                    const r = h.retention.retentionRate;
                    if (r === 'ì‹ ê·œ') retHtml = '<span class="kpi-badge good">ì‹ ê·œ</span>';
                    else {
                        const rv = parseFloat(r);
                        const cls = rv >= 55 ? 'excellent' : rv >= 50 ? 'good' : 'average';
                        retHtml = `<span class="kpi-badge ${cls}">${r}%</span>`;
                    }
                }

                // ì´íƒˆìœ¨
                let churnHtml = '-';
                if (h.hasRetention && h.retention.churnRate !== null) {
                    churnHtml = `<span style="color:#ef4444;font-weight:600;">${h.retention.churnRate}%</span>`;
                }

                // YoY ì„±ì¥ë¥ 
                let growthHtml = '<span class="kpi-badge none">ë¯¸ë¶„ì„</span>';
                if (h.hasGrowth && h.growth.yoyGrowth !== null) {
                    const g = h.growth.yoyGrowth;
                    growthHtml = `<span class="${g >= 0 ? 'trend-up' : 'trend-down'}">${g > 0 ? '+' : ''}${g}%</span>`;
                } else if (h.hasGrowth) {
                    growthHtml = '<span class="trend-neutral">ë¹„êµë¶ˆê°€</span>';
                }

                // ìµœê·¼ ìˆ˜ë‚©
                const sunapHtml = h.hasGrowth ? fmtWon(h.growth.sunap) + 'ì›' : '-';

                // ê°ë‹¨ê°€
                const ppHtml = h.hasGrowth ? fmtWon(h.growth.perPatient) + 'ì›' : '-';

                // ë¹„ê¸‰ì—¬ ë¹„ìœ¨
                const nirHtml = h.hasGrowth ? h.growth.nonInsRatio + '%' : '-';

                // ë™ì˜
                const consentHtml = h.consent.dataResearchUsage
                    ? '<span class="consent-badge yes">âœ… ë™ì˜</span>'
                    : '<span class="consent-badge no">âŒ ë¯¸ë™ì˜</span>';

                return `<tr data-idx="${idx}">
                    <td>
                        <div class="hospital-name-cell">${h.hospitalName}</div>
                        <div class="hospital-id-cell">${h.hospitalId}</div>
                    </td>
                    <td style="text-align:center;">${retHtml}</td>
                    <td style="text-align:center;">${churnHtml}</td>
                    <td style="text-align:center;">${growthHtml}</td>
                    <td style="text-align:center;">${sunapHtml}</td>
                    <td style="text-align:center;">${ppHtml}</td>
                    <td style="text-align:center;">${nirHtml}</td>
                    <td style="text-align:center;">${consentHtml}</td>
                    <td style="text-align:center;">
                        <button class="btn btn-sm btn-primary" onclick="openDetail('${h.hospitalId}')">ìƒì„¸ë³´ê¸°</button>
                    </td>
                </tr>`;
            }).join('');
        }

        // ==================== í•„í„° ====================
        function filterTable() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            const type = document.getElementById('filterType').value;

            const filtered = allHospitalStats.filter(h => {
                // ê²€ìƒ‰ì–´
                if (query && !h.hospitalName.toLowerCase().includes(query) && !h.hospitalId.toLowerCase().includes(query)) return false;
                // í•„í„°
                if (type === 'hasGrowth' && !h.hasGrowth) return false;
                if (type === 'hasRetention' && !h.hasRetention) return false;
                if (type === 'hasBoth' && (!h.hasGrowth || !h.hasRetention)) return false;
                if (type === 'consented' && !h.consent.dataResearchUsage) return false;
                return true;
            });

            renderStatsTable(filtered);
        }

        // ==================== ìƒì„¸ë³´ê¸° ëª¨ë‹¬ ====================
        async function openDetail(hospitalId) {
            currentDetailHospital = allHospitalStats.find(h => h.hospitalId === hospitalId);
            if (!currentDetailHospital) return;

            const h = currentDetailHospital;
            document.getElementById('detailModalTitle').textContent = `ğŸ“Š ${h.hospitalName} ìƒì„¸ í†µê³„`;

            showLoading('ìƒì„¸ ë°ì´í„° ë¡œë”© ì¤‘...');

            try {
                // íˆìŠ¤í† ë¦¬ ë¡œë“œ
                const growthSnap = await db.collection('hospitalStats').doc(hospitalId)
                    .collection('growth').orderBy('analyzedAt', 'desc').limit(1).get();
                const retentionSnap = await db.collection('hospitalStats').doc(hospitalId)
                    .collection('retention').orderBy('analyzedAt', 'desc').limit(1).get();

                let growthDetail = null, retentionDetail = null;
                if (!growthSnap.empty) growthDetail = growthSnap.docs[0].data();
                if (!retentionSnap.empty) retentionDetail = retentionSnap.docs[0].data();

                hideLoading();
                renderDetailModal(h, growthDetail, retentionDetail);
                document.getElementById('detailModal').classList.add('show');
            } catch (err) {
                hideLoading();
                console.error('ìƒì„¸ ë¡œë“œ ì˜¤ë¥˜:', err);
                showToast('ìƒì„¸ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨', 'error');
            }
        }

        function renderDetailModal(h, growthDetail, retentionDetail) {
            const fmtWon = v => { if (!v && v !== 0) return '-'; if (v >= 1e8) return (v/1e8).toFixed(2)+'ì–µ'; if (v >= 1e4) return (v/1e4).toFixed(0)+'ë§Œ'; return v.toLocaleString(); };

            let html = '';

            // KPI ìš”ì•½
            html += '<div class="detail-kpi-grid">';
            if (h.hasRetention) {
                html += `<div class="detail-kpi"><div class="val" style="color:#ec4899;">${h.retention.retentionRate}${h.retention.retentionRate !== 'ì‹ ê·œ' ? '%' : ''}</div><div class="lbl">ìœ ì§€ìœ¨</div></div>`;
                html += `<div class="detail-kpi"><div class="val" style="color:#ef4444;">${h.retention.churnRate !== null ? h.retention.churnRate + '%' : '-'}</div><div class="lbl">ì´íƒˆìœ¨</div></div>`;
                html += `<div class="detail-kpi"><div class="val">${h.retention.totalPatients?.toLocaleString() || '-'}</div><div class="lbl">ì´ í™˜ììˆ˜</div></div>`;
            } else {
                html += '<div class="detail-kpi"><div class="val" style="color:#9ca3af;">-</div><div class="lbl">ìœ ì§€ìœ¨ (ë¯¸ë¶„ì„)</div></div>';
                html += '<div class="detail-kpi"><div class="val" style="color:#9ca3af;">-</div><div class="lbl">ì´íƒˆìœ¨ (ë¯¸ë¶„ì„)</div></div>';
                html += '<div class="detail-kpi"><div class="val" style="color:#9ca3af;">-</div><div class="lbl">ì´ í™˜ììˆ˜ (ë¯¸ë¶„ì„)</div></div>';
            }
            html += '</div>';

            html += '<div class="detail-kpi-grid">';
            if (h.hasGrowth) {
                const g = h.growth;
                html += `<div class="detail-kpi"><div class="val">${fmtWon(g.sunap)}ì›</div><div class="lbl">ìµœê·¼ ìˆ˜ë‚©</div></div>`;
                html += `<div class="detail-kpi"><div class="val" style="color:${g.yoyGrowth >= 0 ? '#10b981' : '#ef4444'};">${g.yoyGrowth !== null ? (g.yoyGrowth > 0 ? '+' : '') + g.yoyGrowth + '%' : '-'}</div><div class="lbl">YoY ì„±ì¥ë¥ </div></div>`;
                html += `<div class="detail-kpi"><div class="val">${fmtWon(g.perPatient)}ì›</div><div class="lbl">ê°ë‹¨ê°€</div></div>`;
            } else {
                html += '<div class="detail-kpi"><div class="val" style="color:#9ca3af;">-</div><div class="lbl">ìˆ˜ë‚© (ë¯¸ë¶„ì„)</div></div>';
                html += '<div class="detail-kpi"><div class="val" style="color:#9ca3af;">-</div><div class="lbl">ì„±ì¥ë¥  (ë¯¸ë¶„ì„)</div></div>';
                html += '<div class="detail-kpi"><div class="val" style="color:#9ca3af;">-</div><div class="lbl">ê°ë‹¨ê°€ (ë¯¸ë¶„ì„)</div></div>';
            }
            html += '</div>';

            // ìœ ì§€ìœ¨ ìƒì„¸ í…Œì´ë¸”
            if (retentionDetail && retentionDetail.yearlySummary) {
                html += `<div class="detail-section-title">ğŸ‘¥ ìœ ì§€ìœ¨ / ì´íƒˆìœ¨ ìƒì„¸ (${retentionDetail.periodStart} ~ ${retentionDetail.periodEnd})</div>`;
                html += '<table class="detail-table"><thead><tr><th>ì—°ë„</th><th>ì´ì›” í™˜ì</th><th>ì‹ ê·œ í™˜ì</th><th>ì´íƒˆ í™˜ì</th><th>ì´ í™˜ììˆ˜</th><th>ìœ ì§€ìœ¨</th></tr></thead><tbody>';
                retentionDetail.yearlySummary.forEach(y => {
                    html += `<tr>
                        <td style="font-weight:600;">${y.year}ë…„</td>
                        <td>${y.retainedFromPrevious.toLocaleString()}ëª…</td>
                        <td style="color:#10b981;">${y.newPatients.toLocaleString()}ëª…</td>
                        <td style="color:#ef4444;">${y.churned.toLocaleString()}ëª…</td>
                        <td style="font-weight:600;">${y.totalPatients.toLocaleString()}ëª…</td>
                        <td style="font-weight:600;color:#ec4899;">${y.retentionRate}${y.retentionRate !== 'ì‹ ê·œ' ? '%' : ''}</td>
                    </tr>`;
                });
                html += '</tbody></table>';
            }

            // ìˆ˜ë‚© ì„±ì¥ë¥  ìƒì„¸ í…Œì´ë¸” (ìµœê·¼ 12ê°œì›”ë§Œ)
            if (growthDetail && growthDetail.monthlySummary) {
                const recent = growthDetail.monthlySummary.slice(-12);
                html += `<div class="detail-section-title">ğŸ’° ìˆ˜ë‚© ì„±ì¥ë¥  ìƒì„¸ (ìµœê·¼ ${recent.length}ê°œì›”)</div>`;
                html += '<table class="detail-table"><thead><tr><th>ì›”</th><th>ìˆ˜ë‚©í•©ê³„</th><th>ë‚´ì›ê±´ìˆ˜</th><th>ê°ë‹¨ê°€</th><th>ë¹„ê¸‰ì—¬ë¹„ìœ¨</th></tr></thead><tbody>';
                recent.forEach(m => {
                    html += `<tr>
                        <td style="font-weight:600;">${m.label}</td>
                        <td>${fmtWon(m.sunap)}ì›</td>
                        <td>${m.patients.toLocaleString()}ê±´</td>
                        <td>${fmtWon(m.perPatient)}ì›</td>
                        <td>${m.nonInsRatio.toFixed(1)}%</td>
                    </tr>`;
                });
                html += '</tbody></table>';
            }

            // ë™ì˜ ì •ë³´
            html += '<div class="detail-section-title">ğŸ“‹ ë°ì´í„° í™œìš© ë™ì˜ ì •ë³´</div>';
            html += `<p style="font-size:13px;color:#374151;">ì—°êµ¬ í™œìš© ë™ì˜: ${h.consent.dataResearchUsage ? '<strong style="color:#10b981;">âœ… ë™ì˜í•¨</strong>' : '<strong style="color:#ef4444;">âŒ ë¯¸ë™ì˜</strong>'}</p>`;
            if (h.consent.consentDate) {
                html += `<p style="font-size:12px;color:#6b7280;margin-top:4px;">ë™ì˜ ì¼ì‹œ: ${new Date(h.consent.consentDate).toLocaleDateString('ko-KR')}</p>`;
            }

            document.getElementById('detailModalBody').innerHTML = html;
        }

        function closeDetailModal() {
            document.getElementById('detailModal').classList.remove('show');
            currentDetailHospital = null;
        }

        // ==================== CSV ë‚´ë³´ë‚´ê¸° (ë…¼ë¬¸ìš©) ====================
        function exportAllCSV() {
            // ì—°êµ¬ ë™ì˜í•œ ë³‘ì›ë§Œ ë‚´ë³´ë‚´ê¸°
            const consented = allHospitalStats.filter(h => h.consent.dataResearchUsage);
            if (consented.length === 0) {
                showToast('ì—°êµ¬ í™œìš©ì— ë™ì˜í•œ ë³‘ì›ì´ ì—†ìŠµë‹ˆë‹¤.', 'error');
                return;
            }

            // ë³‘ì›ëª… ìµëª…í™” (Aë³‘ì›, Bë³‘ì›, ...)
            const anonymize = (idx) => String.fromCharCode(65 + idx) + 'ë³‘ì›';

            let csv = 'BOM\n';  // UTF-8 BOM
            csv = '\uFEFF';

            // ìš”ì•½ í…Œì´ë¸”
            csv += '=== ë³‘ì›ë³„ ë¶„ì„ ìš”ì•½ (ìµëª…í™”) ===\n';
            csv += 'ì‹ë³„ì½”ë“œ,ìœ ì§€ìœ¨(%),ì´íƒˆìœ¨(%),YoYì„±ì¥ë¥ (%),ìµœê·¼ìˆ˜ë‚©(ì›),ê°ë‹¨ê°€(ì›),ë¹„ê¸‰ì—¬ë¹„ìœ¨(%)\n';
            consented.forEach((h, i) => {
                const ret = h.hasRetention ? h.retention.retentionRate : '';
                const churn = h.hasRetention && h.retention.churnRate !== null ? h.retention.churnRate : '';
                const yoy = h.hasGrowth && h.growth.yoyGrowth !== null ? h.growth.yoyGrowth : '';
                const sunap = h.hasGrowth ? h.growth.sunap : '';
                const pp = h.hasGrowth ? h.growth.perPatient : '';
                const nir = h.hasGrowth ? h.growth.nonInsRatio : '';
                csv += `${anonymize(i)},${ret},${churn},${yoy},${sunap},${pp},${nir}\n`;
            });

            csv += '\n=== ë©”íƒ€ë°ì´í„° ===\n';
            csv += `ë‚´ë³´ë‚´ê¸° ì¼ì‹œ,${new Date().toISOString()}\n`;
            csv += `ëŒ€ìƒ ë³‘ì› ìˆ˜,${consented.length}\n`;
            csv += `ë°ì´í„° ìœ í˜•,ê°œì¸ì‹ë³„ ë¶ˆê°€ëŠ¥í•œ ì§‘ê³„ í†µê³„\n`;
            csv += `ë³‘ì›ëª… ì²˜ë¦¬,ìµëª…í™” (Aë³‘ì› Bë³‘ì› ë“±)\n`;
            csv += `í™œìš© ë²”ìœ„,í•™ìˆ  ì—°êµ¬ ë° ë¹„ì˜ë¦¬ ëª©ì \n`;

            downloadCSV(csv, `apsencare_research_data_${new Date().toISOString().slice(0,10)}.csv`);
            showToast(`âœ… ${consented.length}ê°œ ë³‘ì› ë°ì´í„° ë‚´ë³´ë‚´ê¸° ì™„ë£Œ (ìµëª…í™”)`, 'success');
        }

        async function exportSingleCSV() {
            if (!currentDetailHospital) return;
            const h = currentDetailHospital;

            if (!h.consent.dataResearchUsage) {
                showToast('ì´ ë³‘ì›ì€ ì—°êµ¬ í™œìš©ì— ë™ì˜í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.', 'error');
                return;
            }

            // ìƒì„¸ ë°ì´í„° ë¡œë“œ
            showLoading('ë°ì´í„° ì¤€ë¹„ ì¤‘...');
            try {
                const growthSnap = await db.collection('hospitalStats').doc(h.hospitalId)
                    .collection('growth').orderBy('analyzedAt', 'desc').limit(1).get();
                const retentionSnap = await db.collection('hospitalStats').doc(h.hospitalId)
                    .collection('retention').orderBy('analyzedAt', 'desc').limit(1).get();

                let csv = '\uFEFF';
                const anonName = 'ìµëª…ë³‘ì›';

                // ìœ ì§€ìœ¨ ë°ì´í„°
                if (!retentionSnap.empty) {
                    const rd = retentionSnap.docs[0].data();
                    csv += `=== ${anonName} ìœ ì§€ìœ¨/ì´íƒˆìœ¨ (${rd.periodStart}~${rd.periodEnd}) ===\n`;
                    csv += 'ì—°ë„,ì´ì›”í™˜ì(ëª…),ì‹ ê·œí™˜ì(ëª…),ì´íƒˆí™˜ì(ëª…),ì´í™˜ììˆ˜(ëª…),ìœ ì§€ìœ¨(%)\n';
                    if (rd.yearlySummary) {
                        rd.yearlySummary.forEach(y => {
                            csv += `${y.year},${y.retainedFromPrevious},${y.newPatients},${y.churned},${y.totalPatients},${y.retentionRate}\n`;
                        });
                    }
                    csv += '\n';
                }

                // ìˆ˜ë‚© ì„±ì¥ë¥  ë°ì´í„°
                if (!growthSnap.empty) {
                    const gd = growthSnap.docs[0].data();
                    csv += `=== ${anonName} ìˆ˜ë‚© ì„±ì¥ë¥  (${gd.periodStart}~${gd.periodEnd}) ===\n`;
                    csv += 'ì—°ì›”,ìˆ˜ë‚©í•©ê³„(ì›),ë‚´ì›ê±´ìˆ˜,ê°ë‹¨ê°€(ì›),ë¹„ê¸‰ì—¬ë¹„ìœ¨(%),ë³¸ì¸ë¶€ë‹´ê¸ˆ(ì›),ê³µë‹¨ë¶€ë‹´ê¸ˆ(ì›),ë¹„ê¸‰ì—¬(ì›),ì´ì§„ë£Œë¹„(ì›)\n';
                    if (gd.monthlySummary) {
                        gd.monthlySummary.forEach(m => {
                            csv += `${m.label},${m.sunap},${m.patients},${m.perPatient},${m.nonInsRatio},${m.copay},${m.nhis},${m.nonIns},${m.totalFee}\n`;
                        });
                    }
                }

                csv += `\n=== ë©”íƒ€ë°ì´í„° ===\n`;
                csv += `ë‚´ë³´ë‚´ê¸° ì¼ì‹œ,${new Date().toISOString()}\n`;
                csv += `ë³‘ì›ëª… ì²˜ë¦¬,ìµëª…í™”\n`;

                hideLoading();
                downloadCSV(csv, `apsencare_hospital_data_${new Date().toISOString().slice(0,10)}.csv`);
                showToast('âœ… CSV ë‚´ë³´ë‚´ê¸° ì™„ë£Œ (ìµëª…í™”)', 'success');
            } catch (err) {
                hideLoading();
                showToast('ë‚´ë³´ë‚´ê¸° ì‹¤íŒ¨: ' + err.message, 'error');
            }
        }

        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
            URL.revokeObjectURL(link.href);
        }

        // ==================== ìœ í‹¸ë¦¬í‹° ====================
        function showLoading(text) { document.getElementById('loadingText').textContent = text; document.getElementById('loadingOverlay').classList.add('show'); }
        function hideLoading() { document.getElementById('loadingOverlay').classList.remove('show'); }
        function showToast(msg, type) { const t = document.getElementById('toast'); t.textContent = msg; t.className = 'toast ' + type + ' show'; setTimeout(() => t.classList.remove('show'), 3500); }
    </script>
</body>
</html>
