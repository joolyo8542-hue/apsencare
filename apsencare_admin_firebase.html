<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¦· ì•ì„ ì¼€ì–´ - ê´€ë¦¬ì</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
            background: #f9fafb;
            color: #1a1a1a;
            line-height: 1.6;
            font-size: 14px;
        }

        .app-layout { display: flex; min-height: 100vh; }

        /* ===== ì‚¬ì´ë“œë°” ===== */
        .sidebar {
            width: 260px;
            background: #1f2937;
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100vh;
            z-index: 100;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #374151;
        }

        .logo { display: flex; align-items: center; gap: 12px; }

        .logo-icon {
            width: 40px; height: 40px;
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            font-size: 18px;
        }

        .logo-text { font-size: 18px; font-weight: 700; color: white; }
        .logo-sub { font-size: 11px; color: #9ca3af; }

        .nav-section { flex: 1; padding: 12px 0; overflow-y: auto; }

        .nav-group-title {
            padding: 12px 20px 8px;
            font-size: 11px; font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .nav-item {
            display: flex; align-items: center; gap: 12px;
            padding: 12px 20px;
            color: #9ca3af;
            text-decoration: none;
            transition: all 0.2s;
            cursor: pointer;
            border-left: 3px solid transparent;
        }

        .nav-item:hover { background: #374151; color: #fbbf24; }

        .nav-item.active {
            background: #374151;
            color: #fbbf24;
            border-left-color: #fbbf24;
            font-weight: 600;
        }

        .nav-icon { width: 20px; text-align: center; font-size: 16px; }
        .nav-label { flex: 1; }

        .nav-badge {
            background: #6b7280; color: white;
            font-size: 10px; padding: 2px 8px;
            border-radius: 10px; font-weight: 600;
        }

        .nav-badge.alert { background: #ef4444; }

        .nav-divider { height: 1px; background: #374151; margin: 12px 20px; }

        .sidebar-footer {
            padding: 16px 20px;
            border-top: 1px solid #374151;
            background: #111827;
        }

        .user-card { display: flex; align-items: center; gap: 12px; }

        .user-avatar {
            width: 36px; height: 36px;
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            color: white; font-size: 14px; font-weight: 600;
        }

        .user-info { flex: 1; }
        .user-name { font-size: 13px; font-weight: 600; color: white; }
        .user-role { font-size: 11px; color: #9ca3af; }

        .logout-btn {
            background: none; border: none; color: #6b7280;
            cursor: pointer; padding: 6px; border-radius: 6px;
            transition: all 0.2s; font-size: 14px;
        }

        .logout-btn:hover { background: #374151; color: #ef4444; }

        /* ===== ë©”ì¸ ì½˜í…ì¸  ===== */
        .main-content { flex: 1; margin-left: 260px; }

        .top-header {
            background: white;
            border-bottom: 1px solid #e5e7eb;
            padding: 16px 32px;
            display: flex; justify-content: space-between; align-items: center;
            position: sticky; top: 0; z-index: 50;
        }

        .page-title h1 { font-size: 20px; font-weight: 700; color: #1f2937; }
        .page-title p { font-size: 13px; color: #6b7280; margin-top: 2px; }

        .header-actions { display: flex; gap: 12px; }

        .btn {
            padding: 10px 18px; border-radius: 8px;
            font-size: 13px; font-weight: 600;
            cursor: pointer; transition: all 0.2s;
            display: flex; align-items: center; gap: 8px; border: none;
        }

        .btn-warning {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: white;
        }

        .btn-warning:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(251, 191, 36, 0.3);
        }

        .btn-secondary { background: #f3f4f6; color: #4b5563; }
        .btn-secondary:hover { background: #e5e7eb; }

        .btn-danger { background: #fee2e2; color: #dc2626; }
        .btn-danger:hover { background: #fecaca; }

        .content-area { padding: 32px; }

        /* íƒ­ ì½˜í…ì¸  í‘œì‹œ/ìˆ¨ê¹€ */
        .tab-page { display: none; }
        .tab-page.active { display: block; }

        /* ===== í†µê³„ ì¹´ë“œ ===== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px; margin-bottom: 24px;
        }

        .stat-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .stat-card:hover {
            border-color: #fbbf24;
            box-shadow: 0 4px 12px rgba(251, 191, 36, 0.1);
        }

        .stat-card .stat-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 12px;
        }

        .stat-icon {
            width: 44px; height: 44px; border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            font-size: 20px;
        }

        .stat-icon.yellow { background: #fef3c7; }
        .stat-icon.green { background: #dcfce7; }
        .stat-icon.blue { background: #dbeafe; }
        .stat-icon.pink { background: #fce7f3; }

        .stat-value { font-size: 32px; font-weight: 700; color: #1f2937; }
        .stat-label { font-size: 13px; color: #6b7280; margin-top: 4px; }

        .stat-link {
            font-size: 11px; color: #f59e0b; margin-top: 8px;
            display: flex; align-items: center; gap: 4px;
        }

        /* ===== ì¹´ë“œ ===== */
        .card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 24px;
        }

        .card-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 16px; font-weight: 700; color: #1f2937;
            display: flex; align-items: center; gap: 8px;
        }

        .card-link {
            font-size: 12px; color: #f59e0b;
            text-decoration: none; font-weight: 600;
            cursor: pointer;
        }

        .card-link:hover { text-decoration: underline; }

        /* ===== ì „ì²´í˜„í™© - ê°„ëµ ë¯¸ë‹ˆ ë¦¬ìŠ¤íŠ¸ ===== */
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px; margin-bottom: 24px;
        }

        .mini-list-item {
            display: flex; align-items: center; gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid #f3f4f6;
        }

        .mini-list-item:last-child { border-bottom: none; }

        .mini-list-icon {
            width: 36px; height: 36px;
            background: #f3f4f6; border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            font-size: 16px; flex-shrink: 0;
        }

        .mini-list-info { flex: 1; min-width: 0; }

        .mini-list-name {
            font-size: 13px; font-weight: 600; color: #1f2937;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }

        .mini-list-sub {
            font-size: 11px; color: #9ca3af; margin-top: 1px;
        }

        .mini-list-badge {
            padding: 3px 10px; border-radius: 12px;
            font-size: 11px; font-weight: 600; white-space: nowrap;
        }

        .mini-list-badge.active { background: #dcfce7; color: #16a34a; }
        .mini-list-badge.pending { background: #fef3c7; color: #92400e; }
        .mini-list-badge.used { background: #dcfce7; color: #166534; }

        .empty-state {
            text-align: center; color: #9ca3af; padding: 40px 20px; font-size: 13px;
        }

        /* ===== ë³‘ì› ëª©ë¡ íƒ­ ===== */
        .tab-toolbar {
            display: flex; align-items: center; gap: 12px;
            margin-bottom: 20px; flex-wrap: wrap;
        }

        .tab-search {
            flex: 1; min-width: 200px;
            padding: 10px 14px 10px 36px;
            border: 2px solid #e5e7eb; border-radius: 10px;
            font-size: 13px; font-family: inherit;
            transition: border-color 0.2s;
            background: white url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%239ca3af' viewBox='0 0 16 16'%3E%3Cpath d='M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85zm-5.442.156a5 5 0 1 1 0-10 5 5 0 0 1 0 10z'/%3E%3C/svg%3E") no-repeat 12px center;
        }

        .tab-search:focus { outline: none; border-color: #fbbf24; }

        .filter-chips { display: flex; gap: 8px; flex-wrap: wrap; }

        .filter-chip {
            padding: 7px 16px; border-radius: 20px;
            font-size: 12px; font-weight: 600;
            cursor: pointer; border: 1.5px solid #e5e7eb;
            background: white; color: #6b7280;
            transition: all 0.2s;
        }

        .filter-chip:hover { border-color: #fbbf24; color: #b45309; }

        .filter-chip.active {
            background: #fef3c7; border-color: #fbbf24; color: #92400e;
        }

        .filter-chip .chip-count {
            font-size: 10px; background: #e5e7eb; color: #6b7280;
            padding: 1px 6px; border-radius: 8px; margin-left: 4px;
        }

        .filter-chip.active .chip-count {
            background: #fbbf24; color: white;
        }

        /* ===== í…Œì´ë¸” ê³µí†µ ===== */
        .table-wrap {
            border: 1px solid #e5e7eb; border-radius: 12px;
            overflow: hidden;
        }

        .table-scroll {
            max-height: 600px; overflow-y: auto;
        }

        .table-scroll::-webkit-scrollbar { width: 6px; }
        .table-scroll::-webkit-scrollbar-track { background: #f9fafb; }
        .table-scroll::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 3px; }

        .data-table { width: 100%; border-collapse: collapse; }

        .data-table thead { position: sticky; top: 0; z-index: 5; }

        .data-table th {
            padding: 12px 16px;
            background: #f9fafb; color: #374151;
            font-size: 12px; font-weight: 600;
            text-align: left;
            border-bottom: 2px solid #e5e7eb;
            white-space: nowrap;
        }

        .data-table td {
            padding: 14px 16px;
            font-size: 13px; color: #1f2937;
            border-bottom: 1px solid #f3f4f6;
            vertical-align: middle;
        }

        .data-table tr:hover { background: #fefce8; }
        .data-table tr:last-child td { border-bottom: none; }

        .hospital-name { font-weight: 600; color: #1f2937; }
        .hospital-sub { font-size: 11px; color: #9ca3af; margin-top: 2px; }

        .status-badge {
            display: inline-flex; align-items: center; gap: 4px;
            padding: 4px 10px; border-radius: 12px;
            font-size: 11px; font-weight: 600; white-space: nowrap;
        }

        .status-badge.active { background: #dcfce7; color: #16a34a; }
        .status-badge.pending { background: #fef3c7; color: #b45309; }
        .status-badge.inactive { background: #fee2e2; color: #dc2626; }

        .code-cell {
            font-family: 'SF Mono', Monaco, 'Courier New', monospace;
            font-size: 13px; font-weight: 700;
            letter-spacing: 1.5px; color: #78350f;
        }

        .used-row .code-cell {
            color: #166534; text-decoration: line-through; opacity: 0.7;
        }

        /* í–‰ ì•¡ì…˜ ë²„íŠ¼ */
        .row-actions { display: flex; gap: 6px; }

        .row-btn {
            padding: 6px 10px; border-radius: 6px;
            font-size: 11px; font-weight: 600;
            cursor: pointer; border: none;
            transition: all 0.15s; white-space: nowrap;
        }

        .row-btn.view { background: #eff6ff; color: #2563eb; }
        .row-btn.view:hover { background: #dbeafe; }
        .row-btn.edit { background: #fef3c7; color: #92400e; }
        .row-btn.edit:hover { background: #fde68a; }
        .row-btn.copy { background: #f3f4f6; color: #374151; }
        .row-btn.copy:hover { background: #e5e7eb; }
        .row-btn.toggle { background: #fee2e2; color: #dc2626; }
        .row-btn.toggle:hover { background: #fecaca; }
        .row-btn.reactivate { background: #dcfce7; color: #16a34a; }
        .row-btn.reactivate:hover { background: #bbf7d0; }
        .row-btn.delete { background: #fee2e2; color: #dc2626; }
        .row-btn.delete:hover { background: #fecaca; }

        /* í…Œì´ë¸” ë¹ˆ ìƒíƒœ */
        .table-empty {
            text-align: center; color: #9ca3af;
            padding: 60px 20px; font-size: 14px;
        }

        .table-empty .empty-icon { font-size: 40px; margin-bottom: 12px; }

        /* í…Œì´ë¸” footer */
        .table-footer {
            padding: 12px 16px;
            background: #f9fafb;
            border-top: 1px solid #e5e7eb;
            display: flex; justify-content: space-between; align-items: center;
            font-size: 12px; color: #6b7280;
        }

        /* ===== ìµœê·¼ í™œë™ ===== */
        .activity-item {
            display: flex; align-items: flex-start; gap: 12px;
            padding: 14px 0;
            border-bottom: 1px solid #f3f4f6;
        }

        .activity-item:last-child { border-bottom: none; }

        .activity-icon {
            width: 36px; height: 36px;
            background: #f3f4f6; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 14px; flex-shrink: 0;
        }

        .activity-content { flex: 1; }

        .activity-text { font-size: 13px; color: #1f2937; }
        .activity-text strong { font-weight: 600; color: #f59e0b; }
        .activity-time { font-size: 11px; color: #9ca3af; margin-top: 2px; }

        /* ===== ë³‘ì› ìƒì„¸ íŒ¨ë„ ===== */
        .detail-panel {
            display: none;
            position: fixed;
            top: 0; right: 0;
            width: 420px; height: 100vh;
            background: white;
            box-shadow: -8px 0 30px rgba(0,0,0,0.1);
            z-index: 200;
            animation: slideIn 0.3s ease;
            overflow-y: auto;
        }

        .detail-panel.active { display: block; }

        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }

        .detail-panel-header {
            padding: 20px 24px;
            border-bottom: 1px solid #e5e7eb;
            display: flex; justify-content: space-between; align-items: center;
            position: sticky; top: 0; background: white; z-index: 5;
        }

        .detail-panel-header h3 {
            font-size: 16px; font-weight: 700; color: #1f2937;
        }

        .detail-close-btn {
            background: #f3f4f6; border: none; width: 32px; height: 32px;
            border-radius: 8px; cursor: pointer; font-size: 16px;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.2s;
        }

        .detail-close-btn:hover { background: #e5e7eb; }

        .detail-panel-body { padding: 24px; }

        .detail-field { margin-bottom: 16px; }
        .detail-field label {
            display: block; font-size: 11px; font-weight: 600;
            color: #6b7280; text-transform: uppercase;
            letter-spacing: 0.5px; margin-bottom: 4px;
        }
        .detail-field .value {
            font-size: 14px; font-weight: 500; color: #1f2937;
        }

        .detail-divider {
            height: 1px; background: #e5e7eb; margin: 20px 0;
        }

        .detail-section-title {
            font-size: 13px; font-weight: 700; color: #1f2937;
            margin-bottom: 12px;
            display: flex; align-items: center; gap: 6px;
        }

        .detail-user-item {
            display: flex; align-items: center; gap: 10px;
            padding: 10px 12px; background: #f9fafb;
            border-radius: 8px; margin-bottom: 8px;
        }

        .detail-user-item .user-icon {
            width: 32px; height: 32px; border-radius: 50%;
            background: #dbeafe; display: flex; align-items: center; justify-content: center;
            font-size: 12px;
        }

        .detail-user-info { flex: 1; }
        .detail-user-name { font-size: 13px; font-weight: 600; }
        .detail-user-email { font-size: 11px; color: #6b7280; }

        /* ===== ëª¨ë‹¬ ===== */
        .modal-overlay {
            display: none; position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center; align-items: center;
        }

        .modal-overlay.active { display: flex; }

        .modal {
            background: white; border-radius: 16px;
            padding: 32px; width: 90%; max-width: 480px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: modalIn 0.3s ease;
        }

        @keyframes modalIn {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .modal-title {
            font-size: 18px; font-weight: 700; margin-bottom: 24px;
            display: flex; align-items: center; gap: 8px;
        }

        .modal-field { margin-bottom: 16px; }

        .modal-field label {
            display: block; font-size: 13px; font-weight: 600;
            color: #374151; margin-bottom: 6px;
        }

        .modal-field input, .modal-field select {
            width: 100%; padding: 12px 14px;
            border: 2px solid #e5e7eb; border-radius: 10px;
            font-size: 14px; font-family: inherit;
            transition: border-color 0.2s;
        }

        .modal-field input:focus, .modal-field select:focus {
            outline: none; border-color: #f59e0b;
        }

        .modal-code-preview {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            border: 2px solid #fbbf24;
            border-radius: 12px; padding: 16px;
            text-align: center; margin-bottom: 20px;
        }

        .modal-code-preview .code-text {
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 24px; font-weight: 700;
            color: #78350f; letter-spacing: 3px;
        }

        .modal-code-preview .code-hint {
            font-size: 11px; color: #92400e; margin-top: 6px;
        }

        .modal-buttons { display: flex; gap: 10px; margin-top: 24px; }

        .modal-buttons button {
            flex: 1; padding: 12px; border-radius: 10px;
            font-size: 14px; font-weight: 600;
            cursor: pointer; transition: all 0.2s;
        }

        .btn-cancel { background: #f3f4f6; border: 1px solid #e5e7eb; color: #374151; }
        .btn-cancel:hover { background: #e5e7eb; }
        .btn-create { background: linear-gradient(135deg, #f59e0b, #d97706); border: none; color: white; }
        .btn-create:hover { background: linear-gradient(135deg, #d97706, #b45309); }
        .btn-create:disabled { opacity: 0.5; cursor: not-allowed; }

        /* ===== í† ìŠ¤íŠ¸ ===== */
        .toast {
            position: fixed; bottom: 30px; right: 30px;
            padding: 14px 24px; border-radius: 12px;
            font-size: 13px; font-weight: 600; z-index: 2000;
            transform: translateY(100px); opacity: 0;
            transition: all 0.3s;
        }

        .toast.show { transform: translateY(0); opacity: 1; }
        .toast.success { background: #dcfce7; color: #166534; border: 1px solid #22c55e; }
        .toast.error { background: #fee2e2; color: #991b1b; border: 1px solid #ef4444; }

        /* ===== ë°˜ì‘í˜• ===== */
        @media (max-width: 1200px) {
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .grid-2 { grid-template-columns: 1fr; }
        }

        @media (max-width: 768px) {
            .sidebar { width: 60px; }
            .logo-text, .logo-sub, .nav-label, .nav-badge, .nav-group-title, .user-info { display: none; }
            .nav-item { justify-content: center; padding: 14px; }
            .main-content { margin-left: 60px; }
            .content-area { padding: 20px; }
            .stats-grid { grid-template-columns: 1fr; }
            .detail-panel { width: 100%; }
        }
    </style>
</head>
<body>
    <div class="app-layout">
        <!-- ì‚¬ì´ë“œë°” -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <div class="logo-icon">ğŸ‘‘</div>
                    <div>
                        <div class="logo-text">ì•ì„ ì¼€ì–´</div>
                        <div class="logo-sub">Admin Console</div>
                    </div>
                </div>
            </div>

            <nav class="nav-section">
                <div class="nav-group-title">ëŒ€ì‹œë³´ë“œ</div>
                <a class="nav-item active" onclick="switchTab('overview')" data-tab="overview">
                    <span class="nav-icon">ğŸ“Š</span>
                    <span class="nav-label">ì „ì²´ í˜„í™©</span>
                </a>

                <div class="nav-divider"></div>

                <div class="nav-group-title">ë³‘ì› ê´€ë¦¬</div>
                <a class="nav-item" onclick="switchTab('hospitals')" data-tab="hospitals">
                    <span class="nav-icon">ğŸ¥</span>
                    <span class="nav-label">ë³‘ì› ëª©ë¡</span>
                    <span class="nav-badge" id="hospitalCountBadge">-</span>
                </a>
                <a class="nav-item" onclick="switchTab('invites')" data-tab="invites">
                    <span class="nav-icon">ğŸ«</span>
                    <span class="nav-label">ì´ˆëŒ€ì½”ë“œ</span>
                    <span class="nav-badge alert" id="inviteCountBadge">-</span>
                </a>

                <div class="nav-divider"></div>

                <div class="nav-group-title">ì½˜í…ì¸  ê´€ë¦¬</div>
                <a class="nav-item" href="apsencare_admin_data.html">
                    <span class="nav-icon">ğŸ“</span>
                    <span class="nav-label">ìë£Œ ê´€ë¦¬</span>
                </a>
                <a class="nav-item" href="#">
                    <span class="nav-icon">ğŸ“¢</span>
                    <span class="nav-label">ê³µì§€ì‚¬í•­</span>
                </a>
                <a class="nav-item" href="#">
                    <span class="nav-icon">ğŸ“</span>
                    <span class="nav-label">êµìœ¡ ê´€ë¦¬</span>
                </a>

                <div class="nav-divider"></div>

                <div class="nav-group-title">ì‹œìŠ¤í…œ</div>
                <a class="nav-item" href="#">
                    <span class="nav-icon">ğŸ“ˆ</span>
                    <span class="nav-label">ì „ì²´ í†µê³„</span>
                </a>
                <a class="nav-item" href="#">
                    <span class="nav-icon">âš™ï¸</span>
                    <span class="nav-label">ì„¤ì •</span>
                </a>
            </nav>

            <div class="sidebar-footer">
                <div class="user-card">
                    <div class="user-avatar" id="userAvatar">-</div>
                    <div class="user-info">
                        <div class="user-name" id="userName">ë¡œë”© ì¤‘...</div>
                        <div class="user-role">Super Admin</div>
                    </div>
                    <button class="logout-btn" title="ë¡œê·¸ì•„ì›ƒ" onclick="handleLogout()">ğŸšª</button>
                </div>
            </div>
        </aside>

        <!-- ë©”ì¸ ì½˜í…ì¸  -->
        <main class="main-content">
            <!-- ========== íƒ­1: ì „ì²´ í˜„í™© ========== -->
            <div class="tab-page active" id="tab-overview">
                <header class="top-header">
                    <div class="page-title">
                        <h1>ì „ì²´ í˜„í™©</h1>
                        <p>ì•ì„ ì¼€ì–´ í”Œë«í¼ ìš”ì•½ ëŒ€ì‹œë³´ë“œ</p>
                    </div>
                    <div class="header-actions">
                        <button class="btn btn-secondary" onclick="loadDashboardData()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
                        <button class="btn btn-warning" onclick="openCreateModal()">â• ìƒˆ ë³‘ì› ì´ˆëŒ€</button>
                    </div>
                </header>

                <div class="content-area">
                    <!-- í†µê³„ ì¹´ë“œ -->
                    <div class="stats-grid">
                        <div class="stat-card" onclick="switchTab('hospitals')">
                            <div class="stat-header">
                                <div class="stat-icon yellow">ğŸ¥</div>
                            </div>
                            <div class="stat-value" id="statHospitals">-</div>
                            <div class="stat-label">ë“±ë¡ ë³‘ì›</div>
                            <div class="stat-link">ë³‘ì› ëª©ë¡ ë³´ê¸° â†’</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-icon green">ğŸ‘¤</div>
                            </div>
                            <div class="stat-value" id="statUsers">-</div>
                            <div class="stat-label">ì „ì²´ ì‚¬ìš©ì</div>
                        </div>
                        <div class="stat-card" onclick="switchTab('invites')">
                            <div class="stat-header">
                                <div class="stat-icon blue">ğŸ«</div>
                            </div>
                            <div class="stat-value" id="statPendingInvites">-</div>
                            <div class="stat-label">ëŒ€ê¸° ì¤‘ ì´ˆëŒ€</div>
                            <div class="stat-link">ì´ˆëŒ€ì½”ë“œ ê´€ë¦¬ â†’</div>
                        </div>
                        <div class="stat-card" onclick="switchTab('invites')">
                            <div class="stat-header">
                                <div class="stat-icon pink">âœ…</div>
                            </div>
                            <div class="stat-value" id="statUsedInvites">-</div>
                            <div class="stat-label">ì‚¬ìš©ëœ ì´ˆëŒ€</div>
                            <div class="stat-link">ì´ˆëŒ€ì½”ë“œ ê´€ë¦¬ â†’</div>
                        </div>
                    </div>

                    <!-- ê°„ëµ ë¯¸ë‹ˆ ë¦¬ìŠ¤íŠ¸ -->
                    <div class="grid-2">
                        <!-- ìµœê·¼ ë“±ë¡ ë³‘ì› (ê°„ëµ) -->
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">ğŸ¥ ìµœê·¼ ë“±ë¡ ë³‘ì›</h3>
                                <span class="card-link" onclick="switchTab('hospitals')">ì „ì²´ ë³´ê¸° â†’</span>
                            </div>
                            <div id="overviewHospitalList">
                                <div class="empty-state">ë¡œë”© ì¤‘...</div>
                            </div>
                        </div>

                        <!-- ìµœê·¼ ì´ˆëŒ€ì½”ë“œ (ê°„ëµ) -->
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">ğŸ« ìµœê·¼ ì´ˆëŒ€ì½”ë“œ</h3>
                                <span class="card-link" onclick="switchTab('invites')">ì „ì²´ ë³´ê¸° â†’</span>
                            </div>
                            <div id="overviewInviteList">
                                <div class="empty-state">ë¡œë”© ì¤‘...</div>
                            </div>
                        </div>
                    </div>

                    <!-- ìµœê·¼ ê°€ì… ì‚¬ìš©ì -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">ğŸ‘¤ ìµœê·¼ ê°€ì… ì‚¬ìš©ì</h3>
                        </div>
                        <div id="recentUsersList">
                            <div class="empty-state">ë¡œë”© ì¤‘...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ========== íƒ­2: ë³‘ì› ëª©ë¡ ========== -->
            <div class="tab-page" id="tab-hospitals">
                <header class="top-header">
                    <div class="page-title">
                        <h1>ë³‘ì› ëª©ë¡</h1>
                        <p>ë“±ë¡ëœ ë³‘ì› ê´€ë¦¬ ë° ìƒì„¸ ì •ë³´</p>
                    </div>
                    <div class="header-actions">
                        <button class="btn btn-secondary" onclick="exportHospitalData()">ğŸ“¥ ë‚´ë³´ë‚´ê¸°</button>
                        <button class="btn btn-warning" onclick="openCreateModal()">â• ìƒˆ ë³‘ì› ì´ˆëŒ€</button>
                    </div>
                </header>

                <div class="content-area">
                    <!-- ê²€ìƒ‰ & í•„í„° -->
                    <div class="tab-toolbar">
                        <input type="text" class="tab-search" placeholder="ë³‘ì›ëª…, ì´ë©”ì¼ ê²€ìƒ‰..." oninput="searchHospitals(this.value)" id="hospitalSearch">
                        <div class="filter-chips">
                            <button class="filter-chip active" onclick="filterHospitals('all')" id="hFilterAll">ì „ì²´<span class="chip-count" id="hCountAll">0</span></button>
                            <button class="filter-chip" onclick="filterHospitals('active')" id="hFilterActive">âœ… ê°€ì…ì™„ë£Œ<span class="chip-count" id="hCountActive">0</span></button>
                            <button class="filter-chip" onclick="filterHospitals('pending')" id="hFilterPending">â³ ë¯¸ê°€ì…<span class="chip-count" id="hCountPending">0</span></button>
                        </div>
                    </div>

                    <!-- ë³‘ì› í…Œì´ë¸” -->
                    <div class="table-wrap">
                        <div class="table-scroll">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>ë³‘ì›ëª…</th>
                                        <th>ì´ë©”ì¼ / ê³„ì •</th>
                                        <th>ì˜ˆë°©ê³¼ ë„ì…ì‹œê¸°</th>
                                        <th>ìƒíƒœ</th>
                                        <th>ë“±ë¡ì¼</th>
                                        <th>ê´€ë¦¬</th>
                                    </tr>
                                </thead>
                                <tbody id="hospitalTableBody">
                                    <tr><td colspan="6" class="table-empty"><div class="empty-icon">ğŸ¥</div>ë¡œë”© ì¤‘...</td></tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="table-footer">
                            <span id="hospitalResultCount">0ê°œ ë³‘ì›</span>
                            <span id="hospitalResultInfo"></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ========== íƒ­3: ì´ˆëŒ€ì½”ë“œ ========== -->
            <div class="tab-page" id="tab-invites">
                <header class="top-header">
                    <div class="page-title">
                        <h1>ì´ˆëŒ€ì½”ë“œ ê´€ë¦¬</h1>
                        <p>ì´ˆëŒ€ì½”ë“œ ìƒì„±, ìƒíƒœ ê´€ë¦¬ ë° ì¶”ì </p>
                    </div>
                    <div class="header-actions">
                        <button class="btn btn-secondary" onclick="exportInviteData()">ğŸ“¥ ë‚´ë³´ë‚´ê¸°</button>
                        <button class="btn btn-warning" onclick="openCreateModal()">â• ìƒˆ ì´ˆëŒ€ì½”ë“œ</button>
                    </div>
                </header>

                <div class="content-area">
                    <!-- ì´ˆëŒ€ì½”ë“œ ìš”ì•½ ì¹´ë“œ -->
                    <div class="stats-grid" style="grid-template-columns: repeat(3, 1fr); margin-bottom: 24px;">
                        <div class="stat-card">
                            <div class="stat-header"><div class="stat-icon blue">ğŸ«</div></div>
                            <div class="stat-value" id="invStatTotal">-</div>
                            <div class="stat-label">ì „ì²´ ì´ˆëŒ€ì½”ë“œ</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-header"><div class="stat-icon yellow">â³</div></div>
                            <div class="stat-value" id="invStatPending">-</div>
                            <div class="stat-label">ëŒ€ê¸° ì¤‘</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-header"><div class="stat-icon green">âœ…</div></div>
                            <div class="stat-value" id="invStatUsed">-</div>
                            <div class="stat-label">ì‚¬ìš©ë¨</div>
                        </div>
                    </div>

                    <!-- ê²€ìƒ‰ & í•„í„° -->
                    <div class="tab-toolbar">
                        <input type="text" class="tab-search" placeholder="ë³‘ì›ëª…, ì½”ë“œ, ì‚¬ìš©ì ê²€ìƒ‰..." oninput="searchInvites(this.value)" id="inviteSearch">
                        <div class="filter-chips">
                            <button class="filter-chip active" onclick="filterInvites('all')" id="filterAll">ì „ì²´<span class="chip-count" id="countAll">0</span></button>
                            <button class="filter-chip" onclick="filterInvites('pending')" id="filterPending">â³ ëŒ€ê¸° ì¤‘<span class="chip-count" id="countPending">0</span></button>
                            <button class="filter-chip" onclick="filterInvites('used')" id="filterUsed">âœ… ì‚¬ìš©ë¨<span class="chip-count" id="countUsed">0</span></button>
                        </div>
                    </div>

                    <!-- ì´ˆëŒ€ì½”ë“œ í…Œì´ë¸” -->
                    <div class="table-wrap">
                        <div class="table-scroll">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>ë³‘ì›</th>
                                        <th>ì´ˆëŒ€ì½”ë“œ</th>
                                        <th>ìƒíƒœ</th>
                                        <th>ì‚¬ìš©ì</th>
                                        <th>ìƒì„±ì¼</th>
                                        <th>ê´€ë¦¬</th>
                                    </tr>
                                </thead>
                                <tbody id="inviteCodeList">
                                    <tr><td colspan="6" class="table-empty"><div class="empty-icon">ğŸ«</div>ë¡œë”© ì¤‘...</td></tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="table-footer">
                            <span id="inviteResultCount">0ê°œ ì´ˆëŒ€ì½”ë“œ</span>
                            <span id="inviteResultInfo"></span>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- ë³‘ì› ìƒì„¸ íŒ¨ë„ -->
    <div class="detail-panel" id="detailPanel">
        <div class="detail-panel-header">
            <h3 id="detailTitle">ë³‘ì› ìƒì„¸</h3>
            <button class="detail-close-btn" onclick="closeDetailPanel()">âœ•</button>
        </div>
        <div class="detail-panel-body" id="detailBody">
        </div>
    </div>

    <!-- ì´ˆëŒ€ì½”ë“œ ìƒì„± ëª¨ë‹¬ -->
    <div class="modal-overlay" id="createModal">
        <div class="modal">
            <div class="modal-title">ğŸ« ìƒˆ ì´ˆëŒ€ì½”ë“œ ìƒì„±</div>

            <div class="modal-field">
                <label>ë³‘ì› ID *</label>
                <input type="text" id="modalHospitalId" placeholder="ì˜ˆ: hospital_002" oninput="validateForm()">
            </div>

            <div class="modal-field">
                <label>ë³‘ì› ì´ë¦„ *</label>
                <input type="text" id="modalHospitalName" placeholder="ì˜ˆ: ì—°ì„¸ìš°ì¼ì¹˜ê³¼ë³‘ì›" oninput="validateForm()">
            </div>

            <div class="modal-field">
                <label>ì£¼ì†Œ (ì„ íƒ)</label>
                <input type="text" id="modalHospitalAddress" placeholder="ì˜ˆ: ì²œì•ˆì‹œ ì„œë¶êµ¬">
            </div>

            <div class="modal-field">
                <label>ì˜ˆë°©ê³¼ ë„ì…ì‹œê¸° (ì„ íƒ)</label>
                <input type="month" id="modalPreventionStart">
            </div>

            <div class="modal-code-preview">
                <div class="code-text" id="previewCode">----</div>
                <div class="code-hint">ì´ˆëŒ€ì½”ë“œê°€ ìë™ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤</div>
                <button onclick="regenerateCode()" style="margin-top:8px;padding:6px 16px;border-radius:8px;border:1px solid #92400e;background:white;color:#92400e;font-size:11px;font-weight:600;cursor:pointer;">ğŸ”„ ì½”ë“œ ì¬ìƒì„±</button>
            </div>

            <div class="modal-field">
                <label>ì½”ë“œ ì§ì ‘ ì…ë ¥ (ì„ íƒ)</label>
                <input type="text" id="modalCustomCode" placeholder="ë¹„ì›Œë‘ë©´ ìë™ ìƒì„±" oninput="updatePreviewFromInput()" maxlength="12" style="text-transform:uppercase;letter-spacing:2px;font-weight:600;">
            </div>

            <div class="modal-buttons">
                <button class="btn-cancel" onclick="closeCreateModal()">ì·¨ì†Œ</button>
                <button class="btn-create" id="btnCreate" onclick="createInviteCode()" disabled>âœ¨ ì´ˆëŒ€ì½”ë“œ ìƒì„±</button>
            </div>
        </div>
    </div>

    <!-- ë³‘ì› ì •ë³´ ìˆ˜ì • ëª¨ë‹¬ -->
    <div class="modal-overlay" id="editHospitalModal">
        <div class="modal">
            <div class="modal-title">âœï¸ ë³‘ì› ì •ë³´ ìˆ˜ì •</div>

            <div class="modal-field">
                <label>ë³‘ì› ID</label>
                <input type="text" id="editHospitalId" disabled style="background:#f3f4f6;">
            </div>

            <div class="modal-field">
                <label>ë³‘ì› ì´ë¦„</label>
                <input type="text" id="editHospitalName">
            </div>

            <div class="modal-field">
                <label>ì£¼ì†Œ</label>
                <input type="text" id="editHospitalAddress">
            </div>

            <div class="modal-field">
                <label>ì˜ˆë°©ê³¼ ë„ì…ì‹œê¸°</label>
                <input type="month" id="editPreventionStart">
            </div>

            <div class="modal-buttons">
                <button class="btn-cancel" onclick="closeEditHospitalModal()">ì·¨ì†Œ</button>
                <button class="btn-create" onclick="saveHospitalEdit()">ğŸ’¾ ì €ì¥</button>
            </div>
        </div>
    </div>

    <!-- í† ìŠ¤íŠ¸ -->
    <div class="toast" id="toast"></div>

    <script>
        // ==================== Firebase ì´ˆê¸°í™” ====================
        const firebaseConfig = {
            apiKey: "AIzaSyDrU3rYs4fxlMkr8r0sjo70Mt0Al-HUtyg",
            authDomain: "apseoncare-platform.firebaseapp.com",
            projectId: "apseoncare-platform",
            storageBucket: "apseoncare-platform.firebasestorage.app",
            messagingSenderId: "515333523928",
            appId: "1:515333523928:web:e19a9db63c522d8484caad"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        console.log('ğŸ”¥ Firebase ì´ˆê¸°í™” ì™„ë£Œ! (ê´€ë¦¬ì)');

        // ==================== ì „ì—­ ë°ì´í„° ====================
        let _allHospitals = [];    // { id, name, address, createdAt, users: [] }
        let _allInvites = [];      // { docId, code, hospitalId, hospitalName, isUsed, usedBy, usedAt, createdAt }
        let _hospitalFilter = 'all';
        let _hospitalSearch = '';
        let _inviteFilter = 'all';
        let _inviteSearch = '';

        // ==================== íƒ­ ì „í™˜ ====================
        function switchTab(tabName) {
            // íƒ­ í˜ì´ì§€ ì „í™˜
            document.querySelectorAll('.tab-page').forEach(p => p.classList.remove('active'));
            document.getElementById('tab-' + tabName).classList.add('active');

            // ì‚¬ì´ë“œë°” active ì „í™˜
            document.querySelectorAll('.nav-item[data-tab]').forEach(n => n.classList.remove('active'));
            const navItem = document.querySelector('.nav-item[data-tab="' + tabName + '"]');
            if (navItem) navItem.classList.add('active');

            // ìƒì„¸ íŒ¨ë„ ë‹«ê¸°
            closeDetailPanel();
        }

        // ==================== ë¡œê·¸ì¸ ìƒíƒœ ì²´í¬ ====================
        auth.onAuthStateChanged(async (user) => {
            if (!user) {
                window.location.href = 'apsencare_login_firebase.html';
                return;
            }
            console.log('ë¡œê·¸ì¸ë¨:', user.email);
            await loadUserInfo(user.uid);
            await loadDashboardData();
        });

        // ==================== ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ====================
        async function loadUserInfo(uid) {
            try {
                const userDoc = await db.collection('users').doc(uid).get();
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    if (userData.userType !== 'admin') {
                        alert('ê´€ë¦¬ì ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
                        window.location.href = 'apsencare_hospital_home_firebase.html';
                        return;
                    }
                    document.getElementById('userAvatar').textContent = userData.name ? userData.name.charAt(0) : 'ê´€';
                    document.getElementById('userName').textContent = userData.name || userData.email;
                }
            } catch (error) {
                console.error('ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }

        // ==================== ëŒ€ì‹œë³´ë“œ ë°ì´í„° ë¡œë“œ ====================
        async function loadDashboardData() {
            try {
                // 1. ë³‘ì› ë°ì´í„°
                const hospitalsSnap = await db.collection('hospitals').get();
                const usersSnap = await db.collection('users').where('userType', '==', 'hospital').get();

                // ì‚¬ìš©ì ë§¤í•‘
                const usersByHospital = {};
                usersSnap.forEach(doc => {
                    const u = doc.data();
                    const hId = u.hospitalId || '';
                    if (!usersByHospital[hId]) usersByHospital[hId] = [];
                    usersByHospital[hId].push({
                        uid: doc.id,
                        email: u.email || '-',
                        name: u.name || '',
                        hospitalName: u.hospitalName || '',
                        createdAt: u.createdAt ? u.createdAt.toDate() : null
                    });
                });

                _allHospitals = [];
                hospitalsSnap.forEach(doc => {
                    const h = doc.data();
                    _allHospitals.push({
                        id: doc.id,
                        name: h.name || doc.id,
                        address: h.address || h.adress || '',
                        preventionStart: h.preventionStart || '',
                        createdAt: h.createdAt ? h.createdAt.toDate() : null,
                        users: usersByHospital[doc.id] || []
                    });
                });

                // í†µê³„ ì—…ë°ì´íŠ¸
                document.getElementById('statHospitals').textContent = _allHospitals.length;
                document.getElementById('statUsers').textContent = usersSnap.size;
                document.getElementById('hospitalCountBadge').textContent = _allHospitals.length;

                // 2. ì´ˆëŒ€ì½”ë“œ ë°ì´í„°
                const invitesSnap = await db.collection('inviteCodes').get();
                _allInvites = [];
                let pendingCount = 0, usedCount = 0;

                invitesSnap.forEach(doc => {
                    const inv = doc.data();
                    const isUsed = inv.used === true;
                    if (isUsed) usedCount++; else pendingCount++;
                    _allInvites.push({
                        docId: doc.id,
                        code: inv.code || '-',
                        hospitalId: inv.hospitalId || '',
                        hospitalName: inv.hospitalName || inv.hospitalId || '-',
                        isUsed,
                        usedBy: inv.usedBy || '',
                        usedAt: inv.usedAt && inv.usedAt.toDate ? inv.usedAt.toDate() : null,
                        createdAt: inv.createdAt && inv.createdAt.toDate ? inv.createdAt.toDate() : null
                    });
                });

                document.getElementById('statPendingInvites').textContent = pendingCount;
                document.getElementById('statUsedInvites').textContent = usedCount;
                document.getElementById('inviteCountBadge').textContent = pendingCount;

                // íƒ­ë³„ í†µê³„
                document.getElementById('invStatTotal').textContent = _allInvites.length;
                document.getElementById('invStatPending').textContent = pendingCount;
                document.getElementById('invStatUsed').textContent = usedCount;

                // 3. ì „ì²´í˜„í™© - ê°„ëµ ë¯¸ë‹ˆ ë¦¬ìŠ¤íŠ¸ ë Œë”
                renderOverviewHospitals();
                renderOverviewInvites();
                renderRecentUsers(usersSnap);

                // 4. ë³‘ì› ëª©ë¡ íƒ­ ë Œë”
                updateHospitalCounts();
                renderHospitalTable(getFilteredHospitals());

                // 5. ì´ˆëŒ€ì½”ë“œ íƒ­ ë Œë”
                updateInviteCounts();
                renderInviteTable(getFilteredInvites());

                console.log('âœ… ëŒ€ì‹œë³´ë“œ ë°ì´í„° ë¡œë“œ ì™„ë£Œ');
            } catch (error) {
                console.error('ëŒ€ì‹œë³´ë“œ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }

        // ==================== ì „ì²´í˜„í™© - ê°„ëµ ë¯¸ë‹ˆ ë¦¬ìŠ¤íŠ¸ ====================
        function renderOverviewHospitals() {
            const container = document.getElementById('overviewHospitalList');
            const recent = [..._allHospitals].sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0)).slice(0, 5);

            if (recent.length === 0) {
                container.innerHTML = '<div class="empty-state">ë“±ë¡ëœ ë³‘ì›ì´ ì—†ìŠµë‹ˆë‹¤</div>';
                return;
            }

            container.innerHTML = recent.map(h => {
                const hasUser = h.users.length > 0;
                const preventionText = h.preventionStart ? h.preventionStart.replace('-', '.') : '';
                return `
                    <div class="mini-list-item">
                        <div class="mini-list-icon">${hasUser ? 'ğŸ¥' : 'ğŸ”’'}</div>
                        <div class="mini-list-info">
                            <div class="mini-list-name">${h.name}</div>
                            <div class="mini-list-sub">${h.address || 'ì£¼ì†Œ ë¯¸ë“±ë¡'} Â· ì‚¬ìš©ì ${h.users.length}ëª…${preventionText ? ' Â· ì˜ˆë°©ê³¼ ' + preventionText : ''}</div>
                        </div>
                        <span class="mini-list-badge ${hasUser ? 'active' : 'pending'}">${hasUser ? 'ê°€ì…ì™„ë£Œ' : 'ë¯¸ê°€ì…'}</span>
                    </div>
                `;
            }).join('');
        }

        function renderOverviewInvites() {
            const container = document.getElementById('overviewInviteList');
            const recent = [..._allInvites].sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0)).slice(0, 5);

            if (recent.length === 0) {
                container.innerHTML = '<div class="empty-state">ì´ˆëŒ€ì½”ë“œê°€ ì—†ìŠµë‹ˆë‹¤</div>';
                return;
            }

            container.innerHTML = recent.map(inv => `
                <div class="mini-list-item">
                    <div class="mini-list-icon">${inv.isUsed ? 'âœ…' : 'â³'}</div>
                    <div class="mini-list-info">
                        <div class="mini-list-name" style="font-family:monospace;letter-spacing:1px;">${inv.code}</div>
                        <div class="mini-list-sub">${inv.hospitalName}</div>
                    </div>
                    <span class="mini-list-badge ${inv.isUsed ? 'used' : 'pending'}">${inv.isUsed ? 'ì‚¬ìš©ë¨' : 'ëŒ€ê¸° ì¤‘'}</span>
                </div>
            `).join('');
        }

        function renderRecentUsers(usersSnap) {
            const container = document.getElementById('recentUsersList');
            if (usersSnap.empty) {
                container.innerHTML = '<div class="empty-state">ê°€ì…ëœ ë³‘ì› ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤</div>';
                return;
            }
            container.innerHTML = '';
            usersSnap.forEach(doc => {
                const u = doc.data();
                const createdAt = u.createdAt ? u.createdAt.toDate().toLocaleDateString('ko-KR') : '-';
                const div = document.createElement('div');
                div.className = 'activity-item';
                div.innerHTML = `
                    <div class="activity-icon">ğŸ‘¤</div>
                    <div class="activity-content">
                        <div class="activity-text"><strong>${u.name || u.email}</strong> â€” ${u.hospitalName || 'ë³‘ì›'}</div>
                        <div class="activity-time">${u.email} Â· ê°€ì…ì¼: ${createdAt}</div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // ==================== ë³‘ì› ëª©ë¡ íƒ­ ====================
        function updateHospitalCounts() {
            const active = _allHospitals.filter(h => h.users.length > 0).length;
            const pending = _allHospitals.filter(h => h.users.length === 0).length;
            document.getElementById('hCountAll').textContent = _allHospitals.length;
            document.getElementById('hCountActive').textContent = active;
            document.getElementById('hCountPending').textContent = pending;
        }

        function getFilteredHospitals() {
            let data = [..._allHospitals];
            if (_hospitalFilter === 'active') data = data.filter(h => h.users.length > 0);
            if (_hospitalFilter === 'pending') data = data.filter(h => h.users.length === 0);
            if (_hospitalSearch) {
                const q = _hospitalSearch.toLowerCase();
                data = data.filter(h =>
                    h.name.toLowerCase().includes(q) ||
                    h.address.toLowerCase().includes(q) ||
                    h.id.toLowerCase().includes(q) ||
                    h.users.some(u => u.email.toLowerCase().includes(q) || u.name.toLowerCase().includes(q))
                );
            }
            return data;
        }

        function filterHospitals(filter) {
            _hospitalFilter = filter;
            document.querySelectorAll('#tab-hospitals .filter-chip').forEach(c => c.classList.remove('active'));
            document.getElementById('hFilter' + filter.charAt(0).toUpperCase() + filter.slice(1)).classList.add('active');
            renderHospitalTable(getFilteredHospitals());
        }

        function searchHospitals(query) {
            _hospitalSearch = query.trim();
            renderHospitalTable(getFilteredHospitals());
        }

        function renderHospitalTable(data) {
            const tbody = document.getElementById('hospitalTableBody');
            document.getElementById('hospitalResultCount').textContent = data.length + 'ê°œ ë³‘ì›';

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="table-empty"><div class="empty-icon">ğŸ¥</div>ì¡°ê±´ì— ë§ëŠ” ë³‘ì›ì´ ì—†ìŠµë‹ˆë‹¤</td></tr>';
                return;
            }

            tbody.innerHTML = '';
            data.forEach(h => {
                const hasUser = h.users.length > 0;
                const createdAt = h.createdAt ? h.createdAt.toLocaleDateString('ko-KR') : '-';
                const emails = hasUser ? h.users.map(u => u.email).join(', ') : 'ë¯¸ê°€ì…';
                const preventionDisplay = h.preventionStart ? h.preventionStart.replace('-', 'ë…„ ') + 'ì›”' : '<span style="color:#9ca3af;">ë¯¸ë“±ë¡</span>';

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>
                        <div class="hospital-name">${h.name}</div>
                        <div class="hospital-sub">${h.address || ''} <span style="color:#d1d5db;">|</span> ID: ${h.id}</div>
                    </td>
                    <td style="font-size:12px;max-width:200px;">
                        ${hasUser ? h.users.map(u => `<div>${u.email}</div>`).join('') : '<span style="color:#9ca3af;">â€”</span>'}
                    </td>
                    <td style="font-size:12px;font-weight:600;color:#7c3aed;">
                        ${preventionDisplay}
                    </td>
                    <td>
                        <span class="status-badge ${hasUser ? 'active' : 'pending'}">${hasUser ? 'ê°€ì…ì™„ë£Œ' : 'ë¯¸ê°€ì…'}</span>
                        ${hasUser ? '<div style="font-size:10px;color:#6b7280;margin-top:2px;">' + h.users.length + 'ëª… ê³„ì •</div>' : ''}
                    </td>
                    <td style="font-size:12px;color:#6b7280;">${createdAt}</td>
                    <td>
                        <div class="row-actions">
                            <button class="row-btn view" onclick="openHospitalDetail('${h.id}')">ğŸ‘ï¸ ìƒì„¸</button>
                            <button class="row-btn edit" onclick="openEditHospitalModal('${h.id}')">âœï¸</button>
                            ${hasUser ? h.users.map(u => `<button class="row-btn edit" onclick="sendPasswordReset('${u.email}')" title="ë¹„ë°€ë²ˆí˜¸ ì´ˆê¸°í™”">ğŸ”‘</button>`).join('') : ''}
                            <button class="row-btn delete" onclick="deleteHospital('${h.id}', '${h.name}')">ğŸ—‘ï¸</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // ë³‘ì› ìƒì„¸ íŒ¨ë„
        function openHospitalDetail(hospitalId) {
            const h = _allHospitals.find(x => x.id === hospitalId);
            if (!h) return;

            document.getElementById('detailTitle').textContent = h.name;

            const invitesForHospital = _allInvites.filter(inv => inv.hospitalId === hospitalId);

            let usersHtml = '';
            if (h.users.length > 0) {
                usersHtml = h.users.map(u => `
                    <div class="detail-user-item">
                        <div class="user-icon">ğŸ‘¤</div>
                        <div class="detail-user-info">
                            <div class="detail-user-name">${u.name || 'ì´ë¦„ ë¯¸ì„¤ì •'}</div>
                            <div class="detail-user-email">${u.email}</div>
                        </div>
                        <button class="row-btn edit" onclick="sendPasswordReset('${u.email}')" style="font-size:10px;">ğŸ”‘ PWì´ˆê¸°í™”</button>
                    </div>
                `).join('');
            } else {
                usersHtml = '<div style="color:#9ca3af;font-size:13px;padding:12px 0;">ì•„ì§ ê°€ì…í•œ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤</div>';
            }

            let invitesHtml = '';
            if (invitesForHospital.length > 0) {
                invitesHtml = invitesForHospital.map(inv => `
                    <div class="detail-user-item">
                        <div class="user-icon" style="background:${inv.isUsed ? '#dcfce7' : '#fef3c7'};">${inv.isUsed ? 'âœ…' : 'â³'}</div>
                        <div class="detail-user-info">
                            <div class="detail-user-name" style="font-family:monospace;letter-spacing:1px;">${inv.code}</div>
                            <div class="detail-user-email">${inv.isUsed ? 'ì‚¬ìš©ë¨' + (inv.usedBy ? ' Â· ' + inv.usedBy : '') : 'ëŒ€ê¸° ì¤‘'}</div>
                        </div>
                        <button class="row-btn copy" onclick="copyCode('${inv.code}')">ğŸ“‹</button>
                    </div>
                `).join('');
            } else {
                invitesHtml = '<div style="color:#9ca3af;font-size:13px;padding:12px 0;">ë°œê¸‰ëœ ì´ˆëŒ€ì½”ë“œê°€ ì—†ìŠµë‹ˆë‹¤</div>';
            }

            document.getElementById('detailBody').innerHTML = `
                <div class="detail-field">
                    <label>ë³‘ì› ID</label>
                    <div class="value" style="font-family:monospace;">${h.id}</div>
                </div>
                <div class="detail-field">
                    <label>ë³‘ì›ëª…</label>
                    <div class="value">${h.name}</div>
                </div>
                <div class="detail-field">
                    <label>ì£¼ì†Œ</label>
                    <div class="value">${h.address || 'ë¯¸ë“±ë¡'}</div>
                </div>
                <div class="detail-field">
                    <label>ì˜ˆë°©ê³¼ ë„ì…ì‹œê¸°</label>
                    <div class="value" style="color:#7c3aed;font-weight:600;">${h.preventionStart ? h.preventionStart.replace('-', 'ë…„ ') + 'ì›”' : 'ë¯¸ë“±ë¡'}</div>
                </div>
                <div class="detail-field">
                    <label>ë“±ë¡ì¼</label>
                    <div class="value">${h.createdAt ? h.createdAt.toLocaleDateString('ko-KR') : '-'}</div>
                </div>

                <div class="detail-divider"></div>

                <div class="detail-section-title">ğŸ‘¤ ë“±ë¡ ì‚¬ìš©ì (${h.users.length}ëª…)</div>
                ${usersHtml}

                <div class="detail-divider"></div>

                <div class="detail-section-title">ğŸ« ì´ˆëŒ€ì½”ë“œ (${invitesForHospital.length}ê°œ)</div>
                ${invitesHtml}

                <div class="detail-divider"></div>

                <div style="display:flex;gap:8px;">
                    <button class="btn btn-warning" style="flex:1;" onclick="openEditHospitalModal('${h.id}'); closeDetailPanel();">âœï¸ ì •ë³´ ìˆ˜ì •</button>
                    <button class="btn btn-danger" style="flex:1;" onclick="deleteHospital('${h.id}', '${h.name}'); closeDetailPanel();">ğŸ—‘ï¸ ì‚­ì œ</button>
                </div>
            `;

            document.getElementById('detailPanel').classList.add('active');
        }

        function closeDetailPanel() {
            document.getElementById('detailPanel').classList.remove('active');
        }

        // ë³‘ì› ì •ë³´ ìˆ˜ì •
        function openEditHospitalModal(hospitalId) {
            const h = _allHospitals.find(x => x.id === hospitalId);
            if (!h) return;
            document.getElementById('editHospitalId').value = h.id;
            document.getElementById('editHospitalName').value = h.name;
            document.getElementById('editHospitalAddress').value = h.address;
            document.getElementById('editPreventionStart').value = h.preventionStart || '';
            document.getElementById('editHospitalModal').classList.add('active');
        }

        function closeEditHospitalModal() {
            document.getElementById('editHospitalModal').classList.remove('active');
        }

        async function saveHospitalEdit() {
            const id = document.getElementById('editHospitalId').value;
            const name = document.getElementById('editHospitalName').value.trim();
            const address = document.getElementById('editHospitalAddress').value.trim();
            const preventionStart = document.getElementById('editPreventionStart').value;

            if (!name) {
                showToast('ë³‘ì› ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            try {
                await db.collection('hospitals').doc(id).update({ name, address, preventionStart: preventionStart || '' });
                showToast('ë³‘ì› ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                closeEditHospitalModal();
                await loadDashboardData();
            } catch (error) {
                console.error('ë³‘ì› ìˆ˜ì • ì˜¤ë¥˜:', error);
                showToast('ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // ë³‘ì› ì‚­ì œ
        async function deleteHospital(hospitalId, hospitalName) {
            if (!confirm('ì •ë§ "' + hospitalName + '" ë³‘ì›ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâš ï¸ ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n(ì—°ê²°ëœ ì´ˆëŒ€ì½”ë“œì™€ ì‚¬ìš©ì ë°ì´í„°ëŠ” ìœ ì§€ë©ë‹ˆë‹¤)')) return;

            try {
                await db.collection('hospitals').doc(hospitalId).delete();
                showToast('"' + hospitalName + '" ë³‘ì›ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                await loadDashboardData();
            } catch (error) {
                console.error('ë³‘ì› ì‚­ì œ ì˜¤ë¥˜:', error);
                showToast('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // ë°ì´í„° ë‚´ë³´ë‚´ê¸°
        function exportHospitalData() {
            const data = getFilteredHospitals();
            const csvRows = ['ë³‘ì›ID,ë³‘ì›ëª…,ì£¼ì†Œ,ì˜ˆë°©ê³¼ë„ì…ì‹œê¸°,ìƒíƒœ,ì´ë©”ì¼,ë“±ë¡ì¼'];
            data.forEach(h => {
                const status = h.users.length > 0 ? 'ê°€ì…ì™„ë£Œ' : 'ë¯¸ê°€ì…';
                const emails = h.users.map(u => u.email).join('; ') || '-';
                const date = h.createdAt ? h.createdAt.toLocaleDateString('ko-KR') : '-';
                const prevention = h.preventionStart || '-';
                csvRows.push(`${h.id},${h.name},${h.address},${prevention},${status},${emails},${date}`);
            });

            const blob = new Blob(['\uFEFF' + csvRows.join('\n')], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'ì•ì„ ì¼€ì–´_ë³‘ì›ëª©ë¡_' + new Date().toISOString().slice(0, 10) + '.csv';
            a.click();
            showToast('ë³‘ì› ëª©ë¡ CSV ë‹¤ìš´ë¡œë“œ!', 'success');
        }

        // ==================== ì´ˆëŒ€ì½”ë“œ íƒ­ ====================
        function updateInviteCounts() {
            const pending = _allInvites.filter(i => !i.isUsed).length;
            const used = _allInvites.filter(i => i.isUsed).length;
            document.getElementById('countAll').textContent = _allInvites.length;
            document.getElementById('countPending').textContent = pending;
            document.getElementById('countUsed').textContent = used;
        }

        function getFilteredInvites() {
            let data = [..._allInvites];
            if (_inviteFilter === 'pending') data = data.filter(d => !d.isUsed);
            if (_inviteFilter === 'used') data = data.filter(d => d.isUsed);
            if (_inviteSearch) {
                const q = _inviteSearch.toLowerCase();
                data = data.filter(d =>
                    d.hospitalName.toLowerCase().includes(q) ||
                    d.code.toLowerCase().includes(q) ||
                    (d.usedBy && d.usedBy.toLowerCase().includes(q))
                );
            }
            return data;
        }

        function filterInvites(filter) {
            _inviteFilter = filter;
            document.querySelectorAll('#tab-invites .filter-chip').forEach(c => c.classList.remove('active'));
            document.getElementById('filter' + filter.charAt(0).toUpperCase() + filter.slice(1)).classList.add('active');
            renderInviteTable(getFilteredInvites());
        }

        function searchInvites(query) {
            _inviteSearch = query.trim();
            renderInviteTable(getFilteredInvites());
        }

        function renderInviteTable(data) {
            const tbody = document.getElementById('inviteCodeList');
            document.getElementById('inviteResultCount').textContent = data.length + 'ê°œ ì´ˆëŒ€ì½”ë“œ';

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="table-empty"><div class="empty-icon">ğŸ«</div>ì¡°ê±´ì— ë§ëŠ” ì´ˆëŒ€ì½”ë“œê°€ ì—†ìŠµë‹ˆë‹¤</td></tr>';
                return;
            }

            tbody.innerHTML = '';
            data.forEach(inv => {
                const tr = document.createElement('tr');
                tr.className = inv.isUsed ? 'used-row' : '';
                const createdDate = inv.createdAt ? inv.createdAt.toLocaleDateString('ko-KR') : '-';
                const usedDate = inv.usedAt ? inv.usedAt.toLocaleDateString('ko-KR') : '';

                tr.innerHTML = `
                    <td>
                        <div class="hospital-name">${inv.hospitalName}</div>
                        <div class="hospital-sub">ID: ${inv.hospitalId}</div>
                    </td>
                    <td class="code-cell">${inv.code}</td>
                    <td>
                        <span class="status-badge ${inv.isUsed ? 'active' : 'pending'}">${inv.isUsed ? 'âœ… ì‚¬ìš©ë¨' : 'â³ ëŒ€ê¸° ì¤‘'}</span>
                        ${usedDate ? '<div style="font-size:10px;color:#6b7280;margin-top:2px;">' + usedDate + '</div>' : ''}
                    </td>
                    <td style="font-size:12px;">
                        ${inv.usedBy ? inv.usedBy : '<span style="color:#9ca3af;">â€”</span>'}
                    </td>
                    <td style="font-size:12px;color:#6b7280;">${createdDate}</td>
                    <td>
                        <div class="row-actions">
                            <button class="row-btn copy" onclick="copyCode('${inv.code}')" title="ë³µì‚¬">ğŸ“‹</button>
                            ${inv.isUsed
                                ? '<button class="row-btn reactivate" onclick="toggleInviteStatus(\'' + inv.docId + '\', false)" title="ì¬í™œì„±í™”">ğŸ”„</button>'
                                : '<button class="row-btn toggle" onclick="toggleInviteStatus(\'' + inv.docId + '\', true)" title="ë¹„í™œì„±í™”">â¸ï¸</button>'
                            }
                            <button class="row-btn delete" onclick="deleteInviteCode('${inv.docId}', '${inv.code}')" title="ì‚­ì œ">ğŸ—‘ï¸</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function exportInviteData() {
            const data = getFilteredInvites();
            const csvRows = ['ì´ˆëŒ€ì½”ë“œ,ë³‘ì›ëª…,ë³‘ì›ID,ìƒíƒœ,ì‚¬ìš©ì,ìƒì„±ì¼'];
            data.forEach(inv => {
                const status = inv.isUsed ? 'ì‚¬ìš©ë¨' : 'ëŒ€ê¸°ì¤‘';
                const date = inv.createdAt ? inv.createdAt.toLocaleDateString('ko-KR') : '-';
                csvRows.push(`${inv.code},${inv.hospitalName},${inv.hospitalId},${status},${inv.usedBy || '-'},${date}`);
            });

            const blob = new Blob(['\uFEFF' + csvRows.join('\n')], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'ì•ì„ ì¼€ì–´_ì´ˆëŒ€ì½”ë“œ_' + new Date().toISOString().slice(0, 10) + '.csv';
            a.click();
            showToast('ì´ˆëŒ€ì½”ë“œ CSV ë‹¤ìš´ë¡œë“œ!', 'success');
        }

        // ==================== ë¹„ë°€ë²ˆí˜¸ ì´ˆê¸°í™” ====================
        async function sendPasswordReset(email) {
            if (!confirm('"' + email + '" ê³„ì •ìœ¼ë¡œ ë¹„ë°€ë²ˆí˜¸ ì´ˆê¸°í™” ë©”ì¼ì„ ë³´ë‚´ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            try {
                await auth.sendPasswordResetEmail(email);
                showToast('ğŸ“§ ' + email + 'ë¡œ ë¹„ë°€ë²ˆí˜¸ ì´ˆê¸°í™” ë©”ì¼ ë°œì†¡!', 'success');
            } catch (error) {
                console.error('ë¹„ë°€ë²ˆí˜¸ ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
                if (error.code === 'auth/user-not-found') {
                    showToast('í•´ë‹¹ ì´ë©”ì¼ë¡œ ë“±ë¡ëœ ê³„ì •ì´ ì—†ìŠµë‹ˆë‹¤.', 'error');
                } else {
                    showToast('ë©”ì¼ ë°œì†¡ ì¤‘ ì˜¤ë¥˜: ' + error.message, 'error');
                }
            }
        }

        // ==================== ì´ˆëŒ€ì½”ë“œ ìƒì„± ëª¨ë‹¬ ====================
        let generatedCode = '';

        function generateCode() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let code = '';
            for (let i = 0; i < 4; i++) code += chars.charAt(Math.floor(Math.random() * chars.length));
            code += '-';
            for (let i = 0; i < 4; i++) code += chars.charAt(Math.floor(Math.random() * chars.length));
            return code;
        }

        function openCreateModal() {
            generatedCode = generateCode();
            document.getElementById('previewCode').textContent = generatedCode;
            document.getElementById('modalHospitalId').value = '';
            document.getElementById('modalHospitalName').value = '';
            document.getElementById('modalHospitalAddress').value = '';
            document.getElementById('modalPreventionStart').value = '';
            document.getElementById('modalCustomCode').value = '';
            document.getElementById('btnCreate').disabled = true;
            document.getElementById('createModal').classList.add('active');
        }

        function closeCreateModal() {
            document.getElementById('createModal').classList.remove('active');
        }

        function regenerateCode() {
            generatedCode = generateCode();
            document.getElementById('previewCode').textContent = generatedCode;
            document.getElementById('modalCustomCode').value = '';
        }

        function updatePreviewFromInput() {
            const custom = document.getElementById('modalCustomCode').value.trim().toUpperCase();
            document.getElementById('previewCode').textContent = custom || generatedCode;
        }

        function validateForm() {
            const id = document.getElementById('modalHospitalId').value.trim();
            const name = document.getElementById('modalHospitalName').value.trim();
            document.getElementById('btnCreate').disabled = !(id && name);
        }

        async function createInviteCode() {
            const hospitalId = document.getElementById('modalHospitalId').value.trim();
            const hospitalName = document.getElementById('modalHospitalName').value.trim();
            const address = document.getElementById('modalHospitalAddress').value.trim();
            const preventionStart = document.getElementById('modalPreventionStart').value;
            const customCode = document.getElementById('modalCustomCode').value.trim().toUpperCase();
            const finalCode = customCode || generatedCode;

            if (!hospitalId || !hospitalName) {
                showToast('ë³‘ì› IDì™€ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            document.getElementById('btnCreate').disabled = true;
            document.getElementById('btnCreate').textContent = 'ìƒì„± ì¤‘...';

            try {
                const existing = await db.collection('inviteCodes').where('code', '==', finalCode).get();
                if (!existing.empty) {
                    showToast('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì½”ë“œì…ë‹ˆë‹¤.', 'error');
                    document.getElementById('btnCreate').disabled = false;
                    document.getElementById('btnCreate').textContent = 'âœ¨ ì´ˆëŒ€ì½”ë“œ ìƒì„±';
                    return;
                }

                const hospitalRef = db.collection('hospitals').doc(hospitalId);
                const hospitalDoc = await hospitalRef.get();
                if (!hospitalDoc.exists) {
                    await hospitalRef.set({
                        name: hospitalName,
                        address: address || '',
                        preventionStart: preventionStart || '',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }

                await db.collection('inviteCodes').add({
                    code: finalCode,
                    hospitalId: hospitalId,
                    hospitalName: hospitalName,
                    used: false,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                closeCreateModal();
                showToast('ì´ˆëŒ€ì½”ë“œ "' + finalCode + '" ìƒì„± ì™„ë£Œ!', 'success');
                await loadDashboardData();
            } catch (error) {
                console.error('ì´ˆëŒ€ì½”ë“œ ìƒì„± ì˜¤ë¥˜:', error);
                showToast('ì´ˆëŒ€ì½”ë“œ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }

            document.getElementById('btnCreate').disabled = false;
            document.getElementById('btnCreate').textContent = 'âœ¨ ì´ˆëŒ€ì½”ë“œ ìƒì„±';
        }

        // ==================== ì´ˆëŒ€ì½”ë“œ ìƒíƒœ í† ê¸€ ====================
        async function toggleInviteStatus(docId, setUsed) {
            const action = setUsed ? 'ë¹„í™œì„±í™”(ì‚¬ìš©ë¨ ì²˜ë¦¬)' : 'ì¬í™œì„±í™”';
            if (!confirm('ì´ ì´ˆëŒ€ì½”ë“œë¥¼ ' + action + ' í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            try {
                const updateData = { used: setUsed };
                if (!setUsed) {
                    updateData.usedBy = firebase.firestore.FieldValue.delete();
                    updateData.usedAt = firebase.firestore.FieldValue.delete();
                }
                await db.collection('inviteCodes').doc(docId).update(updateData);
                showToast(action + ' ì™„ë£Œ!', 'success');
                await loadDashboardData();
            } catch (error) {
                console.error('ìƒíƒœ ë³€ê²½ ì˜¤ë¥˜:', error);
                showToast('ìƒíƒœ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // ==================== ì´ˆëŒ€ì½”ë“œ ì‚­ì œ ====================
        async function deleteInviteCode(docId, code) {
            if (!confirm('ì´ˆëŒ€ì½”ë“œ "' + code + '"ì„(ë¥¼) ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) return;
            try {
                await db.collection('inviteCodes').doc(docId).delete();
                showToast('ì´ˆëŒ€ì½”ë“œ ì‚­ì œ ì™„ë£Œ!', 'success');
                await loadDashboardData();
            } catch (error) {
                console.error('ì‚­ì œ ì˜¤ë¥˜:', error);
                showToast('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // ==================== ì´ˆëŒ€ì½”ë“œ ë³µì‚¬ ====================
        function copyCode(code) {
            navigator.clipboard.writeText(code).then(() => {
                showToast('ì´ˆëŒ€ì½”ë“œ ë³µì‚¬ë¨: ' + code, 'success');
            }).catch(() => {
                prompt('ì´ˆëŒ€ì½”ë“œë¥¼ ë³µì‚¬í•˜ì„¸ìš”:', code);
            });
        }

        // ==================== í† ìŠ¤íŠ¸ ====================
        function showToast(message, type) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast ' + type + ' show';
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // ==================== ë¡œê·¸ì•„ì›ƒ ====================
        async function handleLogout() {
            if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                await auth.signOut();
                window.location.href = 'apsencare_login_firebase.html';
            }
        }
    </script>
</body>
</html>
