<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì•ì„ ì¼€ì–´ - ë¡œê·¸ì¸</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK (compat ë²„ì „ - ì•ˆì •ì ì¸ 9.x) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', 'Noto Sans KR', sans-serif; background: #f9fafb; min-height: 100vh; display: flex; }
        .login-page { display: flex; width: 100%; min-height: 100vh; }

        /* ì¢Œì¸¡: ë¡œê·¸ì¸ ì˜ì—­ */
        .login-section {
            width: 420px;
            min-width: 420px;
            background: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 48px;
            box-shadow: 4px 0 30px rgba(0, 0, 0, 0.08);
            position: relative;
            z-index: 10;
        }

        .login-container { width: 100%; max-width: 340px; }

        .login-header { margin-bottom: 32px; }
        .logo { display: flex; align-items: center; gap: 10px; margin-bottom: 24px; }
        .logo-circle { width: 44px; height: 44px; background: linear-gradient(135deg, #fce7f3, #fbcfe8); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 22px; border: 2px solid #ec4899; }
        .logo-text-group { text-align: left; }
        .logo-main { font-family: 'Noto Sans KR', sans-serif; font-size: 20px; font-weight: 700; color: #1f2937; }
        .logo-sub { font-size: 10px; color: #ec4899; font-weight: 600; text-transform: uppercase; }

        .welcome-text { font-size: 26px; font-weight: 700; color: #1f2937; margin-bottom: 8px; }
        .welcome-desc { font-size: 14px; color: #6b7280; }

        /* í¼ ìŠ¤íƒ€ì¼ */
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 8px; }
        .input-wrapper { position: relative; }
        .form-input {
            width: 100%;
            padding: 14px 16px;
            border: 1.5px solid #e5e7eb;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.2s;
            background: #f9fafb;
        }
        .form-input:focus { outline: none; border-color: #ec4899; background: white; box-shadow: 0 0 0 3px rgba(236, 72, 153, 0.1); }
        .form-input.error { border-color: #ef4444; background: #fef2f2; }

        .password-toggle { position: absolute; right: 14px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; font-size: 16px; color: #9ca3af; }

        .form-options { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; font-size: 13px; }
        .remember-me { display: flex; align-items: center; gap: 6px; color: #6b7280; cursor: pointer; }
        .remember-me input { accent-color: #ec4899; }
        .forgot-password { color: #ec4899; text-decoration: none; font-weight: 500; }
        .forgot-password:hover { text-decoration: underline; }

        .login-button {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #f472b6, #ec4899);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .login-button:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(236, 72, 153, 0.3); }
        .login-button:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

        /* êµ¬ë¶„ì„  */
        .divider { display: flex; align-items: center; gap: 16px; margin: 28px 0; }
        .divider-line { flex: 1; height: 1px; background: #e5e7eb; }
        .divider-text { font-size: 12px; color: #9ca3af; }

        /* ì´ˆëŒ€ì½”ë“œ ì„¹ì…˜ */
        .invite-section { background: #fdf2f8; border-radius: 12px; padding: 20px; }
        .invite-title { font-size: 14px; font-weight: 600; color: #1f2937; margin-bottom: 4px; }
        .invite-desc { font-size: 12px; color: #6b7280; margin-bottom: 12px; }
        .invite-input-group { display: flex; gap: 8px; }
        .invite-input {
            flex: 1;
            padding: 12px 14px;
            border: 1.5px solid #fbcfe8;
            border-radius: 8px;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 2px;
            text-align: center;
            background: white;
        }
        .invite-input:focus { outline: none; border-color: #ec4899; }
        .invite-button {
            padding: 12px 20px;
            background: #ec4899;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
        }
        .invite-button:hover { background: #db2777; }

        /* ìš°ì¸¡: ì†Œê°œ ì˜ì—­ */
        .intro-section {
            flex: 1;
            background: linear-gradient(135deg, #fdf2f8 0%, #fce7f3 50%, #fbcfe8 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 48px;
            position: relative;
            overflow: hidden;
        }

        .intro-section::before {
            content: '';
            position: absolute;
            top: -20%;
            right: -10%;
            width: 500px;
            height: 500px;
            background: rgba(236, 72, 153, 0.1);
            border-radius: 50%;
        }

        .intro-content { position: relative; z-index: 1; max-width: 560px; text-align: center; }

        .intro-logo { display: flex; align-items: center; justify-content: center; gap: 16px; margin-bottom: 36px; }
        .intro-logo-circle { width: 80px; height: 80px; background: linear-gradient(135deg, #fce7f3, #fbcfe8); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 40px; border: 3px solid #ec4899; box-shadow: 0 8px 30px rgba(236, 72, 153, 0.2); }
        .intro-logo-text { text-align: left; }
        .intro-logo-main { font-family: 'Noto Sans KR', sans-serif; font-size: 36px; font-weight: 800; color: #1f2937; }
        .intro-logo-sub { font-size: 12px; color: #ec4899; font-weight: 600; letter-spacing: 1px; text-transform: uppercase; }

        .intro-badge { display: inline-block; background: rgba(236, 72, 153, 0.15); color: #be185d; padding: 8px 18px; border-radius: 20px; font-size: 13px; font-weight: 600; margin-bottom: 20px; }
        .intro-title { font-size: 32px; font-weight: 700; color: #1f2937; margin-bottom: 16px; line-height: 1.4; }
        .intro-title span { color: #ec4899; }
        .intro-desc { font-size: 16px; color: #4b5563; line-height: 1.8; margin-bottom: 40px; }

        .values-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 40px; }
        .value-card { background: white; border-radius: 12px; padding: 20px 16px; text-align: center; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06); transition: all 0.2s; }
        .value-card:hover { transform: translateY(-4px); box-shadow: 0 8px 30px rgba(236, 72, 153, 0.15); }
        .value-icon { width: 48px; height: 48px; background: linear-gradient(135deg, #fdf2f8, #fce7f3); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin: 0 auto 12px; font-size: 22px; }
        .value-card h4 { font-size: 14px; font-weight: 700; color: #1f2937; margin-bottom: 4px; }
        .value-card p { font-size: 11px; color: #6b7280; }

        .cdhc-box { background: white; border-radius: 12px; padding: 20px; text-align: left; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06); }
        .cdhc-header { display: flex; align-items: center; gap: 8px; margin-bottom: 12px; }
        .cdhc-header span { font-size: 20px; }
        .cdhc-header h4 { font-size: 14px; font-weight: 700; color: #1f2937; }
        .cdhc-box p { font-size: 13px; color: #4b5563; line-height: 1.7; }

        /* ì—ëŸ¬ ë©”ì‹œì§€ */
        .error-message {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 13px;
            margin-bottom: 16px;
            display: none;
        }
        .error-message.show { display: block; }

        /* ë¡œë”© */
        .loading-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }
        .loading-overlay.show { opacity: 1; visibility: visible; }
        .loading-spinner { width: 48px; height: 48px; border: 4px solid #fce7f3; border-top-color: #ec4899; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 16px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { color: #6b7280; font-size: 14px; }

        /* í† ìŠ¤íŠ¸ */
        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            padding: 14px 28px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 500;
            z-index: 9999;
            opacity: 0;
            transition: all 0.3s ease;
        }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        .toast.success { background: #10b981; color: white; }
        .toast.error { background: #ef4444; color: white; }
        .toast.info { background: #3b82f6; color: white; }

        /* ë°˜ì‘í˜• */
        @media (max-width: 1024px) {
            .intro-section { display: none; }
            .login-section { width: 100%; min-width: auto; }
        }
    </style>
</head>
<body>
    <!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">ë¡œê·¸ì¸ ì¤‘...</div>
    </div>

    <!-- í† ìŠ¤íŠ¸ -->
    <div class="toast" id="toast"></div>

    <div class="login-page">
        <!-- ì¢Œì¸¡: ë¡œê·¸ì¸ í¼ -->
        <div class="login-section">
            <div class="login-container">
                <div class="login-header">
                    <div class="logo">
                        <div class="logo-circle">ğŸ¦·</div>
                        <div class="logo-text-group">
                            <div class="logo-main">ì•ì„ ì¼€ì–´</div>
                            <div class="logo-sub">Advanced Care Platform</div>
                        </div>
                    </div>
                    <h1 class="welcome-text">í™˜ì˜í•©ë‹ˆë‹¤ ğŸ‘‹</h1>
                    <p class="welcome-desc">ê³„ì •ì— ë¡œê·¸ì¸í•˜ì—¬ ì„œë¹„ìŠ¤ë¥¼ ì´ìš©í•˜ì„¸ìš”</p>
                </div>

                <!-- ì—ëŸ¬ ë©”ì‹œì§€ -->
                <div class="error-message" id="errorMessage"></div>

                <form id="loginForm">
                    <div class="form-group">
                        <label class="form-label">ì´ë©”ì¼</label>
                        <input type="email" class="form-input" id="emailInput" placeholder="example@hospital.com" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">ë¹„ë°€ë²ˆí˜¸</label>
                        <div class="input-wrapper">
                            <input type="password" class="form-input" id="passwordInput" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”" required>
                            <button type="button" class="password-toggle" onclick="togglePassword()">ğŸ‘ï¸</button>
                        </div>
                    </div>

                    <div class="form-options">
                        <label class="remember-me">
                            <input type="checkbox" id="rememberMe">
                            ë¡œê·¸ì¸ ìƒíƒœ ìœ ì§€
                        </label>
                        <a href="#" class="forgot-password" onclick="handleForgotPassword(event)">ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸°</a>
                    </div>

                    <button type="submit" class="login-button" id="loginBtn">ë¡œê·¸ì¸</button>
                </form>

                <div class="divider">
                    <div class="divider-line"></div>
                    <span class="divider-text">ì²˜ìŒì´ì‹ ê°€ìš”?</span>
                    <div class="divider-line"></div>
                </div>

                <div class="invite-section">
                    <h3 class="invite-title">ğŸ« ì´ˆëŒ€ì½”ë“œë¡œ ë“±ë¡í•˜ê¸°</h3>
                    <p class="invite-desc">ì•ì„ ì¼€ì–´ íŒŒíŠ¸ë„ˆ ë³‘ì›ì—ê²Œ ë°œê¸‰ëœ ì´ˆëŒ€ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”</p>
                    <div class="invite-input-group">
                        <input type="text" class="invite-input" id="inviteCodeInput" placeholder="XXXX-XXXX" maxlength="9">
                        <button class="invite-button" onclick="handleInviteCode()">ë“±ë¡</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ìš°ì¸¡: ì•ì„ ì¼€ì–´ ì†Œê°œ -->
        <div class="intro-section">
            <div class="intro-content">
                <div class="intro-logo">
                    <div class="intro-logo-circle">ğŸ¦·</div>
                    <div class="intro-logo-text">
                        <div class="intro-logo-main">ì•ì„ ì¼€ì–´</div>
                        <div class="intro-logo-sub">Advanced Care Platform</div>
                    </div>
                </div>
                
                <span class="intro-badge">ğŸ’œ ì˜ˆë°©ì¹˜ê³¼ ì „ë¬¸ ì»¨ì„¤íŒ…</span>
                
                <h2 class="intro-title">
                    "ì˜ˆë°©ì´ ë¨¼ì €ì…ë‹ˆë‹¤.<br>
                    <span>ì•ì„ ì¼€ì–´</span>ê°€ í•¨ê»˜í•©ë‹ˆë‹¤."
                </h2>
                
                <p class="intro-desc">
                    ì•ì„ ì¼€ì–´ëŠ” í¬ê´„ì¹˜ê³¼ìœ„ìƒê´€ë¦¬(CDHC)ë¥¼ ê¸°ë°˜ìœ¼ë¡œ<br>
                    ì¹˜ê³¼ìœ„ìƒì‚¬ì˜ ì „ë¬¸ì„±ì„ ë†’ì´ê³ , í™˜ì ì¤‘ì‹¬ì˜<br>
                    ì˜ˆë°© ì§„ë£Œ ë¬¸í™”ë¥¼ í™•ì‚°í•˜ëŠ” ì˜ˆë°©ì¹˜ê³¼ ì „ë¬¸ íŒ€ì…ë‹ˆë‹¤.
                </p>

                <div class="values-grid">
                    <div class="value-card">
                        <div class="value-icon">ğŸ‘¤</div>
                        <h4>í™˜ì ì¤‘ì‹¬</h4>
                        <p>Patient-Centered</p>
                    </div>
                    <div class="value-card">
                        <div class="value-icon">ğŸ”¬</div>
                        <h4>ê·¼ê±° ê¸°ë°˜</h4>
                        <p>Evidence-Based</p>
                    </div>
                    <div class="value-card">
                        <div class="value-icon">ğŸ›¡ï¸</div>
                        <h4>ì˜ˆë°© ìš°ì„ </h4>
                        <p>Prevention-First</p>
                    </div>
                </div>

                <div class="cdhc-box">
                    <div class="cdhc-header">
                        <span>ğŸ“˜</span>
                        <h4>CDHCë€?</h4>
                    </div>
                    <p>
                        <strong>í¬ê´„ì¹˜ê³¼ìœ„ìƒê´€ë¦¬</strong>(Comprehensive Dental Hygiene Care)ëŠ” 
                        í™˜ì ê°œê°œì¸ì˜ êµ¬ê°•ê±´ê°• ìƒíƒœì™€ ìœ„í—˜ìš”ì¸ì„ ì¢…í•©ì ìœ¼ë¡œ í‰ê°€í•˜ì—¬, 
                        ì˜ˆë°© ì¤‘ì‹¬ì˜ ë§ì¶¤í˜• ì¹˜ì£¼ê´€ë¦¬ë¥¼ ì œê³µí•˜ëŠ” ì²´ê³„ì ì¸ ì¹˜ê³¼ìœ„ìƒ ê´€ë¦¬ ê³¼ì •ì…ë‹ˆë‹¤.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== Firebase ì´ˆê¸°í™” ====================
        const firebaseConfig = {
            apiKey: "AIzaSyDrU3rYs4fxlMkr8r0sjo70Mt0Al-HUtyg",
            authDomain: "apseoncare-platform.firebaseapp.com",
            projectId: "apseoncare-platform",
            storageBucket: "apseoncare-platform.firebasestorage.app",
            messagingSenderId: "515333523928",
            appId: "1:515333523928:web:e19a9db63c522d8484caad",
            measurementId: "G-CG28CTJNXP"
        };

        // Firebase ì•± ì´ˆê¸°í™”
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        console.log('ğŸ”¥ Firebase ì´ˆê¸°í™” ì™„ë£Œ! (ì•ì„ ì¼€ì–´)');

        // ==================== ë¡œê·¸ì¸ ìƒíƒœ ì²´í¬ ====================
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                console.log('ì´ë¯¸ ë¡œê·¸ì¸ë¨:', user.email);
                await redirectToDashboard(user.uid);
            }
        });

        // ==================== ë¡œê·¸ì¸ ì²˜ë¦¬ ====================
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const email = document.getElementById('emailInput').value.trim();
            const password = document.getElementById('passwordInput').value;
            const rememberMe = document.getElementById('rememberMe').checked;

            if (!email || !password) {
                showError('ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            showLoading('ë¡œê·¸ì¸ ì¤‘...');
            hideError();

            try {
                const persistence = rememberMe 
                    ? firebase.auth.Auth.Persistence.LOCAL 
                    : firebase.auth.Auth.Persistence.SESSION;
                
                await auth.setPersistence(persistence);
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                const user = userCredential.user;

                console.log('âœ… ë¡œê·¸ì¸ ì„±ê³µ:', user.email);
                await redirectToDashboard(user.uid);

            } catch (error) {
                hideLoading();
                console.error('ë¡œê·¸ì¸ ì˜¤ë¥˜:', error);

                let errorMsg = 'ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
                switch (error.code) {
                    case 'auth/user-not-found':
                        errorMsg = 'ë“±ë¡ë˜ì§€ ì•Šì€ ì´ë©”ì¼ì…ë‹ˆë‹¤.';
                        break;
                    case 'auth/wrong-password':
                        errorMsg = 'ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.';
                        break;
                    case 'auth/invalid-email':
                        errorMsg = 'ì˜¬ë°”ë¥¸ ì´ë©”ì¼ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.';
                        break;
                    case 'auth/too-many-requests':
                        errorMsg = 'ë„ˆë¬´ ë§ì€ ì‹œë„ê°€ ìˆì—ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
                        break;
                    case 'auth/invalid-credential':
                        errorMsg = 'ì´ë©”ì¼ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.';
                        break;
                }
                showError(errorMsg);
            }
        });

        // ==================== ëŒ€ì‹œë³´ë“œ ë¦¬ë‹¤ì´ë ‰íŠ¸ ====================
        async function redirectToDashboard(uid) {
            try {
                const userDoc = await db.collection('users').doc(uid).get();

                if (userDoc.exists) {
                    const userData = userDoc.data();
                    
                    sessionStorage.setItem('apsencare_user', JSON.stringify({
                        uid: uid,
                        email: userData.email,
                        name: userData.name,
                        hospitalId: userData.hospitalId,
                        userType: userData.userType
                    }));

                    hideLoading();
                    showToast('ë¡œê·¸ì¸ ì„±ê³µ! í™˜ì˜í•©ë‹ˆë‹¤ ğŸ‰', 'success');

                    setTimeout(() => {
                        if (userData.userType === 'admin') {
                            window.location.href = 'apsencare_admin_firebase.html';
                        } else {
                            window.location.href = 'apsencare_hospital_home_firebase.html';
                        }
                    }, 1000);
                } else {
                    hideLoading();
                    showError('ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.');
                    await auth.signOut();
                }
            } catch (error) {
                hideLoading();
                console.error('ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ ì˜¤ë¥˜:', error);
                showError('ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ==================== ì´ˆëŒ€ì½”ë“œ ì²˜ë¦¬ ====================
        async function handleInviteCode() {
            const code = document.getElementById('inviteCodeInput').value.trim().toUpperCase();

            if (!code) {
                showToast('ì´ˆëŒ€ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            if (code.length < 4) {
                showToast('ì˜¬ë°”ë¥¸ ì´ˆëŒ€ì½”ë“œ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.', 'error');
                return;
            }

            showLoading('ì´ˆëŒ€ì½”ë“œ í™•ì¸ ì¤‘...');

            try {
                // ì¸ë±ìŠ¤ ì—†ì´ ì‘ë™í•˜ë„ë¡ codeë§Œìœ¼ë¡œ ê²€ìƒ‰
                const codeQuery = await db.collection('inviteCodes')
                    .where('code', '==', code)
                    .limit(1)
                    .get();

                if (codeQuery.empty) {
                    hideLoading();
                    showToast('ìœ íš¨í•˜ì§€ ì•Šì€ ì´ˆëŒ€ì½”ë“œì…ë‹ˆë‹¤.', 'error');
                    return;
                }

                const codeDoc = codeQuery.docs[0];
                const codeData = codeDoc.data();

                // ì‚¬ìš© ì—¬ë¶€ ì²´í¬ (í´ë¼ì´ì–¸íŠ¸ì—ì„œ)
                if (codeData.used === true) {
                    hideLoading();
                    showToast('ì´ë¯¸ ì‚¬ìš©ëœ ì´ˆëŒ€ì½”ë“œì…ë‹ˆë‹¤.', 'error');
                    return;
                }

                // ë§Œë£Œì¼ ì²´í¬
                if (codeData.expiresAt && codeData.expiresAt.toDate() < new Date()) {
                    hideLoading();
                    showToast('ë§Œë£Œëœ ì´ˆëŒ€ì½”ë“œì…ë‹ˆë‹¤.', 'error');
                    return;
                }

                hideLoading();

                console.log('ğŸ“‹ ì´ˆëŒ€ì½”ë“œ ë°ì´í„°:', codeData);

                sessionStorage.setItem('apsencare_invite', JSON.stringify({
                    codeId: codeDoc.id,
                    code: code,
                    hospitalId: codeData.hospitalId || codeData.hospital_id || '',
                    hospitalName: codeData.hospitalName || codeData.hospital_name || ''
                }));

                showToast('ì´ˆëŒ€ì½”ë“œ í™•ì¸ ì™„ë£Œ! íšŒì›ê°€ì…ì„ ì§„í–‰í•©ë‹ˆë‹¤.', 'success');
                
                setTimeout(() => {
                    window.location.href = 'apsencare_signup_firebase.html';
                }, 1000);

            } catch (error) {
                hideLoading();
                console.error('ì´ˆëŒ€ì½”ë“œ í™•ì¸ ì˜¤ë¥˜:', error);
                showToast('ì´ˆëŒ€ì½”ë“œ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // ì´ˆëŒ€ì½”ë“œ ì…ë ¥ ìë™ í¬ë§·íŒ…
        document.getElementById('inviteCodeInput').addEventListener('input', function(e) {
            let value = e.target.value.replace(/[^A-Za-z0-9]/g, '').toUpperCase();
            if (value.length > 4) {
                value = value.slice(0, 4) + '-' + value.slice(4, 8);
            }
            e.target.value = value;
        });

        // ==================== ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸° ====================
        async function handleForgotPassword(e) {
            e.preventDefault();
            
            const email = document.getElementById('emailInput').value.trim();
            
            if (!email) {
                showToast('ì´ë©”ì¼ì„ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.', 'info');
                document.getElementById('emailInput').focus();
                return;
            }

            showLoading('ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ì´ë©”ì¼ ë°œì†¡ ì¤‘...');

            try {
                await auth.sendPasswordResetEmail(email);
                hideLoading();
                showToast('ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ì´ë©”ì¼ì„ ë°œì†¡í–ˆìŠµë‹ˆë‹¤. ğŸ“§', 'success');
            } catch (error) {
                hideLoading();
                if (error.code === 'auth/user-not-found') {
                    showToast('ë“±ë¡ë˜ì§€ ì•Šì€ ì´ë©”ì¼ì…ë‹ˆë‹¤.', 'error');
                } else {
                    showToast('ì´ë©”ì¼ ë°œì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
                }
            }
        }

        // ==================== ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ====================
        function togglePassword() {
            const input = document.getElementById('passwordInput');
            const btn = event.target;
            if (input.type === 'password') {
                input.type = 'text';
                btn.textContent = 'ğŸ™ˆ';
            } else {
                input.type = 'password';
                btn.textContent = 'ğŸ‘ï¸';
            }
        }

        function showLoading(text) {
            document.getElementById('loadingText').textContent = text;
            document.getElementById('loadingOverlay').classList.add('show');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('show');
        }

        function showError(message) {
            const errorEl = document.getElementById('errorMessage');
            errorEl.textContent = message;
            errorEl.classList.add('show');
        }

        function hideError() {
            document.getElementById('errorMessage').classList.remove('show');
        }

        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast ' + type + ' show';
            setTimeout(() => toast.classList.remove('show'), 3500);
        }

        document.getElementById('inviteCodeInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                handleInviteCode();
            }
        });
    </script>
</body>
</html>
