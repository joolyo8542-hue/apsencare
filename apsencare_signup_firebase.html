<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì•ì„ ì¼€ì–´ - íšŒì›ê°€ì…</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK (compat ë²„ì „ - ì•ˆì •ì ì¸ 9.x) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', 'Noto Sans KR', sans-serif; background: linear-gradient(135deg, #fdf2f8 0%, #fce7f3 100%); min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 40px 20px; }

        .signup-container {
            background: white;
            border-radius: 24px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 480px;
            padding: 48px;
        }

        .signup-header { text-align: center; margin-bottom: 32px; }
        .logo { display: flex; align-items: center; justify-content: center; gap: 12px; margin-bottom: 24px; }
        .logo-circle { width: 56px; height: 56px; background: linear-gradient(135deg, #fce7f3, #fbcfe8); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 28px; border: 3px solid #ec4899; }
        .logo-text-group { text-align: left; }
        .logo-main { font-family: 'Noto Sans KR', sans-serif; font-size: 24px; font-weight: 700; color: #1f2937; }
        .logo-sub { font-size: 11px; color: #ec4899; font-weight: 600; text-transform: uppercase; }

        .signup-title { font-size: 24px; font-weight: 700; color: #1f2937; margin-bottom: 8px; }
        .signup-desc { font-size: 14px; color: #6b7280; }

        /* ì´ˆëŒ€ì½”ë“œ ë°°ì§€ */
        .invite-badge {
            background: linear-gradient(135deg, #fdf2f8, #fce7f3);
            border: 2px solid #fbcfe8;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 24px;
            text-align: center;
        }
        .invite-badge-label { font-size: 12px; color: #6b7280; margin-bottom: 4px; }
        .invite-badge-code { font-size: 20px; font-weight: 700; color: #ec4899; letter-spacing: 3px; }
        .invite-badge-hospital { font-size: 13px; color: #374151; margin-top: 8px; }

        /* í¼ */
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 8px; }
        .form-label .required { color: #ef4444; }
        .input-wrapper { position: relative; }
        .form-input {
            width: 100%;
            padding: 14px 16px;
            border: 1.5px solid #e5e7eb;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.2s;
            background: #f9fafb;
        }
        .form-input:focus { outline: none; border-color: #ec4899; background: white; box-shadow: 0 0 0 3px rgba(236, 72, 153, 0.1); }
        .form-input.error { border-color: #ef4444; }
        .form-input.success { border-color: #10b981; }
        .form-hint { font-size: 11px; color: #6b7280; margin-top: 6px; }
        .form-hint.error { color: #ef4444; }
        .form-hint.success { color: #10b981; }

        .password-toggle { position: absolute; right: 14px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; font-size: 16px; }

        /* ë¹„ë°€ë²ˆí˜¸ ê°•ë„ */
        .password-strength { margin-top: 8px; }
        .strength-bar { height: 4px; background: #e5e7eb; border-radius: 2px; overflow: hidden; }
        .strength-fill { height: 100%; transition: all 0.3s; width: 0%; }
        .strength-fill.weak { width: 33%; background: #ef4444; }
        .strength-fill.medium { width: 66%; background: #f59e0b; }
        .strength-fill.strong { width: 100%; background: #10b981; }
        .strength-text { font-size: 11px; margin-top: 4px; }

        /* ì•½ê´€ */
        .terms-section { margin: 24px 0; }
        .terms-check { display: flex; align-items: flex-start; gap: 10px; margin-bottom: 12px; }
        .terms-check input { margin-top: 2px; accent-color: #ec4899; width: 18px; height: 18px; }
        .terms-check label { font-size: 13px; color: #374151; line-height: 1.5; }
        .terms-check a { color: #ec4899; text-decoration: none; }
        .terms-check a:hover { text-decoration: underline; }

        /* ë²„íŠ¼ */
        .signup-button {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #f472b6, #ec4899);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .signup-button:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(236, 72, 153, 0.3); }
        .signup-button:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

        .login-link { text-align: center; margin-top: 24px; font-size: 14px; color: #6b7280; }
        .login-link a { color: #ec4899; text-decoration: none; font-weight: 600; }

        /* ì—ëŸ¬ ë©”ì‹œì§€ */
        .error-message {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 13px;
            margin-bottom: 20px;
            display: none;
        }
        .error-message.show { display: block; }

        /* ë¡œë”© & í† ìŠ¤íŠ¸ */
        .loading-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.9); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; opacity: 0; visibility: hidden; transition: all 0.3s; }
        .loading-overlay.show { opacity: 1; visibility: visible; }
        .loading-spinner { width: 48px; height: 48px; border: 4px solid #fce7f3; border-top-color: #ec4899; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 16px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { color: #6b7280; font-size: 14px; }

        .toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(100px); padding: 14px 28px; border-radius: 10px; font-size: 14px; font-weight: 500; z-index: 9999; opacity: 0; transition: all 0.3s ease; }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        .toast.success { background: #10b981; color: white; }
        .toast.error { background: #ef4444; color: white; }

        /* ë°˜ì‘í˜• */
        @media (max-width: 520px) {
            .signup-container { padding: 32px 24px; }
            .terms-modal { margin: 20px; max-height: 90vh; }
        }

        /* ì•½ê´€ êµ¬ë¶„ì„  */
        .terms-divider { height: 1px; background: #e5e7eb; margin: 8px 0 12px 0; }
        .terms-all-wrap label { font-size: 14px; }

        /* ë°ì´í„° í™œìš© ë™ì˜ í•˜ì´ë¼ì´íŠ¸ */
        .data-consent-check { 
            background: linear-gradient(135deg, #fdf2f8, #fef3c7);
            padding: 10px 12px;
            border-radius: 10px;
            border: 1.5px solid #fbcfe8;
            margin-top: 4px;
        }
        .data-consent-check label { font-weight: 500; }
        .data-consent-summary {
            font-size: 11.5px;
            color: #6b7280;
            background: #f9fafb;
            padding: 10px 14px;
            border-radius: 8px;
            margin-top: 6px;
            line-height: 1.6;
        }
        .data-consent-summary a { color: #ec4899; text-decoration: none; font-weight: 500; }
        .data-consent-summary a:hover { text-decoration: underline; }

        /* ì•½ê´€ ëª¨ë‹¬ */
        .terms-modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex; align-items: center; justify-content: center;
            z-index: 10000;
            opacity: 0; visibility: hidden;
            transition: all 0.3s;
        }
        .terms-modal-overlay.show { opacity: 1; visibility: visible; }
        .terms-modal {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 520px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
            transform: translateY(30px);
            transition: transform 0.3s;
        }
        .terms-modal-overlay.show .terms-modal { transform: translateY(0); }
        .terms-modal-header {
            display: flex; align-items: center; justify-content: space-between;
            padding: 20px 24px;
            border-bottom: 1px solid #e5e7eb;
        }
        .terms-modal-header h3 { font-size: 17px; font-weight: 700; color: #1f2937; }
        .terms-modal-close {
            width: 32px; height: 32px;
            background: #f3f4f6; border: none; border-radius: 8px;
            font-size: 16px; cursor: pointer; color: #6b7280;
            display: flex; align-items: center; justify-content: center;
        }
        .terms-modal-close:hover { background: #e5e7eb; }
        .terms-modal-body {
            padding: 24px;
            overflow-y: auto;
            font-size: 13px;
            color: #374151;
            line-height: 1.8;
            flex: 1;
        }
        .terms-modal-body h4 { font-size: 14px; font-weight: 700; color: #1f2937; margin: 16px 0 8px 0; }
        .terms-modal-body h4:first-child { margin-top: 0; }
        .terms-modal-body .highlight-box {
            background: #fdf2f8;
            border: 1px solid #fbcfe8;
            border-radius: 10px;
            padding: 14px 16px;
            margin: 12px 0;
        }
        .terms-modal-body .highlight-box li {
            margin-bottom: 6px;
            padding-left: 4px;
        }
        .terms-modal-body ul { padding-left: 20px; }
        .terms-modal-body li { margin-bottom: 4px; }
        .terms-modal-footer {
            padding: 16px 24px;
            border-top: 1px solid #e5e7eb;
        }
        .terms-modal-agree {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #f472b6, #ec4899);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .terms-modal-agree:hover { transform: translateY(-1px); box-shadow: 0 4px 15px rgba(236,72,153,0.3); }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">ì²˜ë¦¬ ì¤‘...</div>
    </div>
    <div class="toast" id="toast"></div>

    <div class="signup-container">
        <div class="signup-header">
            <div class="logo">
                <div class="logo-circle">ğŸ¦·</div>
                <div class="logo-text-group">
                    <div class="logo-main">ì•ì„ ì¼€ì–´</div>
                    <div class="logo-sub">Advanced Care Platform</div>
                </div>
            </div>
            <h1 class="signup-title">íšŒì›ê°€ì… âœ¨</h1>
            <p class="signup-desc">ì•ì„ ì¼€ì–´ íŒŒíŠ¸ë„ˆë¡œ í•¨ê»˜í•´ì£¼ì„¸ìš”</p>
        </div>

        <!-- ì´ˆëŒ€ì½”ë“œ ë°°ì§€ -->
        <div class="invite-badge" id="inviteBadge">
            <div class="invite-badge-label">ì´ˆëŒ€ì½”ë“œ</div>
            <div class="invite-badge-code" id="displayCode">-</div>
            <div class="invite-badge-hospital" id="displayHospital"></div>
        </div>

        <div class="error-message" id="errorMessage"></div>

        <form id="signupForm">
            <div class="form-group">
                <label class="form-label">ë³‘ì›ì´ë¦„ <span class="required">*</span></label>
                <input type="text" class="form-input" id="nameInput" placeholder="OOì¹˜ê³¼ì˜ì›" required>
            </div>

            <div class="form-group">
                <label class="form-label">ì´ë©”ì¼ <span class="required">*</span></label>
                <input type="email" class="form-input" id="emailInput" placeholder="example@hospital.com" required>
                <div class="form-hint" id="emailHint"></div>
            </div>

            <div class="form-group">
                <label class="form-label">ë¹„ë°€ë²ˆí˜¸ <span class="required">*</span></label>
                <div class="input-wrapper">
                    <input type="password" class="form-input" id="passwordInput" placeholder="8ì ì´ìƒ, ì˜ë¬¸+ìˆ«ì ì¡°í•©" required>
                    <button type="button" class="password-toggle" onclick="togglePassword('passwordInput')">ğŸ‘ï¸</button>
                </div>
                <div class="password-strength">
                    <div class="strength-bar"><div class="strength-fill" id="strengthFill"></div></div>
                    <div class="strength-text" id="strengthText"></div>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">ë¹„ë°€ë²ˆí˜¸ í™•ì¸ <span class="required">*</span></label>
                <div class="input-wrapper">
                    <input type="password" class="form-input" id="passwordConfirmInput" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ë‹¤ì‹œ ì…ë ¥í•˜ì„¸ìš”" required>
                    <button type="button" class="password-toggle" onclick="togglePassword('passwordConfirmInput')">ğŸ‘ï¸</button>
                </div>
                <div class="form-hint" id="confirmHint"></div>
            </div>

            <div class="form-group">
                <label class="form-label">ì „í™”ë²ˆí˜¸</label>
                <input type="tel" class="form-input" id="phoneInput" placeholder="010-0000-0000">
            </div>

            <div class="form-group">
                <label class="form-label">ì˜ˆë°©ê³¼ ë„ì…ì‹œê¸° <span class="required">*</span></label>
                <input type="month" class="form-input" id="preventionStartInput" required style="color:#374151;">
                <div class="form-hint">ì˜ˆë°©ê³¼ë¥¼ ë„ì…í•œ ì—°ë„ì™€ ì›”ì„ ì„ íƒí•´ì£¼ì„¸ìš”</div>
            </div>

            <div class="terms-section">
                <div class="terms-check terms-all-wrap">
                    <input type="checkbox" id="termsAll" onchange="toggleAllTerms()">
                    <label for="termsAll"><strong>ì „ì²´ ë™ì˜</strong></label>
                </div>
                <div class="terms-divider"></div>
                <div class="terms-check">
                    <input type="checkbox" id="terms1" class="term-item" required>
                    <label for="terms1">[í•„ìˆ˜] <a href="#" onclick="openTermsModal('service'); return false;">ì´ìš©ì•½ê´€</a>ì— ë™ì˜í•©ë‹ˆë‹¤</label>
                </div>
                <div class="terms-check">
                    <input type="checkbox" id="terms2" class="term-item" required>
                    <label for="terms2">[í•„ìˆ˜] <a href="#" onclick="openTermsModal('privacy'); return false;">ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨</a>ì— ë™ì˜í•©ë‹ˆë‹¤</label>
                </div>
                <div class="terms-check data-consent-check">
                    <input type="checkbox" id="terms3" class="term-item" required>
                    <label for="terms3">[í•„ìˆ˜] <a href="#" onclick="openTermsModal('data'); return false;">í†µê³„ ë°ì´í„° í•™ìˆ ì—°êµ¬ í™œìš©</a>ì— ë™ì˜í•©ë‹ˆë‹¤</label>
                </div>
                <div class="data-consent-summary">
                    ğŸ“Š ì—…ë¡œë“œëœ ìë£Œì—ì„œ ê°œì¸ì‹ë³„ì´ ë¶ˆê°€ëŠ¥í•œ í†µê³„ ê²°ê³¼ê°’(ìœ ì§€ìœ¨, ì´íƒˆìœ¨ ë“±)ë§Œ ìˆ˜ì§‘ë˜ë©°, í•™ìˆ  ì—°êµ¬ ë° ë¹„ì˜ë¦¬ ëª©ì ìœ¼ë¡œë§Œ í™œìš©ë©ë‹ˆë‹¤. <a href="#" onclick="openTermsModal('data'); return false;">ìì„¸íˆ ë³´ê¸° â†’</a>
                </div>
            </div>

            <!-- ì•½ê´€ ìƒì„¸ë³´ê¸° ëª¨ë‹¬ -->
            <div class="terms-modal-overlay" id="termsModalOverlay" onclick="closeTermsModal()">
                <div class="terms-modal" onclick="event.stopPropagation()">
                    <div class="terms-modal-header">
                        <h3 id="termsModalTitle">ì•½ê´€</h3>
                        <button class="terms-modal-close" onclick="closeTermsModal()">âœ•</button>
                    </div>
                    <div class="terms-modal-body" id="termsModalBody"></div>
                    <div class="terms-modal-footer">
                        <button class="terms-modal-agree" id="termsModalAgreeBtn" onclick="agreeAndClose()">ë™ì˜í•˜ê¸°</button>
                    </div>
                </div>
            </div>

            <button type="submit" class="signup-button" id="signupBtn">ê°€ì…í•˜ê¸°</button>
        </form>

        <p class="login-link">
            ì´ë¯¸ ê³„ì •ì´ ìˆìœ¼ì‹ ê°€ìš”? <a href="apsencare_login_firebase.html">ë¡œê·¸ì¸</a>
        </p>
    </div>

    <script>
        // ==================== Firebase ì´ˆê¸°í™” ====================
        const firebaseConfig = {
            apiKey: "AIzaSyDrU3rYs4fxlMkr8r0sjo70Mt0Al-HUtyg",
            authDomain: "apseoncare-platform.firebaseapp.com",
            projectId: "apseoncare-platform",
            storageBucket: "apseoncare-platform.firebasestorage.app",
            messagingSenderId: "515333523928",
            appId: "1:515333523928:web:e19a9db63c522d8484caad"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        console.log('ğŸ”¥ Firebase ì´ˆê¸°í™” ì™„ë£Œ!');

        // ==================== ì´ˆëŒ€ì½”ë“œ ì •ë³´ ë¡œë“œ ====================
        let inviteData = null;

        document.addEventListener('DOMContentLoaded', function() {
            const inviteStr = sessionStorage.getItem('apsencare_invite');
            
            if (!inviteStr) {
                showToast('ì´ˆëŒ€ì½”ë“œê°€ í•„ìš”í•©ë‹ˆë‹¤. ë¡œê·¸ì¸ í˜ì´ì§€ì—ì„œ ì´ˆëŒ€ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                setTimeout(() => {
                    window.location.href = 'apsencare_login_firebase.html';
                }, 2000);
                return;
            }

            inviteData = JSON.parse(inviteStr);
            document.getElementById('displayCode').textContent = inviteData.code;
            
            if (inviteData.hospitalName) {
                document.getElementById('displayHospital').textContent = 'ğŸ¥ ' + inviteData.hospitalName;
            }
        });

        // ==================== íšŒì›ê°€ì… ì²˜ë¦¬ ====================
        document.getElementById('signupForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const name = document.getElementById('nameInput').value.trim();
            const email = document.getElementById('emailInput').value.trim();
            const password = document.getElementById('passwordInput').value;
            const passwordConfirm = document.getElementById('passwordConfirmInput').value;
            const phone = document.getElementById('phoneInput').value.trim();
            const preventionStart = document.getElementById('preventionStartInput').value;

            // ìœ íš¨ì„± ê²€ì‚¬
            if (!name || !email || !password) {
                showError('í•„ìˆ˜ í•­ëª©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            if (!preventionStart) {
                showError('ì˜ˆë°©ê³¼ ë„ì…ì‹œê¸°ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            if (password !== passwordConfirm) {
                showError('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                return;
            }

            if (password.length < 8) {
                showError('ë¹„ë°€ë²ˆí˜¸ëŠ” 8ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
                return;
            }

            if (!document.getElementById('terms1').checked || !document.getElementById('terms2').checked || !document.getElementById('terms3').checked) {
                showError('í•„ìˆ˜ ì•½ê´€ì— ëª¨ë‘ ë™ì˜í•´ì£¼ì„¸ìš”.');
                return;
            }

            if (!inviteData) {
                showError('ì´ˆëŒ€ì½”ë“œ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            showLoading('ê³„ì • ìƒì„± ì¤‘...');
            hideError();

            try {
                // 1. Firebase Auth ê³„ì • ìƒì„±
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;

                console.log('âœ… Auth ê³„ì • ìƒì„± ì™„ë£Œ:', user.uid);

                // 2. Firestoreì— ì‚¬ìš©ì ì •ë³´ ì €ì¥
                try {
                    await db.collection('users').doc(user.uid).set({
                        email: email,
                        name: name,
                        phone: phone || '',
                        hospitalId: inviteData.hospitalId || 'unknown',
                        hospitalName: inviteData.hospitalName || '',
                        userType: 'hospital',
                        inviteCode: inviteData.code || '',
                        preventionStart: preventionStart,
                        // ì•½ê´€ ë™ì˜ ì •ë³´
                        consent: {
                            serviceTerms: true,
                            privacyPolicy: true,
                            dataResearchUsage: true,
                            consentVersion: '1.0',
                            consentDate: new Date().toISOString()
                        },
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    console.log('âœ… Firestore ì‚¬ìš©ì ë¬¸ì„œ ìƒì„± ì™„ë£Œ');
                } catch (firestoreError) {
                    console.error('âŒ Firestore users ì €ì¥ ì‹¤íŒ¨:', firestoreError);
                    throw firestoreError;
                }

                // 3. hospitals ì»¬ë ‰ì…˜ì— ì˜ˆë°©ê³¼ ë„ì…ì‹œê¸° ì €ì¥
                try {
                    const hospitalId = inviteData.hospitalId || 'unknown';
                    await db.collection('hospitals').doc(hospitalId).update({
                        preventionStart: preventionStart
                    });
                    console.log('âœ… ë³‘ì› ì˜ˆë°©ê³¼ ë„ì…ì‹œê¸° ì €ì¥ ì™„ë£Œ');
                } catch (hospitalError) {
                    console.error('âŒ ë³‘ì› ì˜ˆë°©ê³¼ ë„ì…ì‹œê¸° ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', hospitalError);
                    // ì‹¤íŒ¨í•´ë„ ê³„ì† ì§„í–‰
                }

                // 4. ì´ˆëŒ€ì½”ë“œ ì‚¬ìš© ì²˜ë¦¬
                try {
                    await db.collection('inviteCodes').doc(inviteData.codeId).update({
                        used: true,
                        usedBy: user.uid,
                        usedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    console.log('âœ… ì´ˆëŒ€ì½”ë“œ ì‚¬ìš© ì²˜ë¦¬ ì™„ë£Œ');
                } catch (inviteError) {
                    console.error('âŒ ì´ˆëŒ€ì½”ë“œ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', inviteError);
                    // ì´ˆëŒ€ì½”ë“œ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨í•´ë„ ê³„ì† ì§„í–‰
                }

                // 5. ì„¸ì…˜ ì •ë¦¬
                sessionStorage.removeItem('apsencare_invite');

                hideLoading();
                showToast('íšŒì›ê°€ì… ì™„ë£Œ! ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤ ğŸ‰', 'success');

                // ë¡œê·¸ì•„ì›ƒ í›„ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™ (ì²« ë¡œê·¸ì¸ì€ ì§ì ‘ í•˜ë„ë¡)
                await auth.signOut();
                
                setTimeout(() => {
                    window.location.href = 'apsencare_login_firebase.html';
                }, 2000);

            } catch (error) {
                hideLoading();
                console.error('íšŒì›ê°€ì… ì˜¤ë¥˜:', error);

                let errorMsg = 'íšŒì›ê°€ì…ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
                switch (error.code) {
                    case 'auth/email-already-in-use':
                        errorMsg = 'ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì´ë©”ì¼ì…ë‹ˆë‹¤.';
                        break;
                    case 'auth/invalid-email':
                        errorMsg = 'ì˜¬ë°”ë¥¸ ì´ë©”ì¼ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.';
                        break;
                    case 'auth/weak-password':
                        errorMsg = 'ë¹„ë°€ë²ˆí˜¸ê°€ ë„ˆë¬´ ì•½í•©ë‹ˆë‹¤. 8ì ì´ìƒìœ¼ë¡œ ì„¤ì •í•´ì£¼ì„¸ìš”.';
                        break;
                }
                showError(errorMsg);
            }
        });

        // ==================== ë¹„ë°€ë²ˆí˜¸ ê°•ë„ ì²´í¬ ====================
        document.getElementById('passwordInput').addEventListener('input', function(e) {
            const password = e.target.value;
            const fill = document.getElementById('strengthFill');
            const text = document.getElementById('strengthText');

            fill.className = 'strength-fill';
            
            if (password.length === 0) {
                text.textContent = '';
                return;
            }

            let strength = 0;
            if (password.length >= 8) strength++;
            if (/[A-Z]/.test(password)) strength++;
            if (/[0-9]/.test(password)) strength++;
            if (/[^A-Za-z0-9]/.test(password)) strength++;

            if (strength <= 1) {
                fill.classList.add('weak');
                text.textContent = 'ì•½í•¨';
                text.style.color = '#ef4444';
            } else if (strength <= 2) {
                fill.classList.add('medium');
                text.textContent = 'ë³´í†µ';
                text.style.color = '#f59e0b';
            } else {
                fill.classList.add('strong');
                text.textContent = 'ê°•í•¨';
                text.style.color = '#10b981';
            }
        });

        // ë¹„ë°€ë²ˆí˜¸ í™•ì¸ ì²´í¬
        document.getElementById('passwordConfirmInput').addEventListener('input', function(e) {
            const password = document.getElementById('passwordInput').value;
            const confirm = e.target.value;
            const hint = document.getElementById('confirmHint');

            if (confirm.length === 0) {
                hint.textContent = '';
                e.target.classList.remove('success', 'error');
                return;
            }

            if (password === confirm) {
                hint.textContent = 'âœ“ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•©ë‹ˆë‹¤';
                hint.className = 'form-hint success';
                e.target.classList.add('success');
                e.target.classList.remove('error');
            } else {
                hint.textContent = 'âœ— ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤';
                hint.className = 'form-hint error';
                e.target.classList.add('error');
                e.target.classList.remove('success');
            }
        });

        // ==================== ì „í™”ë²ˆí˜¸ ìë™ í¬ë§· ====================
        document.getElementById('phoneInput').addEventListener('input', function(e) {
            let value = e.target.value.replace(/[^0-9]/g, '');
            if (value.length > 3 && value.length <= 7) {
                value = value.slice(0, 3) + '-' + value.slice(3);
            } else if (value.length > 7) {
                value = value.slice(0, 3) + '-' + value.slice(3, 7) + '-' + value.slice(7, 11);
            }
            e.target.value = value;
        });

        // ==================== ì•½ê´€ ì „ì²´ ë™ì˜ ====================
        function toggleAllTerms() {
            const allChecked = document.getElementById('termsAll').checked;
            document.querySelectorAll('.term-item').forEach(item => {
                item.checked = allChecked;
            });
        }

        document.querySelectorAll('.term-item').forEach(item => {
            item.addEventListener('change', function() {
                const allChecked = Array.from(document.querySelectorAll('.term-item')).every(i => i.checked);
                document.getElementById('termsAll').checked = allChecked;
            });
        });

        // ==================== ì•½ê´€ ëª¨ë‹¬ ====================
        let currentTermsType = null;

        const termsContent = {
            service: {
                title: 'ğŸ“‹ ì„œë¹„ìŠ¤ ì´ìš©ì•½ê´€',
                body: `
                    <h4>ì œ1ì¡° (ëª©ì )</h4>
                    <p>ì´ ì•½ê´€ì€ ì•ì„ ì¼€ì–´(ì´í•˜ "ì„œë¹„ìŠ¤")ê°€ ì œê³µí•˜ëŠ” ì¹˜ê³¼ ê²½ì˜ë¶„ì„ ì„œë¹„ìŠ¤ì˜ ì´ìš©ì¡°ê±´ ë° ì ˆì°¨, ì´ìš©ìì™€ ì„œë¹„ìŠ¤ ì œê³µìì˜ ê¶Œë¦¬Â·ì˜ë¬´Â·ì±…ì„ì‚¬í•­ì„ ê·œì •í•¨ì„ ëª©ì ìœ¼ë¡œ í•©ë‹ˆë‹¤.</p>
                    
                    <h4>ì œ2ì¡° (ì„œë¹„ìŠ¤ ë‚´ìš©)</h4>
                    <p>ì„œë¹„ìŠ¤ëŠ” ì¹˜ê³¼ë³‘(ì˜)ì›ì˜ ì§„ë£Œ ë°ì´í„°ë¥¼ ë¶„ì„í•˜ì—¬ í™˜ì ìœ ì§€ìœ¨, ì´íƒˆìœ¨, ìˆ˜ë‚©ì„±ì¥ë¥  ë“±ì˜ ê²½ì˜ ì§€í‘œë¥¼ ì œê³µí•©ë‹ˆë‹¤. ë¶„ì„ì€ ì‚¬ìš©ìê°€ ì—…ë¡œë“œí•œ ì—‘ì…€ íŒŒì¼ì„ ê¸°ë°˜ìœ¼ë¡œ ë¸Œë¼ìš°ì € ë‚´ì—ì„œ ì²˜ë¦¬ë©ë‹ˆë‹¤.</p>
                    
                    <h4>ì œ3ì¡° (íšŒì›ê°€ì… ë° ì´ìš©)</h4>
                    <p>ì„œë¹„ìŠ¤ ì´ìš©ì„ ìœ„í•´ ì´ˆëŒ€ì½”ë“œë¥¼ í†µí•œ íšŒì›ê°€ì…ì´ í•„ìš”í•©ë‹ˆë‹¤. íšŒì›ì€ ì •í™•í•œ ì •ë³´ë¥¼ ì œê³µí•´ì•¼ í•˜ë©°, íƒ€ì¸ì˜ ê³„ì •ì„ ë„ìš©í•˜ê±°ë‚˜ í—ˆìœ„ ì •ë³´ë¥¼ ë“±ë¡í•´ì„œëŠ” ì•ˆ ë©ë‹ˆë‹¤.</p>
                    
                    <h4>ì œ4ì¡° (ì„œë¹„ìŠ¤ ì´ìš©ì˜ ì œí•œ)</h4>
                    <p>ì„œë¹„ìŠ¤ëŠ” ë‹¤ìŒì˜ ê²½ìš° ì´ìš©ì„ ì œí•œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤: íƒ€ì¸ì˜ ê°œì¸ì •ë³´ë¥¼ ë¬´ë‹¨ìœ¼ë¡œ ìˆ˜ì§‘Â·ì´ìš©í•˜ëŠ” ê²½ìš°, ì„œë¹„ìŠ¤ì˜ ì•ˆì •ì  ìš´ì˜ì„ ë°©í•´í•˜ëŠ” ê²½ìš°, ê¸°íƒ€ ê´€ë ¨ ë²•ë ¹ì— ìœ„ë°°ë˜ëŠ” í–‰ìœ„ë¥¼ í•˜ëŠ” ê²½ìš°.</p>
                    
                    <h4>ì œ5ì¡° (ë©´ì±…ì¡°í•­)</h4>
                    <p>ì„œë¹„ìŠ¤ê°€ ì œê³µí•˜ëŠ” ë¶„ì„ ê²°ê³¼ëŠ” ì°¸ê³ ìš©ì´ë©°, ì´ë¥¼ ê·¼ê±°ë¡œ í•œ ê²½ì˜ íŒë‹¨ì— ëŒ€í•œ ì±…ì„ì€ ì´ìš©ìì—ê²Œ ìˆìŠµë‹ˆë‹¤.</p>
                `
            },
            privacy: {
                title: 'ğŸ”’ ê°œì¸ì •ë³´ ì²˜ë¦¬ë°©ì¹¨',
                body: `
                    <h4>1. ìˆ˜ì§‘í•˜ëŠ” ê°œì¸ì •ë³´ í•­ëª©</h4>
                    <div class="highlight-box">
                        <ul>
                            <li><strong>í•„ìˆ˜:</strong> ì´ë©”ì¼, ë¹„ë°€ë²ˆí˜¸, ë³‘ì›ì´ë¦„</li>
                            <li><strong>ì„ íƒ:</strong> ì „í™”ë²ˆí˜¸</li>
                        </ul>
                    </div>
                    
                    <h4>2. ê°œì¸ì •ë³´ì˜ ìˆ˜ì§‘ ë° ì´ìš© ëª©ì </h4>
                    <p>íšŒì› ì‹ë³„ ë° ì„œë¹„ìŠ¤ ì œê³µ, ê³ ê° ì§€ì›, ì„œë¹„ìŠ¤ ê°œì„ ì„ ìœ„í•´ ìˆ˜ì§‘í•©ë‹ˆë‹¤.</p>
                    
                    <h4>3. í™˜ì ë°ì´í„° ì²˜ë¦¬ ë°©ì‹</h4>
                    <div class="highlight-box">
                        <ul>
                            <li>ì—…ë¡œë“œëœ ì—‘ì…€ íŒŒì¼ì€ <strong>ë¸Œë¼ìš°ì € ë‚´ì—ì„œë§Œ ì²˜ë¦¬</strong>ë˜ë©°, ì„œë²„ì— ì €ì¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</li>
                            <li>ë¶„ì„ ì™„ë£Œ í›„ ì›ë³¸ íŒŒì¼ì€ <strong>ì¦‰ì‹œ íê¸°</strong>ë©ë‹ˆë‹¤.</li>
                            <li>ì„œë²„ì—ëŠ” ê°œì¸ì„ ì‹ë³„í•  ìˆ˜ ì—†ëŠ” <strong>ì§‘ê³„ëœ í†µê³„ê°’ë§Œ ì €ì¥</strong>ë©ë‹ˆë‹¤.</li>
                        </ul>
                    </div>
                    
                    <h4>4. ê°œì¸ì •ë³´ì˜ ë³´ìœ  ë° ì´ìš©ê¸°ê°„</h4>
                    <p>íšŒì› íƒˆí‡´ ì‹œê¹Œì§€ ë³´ìœ í•˜ë©°, íƒˆí‡´ ì¦‰ì‹œ ì§€ì²´ ì—†ì´ íŒŒê¸°í•©ë‹ˆë‹¤.</p>
                    
                    <h4>5. ê°œì¸ì •ë³´ì˜ ì œ3ì ì œê³µ</h4>
                    <p>ì´ìš©ìì˜ ë™ì˜ ì—†ì´ ê°œì¸ì •ë³´ë¥¼ ì œ3ìì—ê²Œ ì œê³µí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
                `
            },
            data: {
                title: 'ğŸ“Š í†µê³„ ë°ì´í„° í•™ìˆ ì—°êµ¬ í™œìš© ë™ì˜',
                body: `
                    <h4>1. ìˆ˜ì§‘í•˜ëŠ” ë°ì´í„°ì˜ ë²”ìœ„</h4>
                    <div class="highlight-box">
                        <ul>
                            <li>ì—…ë¡œë“œëœ ìë£Œì—ì„œ ì‚°ì¶œëœ <strong>ê°œì¸ì‹ë³„ì´ ë¶ˆê°€ëŠ¥í•œ í†µê³„ ê²°ê³¼ê°’</strong>ë§Œ ìˆ˜ì§‘í•©ë‹ˆë‹¤.</li>
                            <li>ìˆ˜ì§‘ í•­ëª©: í™˜ì ìœ ì§€ìœ¨, ì´íƒˆìœ¨, ìˆ˜ë‚©ì„±ì¥ë¥ , ì§„ë£Œ ì¹´í…Œê³ ë¦¬ë³„ ë¹„ìœ¨ ë“±</li>
                            <li><strong>í™˜ì ì´ë¦„, ì°¨íŠ¸ë²ˆí˜¸ ë“± ê°œì¸ì •ë³´ëŠ” ì¼ì²´ ìˆ˜ì§‘í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</strong></li>
                        </ul>
                    </div>

                    <h4>2. ë°ì´í„° ì²˜ë¦¬ ë°©ì‹</h4>
                    <div class="highlight-box">
                        <ul>
                            <li>ì›ë³¸ ì—‘ì…€ íŒŒì¼ì€ ë¸Œë¼ìš°ì € ë‚´ì—ì„œë§Œ ì²˜ë¦¬ë˜ë©° ì„œë²„ì— ì €ì¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</li>
                            <li>ë¶„ì„ ê²°ê³¼ ì¤‘ í†µê³„ê°’ë§Œ ì•”í˜¸í™”ë˜ì–´ ì„œë²„ì— ì €ì¥ë©ë‹ˆë‹¤.</li>
                            <li>ì €ì¥ëœ í†µê³„ê°’ìœ¼ë¡œëŠ” ê°œë³„ í™˜ìë¥¼ ì‹ë³„í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</li>
                        </ul>
                    </div>

                    <h4>3. í™œìš© ëª©ì </h4>
                    <div class="highlight-box">
                        <ul>
                            <li>ìˆ˜ì§‘ëœ í†µê³„ ë°ì´í„°ëŠ” <strong>í•™ìˆ  ì—°êµ¬ ë° ë¹„ì˜ë¦¬ ëª©ì ìœ¼ë¡œë§Œ</strong> í™œìš©ë©ë‹ˆë‹¤.</li>
                            <li>ì¹˜ê³¼ ê²½ì˜, í™˜ì ê´€ë¦¬ ê°œì„  ë“± ì¹˜ì˜í•™ ë¶„ì•¼ ë°œì „ì„ ìœ„í•œ ì—°êµ¬ì— ì‚¬ìš©ë©ë‹ˆë‹¤.</li>
                            <li>ìƒì—…ì  ëª©ì ì˜ ë°ì´í„° íŒë§¤ë‚˜ ë§ˆì¼€íŒ…ì—ëŠ” ì ˆëŒ€ í™œìš©ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</li>
                        </ul>
                    </div>

                    <h4>4. ë³‘ì› ìµëª… ì²˜ë¦¬</h4>
                    <p>ì—°êµ¬ ê²°ê³¼ ë°œí‘œ ì‹œ ë³‘ì›ëª…ì€ <strong>Aë³‘ì›, Bë³‘ì› ë“±ìœ¼ë¡œ ìµëª… ì²˜ë¦¬</strong>ë˜ë©°, íŠ¹ì • ë³‘ì›ì„ ì‹ë³„í•  ìˆ˜ ìˆëŠ” ì •ë³´ëŠ” ê³µê°œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>

                    <h4>5. ë™ì˜ ì² íšŒ ê¶Œë¦¬</h4>
                    <div class="highlight-box">
                        <ul>
                            <li>ë™ì˜ëŠ” ì–¸ì œë“ ì§€ ì² íšŒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
                            <li>ì² íšŒ ìš”ì²­ ì‹œ í•´ë‹¹ ë³‘ì›ì˜ ë°ì´í„°ëŠ” ì´í›„ ë¶„ì„ì—ì„œ ì œì™¸ë©ë‹ˆë‹¤.</li>
                            <li>ë‹¨, ì´ë¯¸ ìµëª…í™”ë˜ì–´ ë°œí‘œëœ ì—°êµ¬ ê²°ê³¼ì—ì„œì˜ ì†Œê¸‰ ì œê±°ëŠ” ë¶ˆê°€ëŠ¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
                            <li>ì² íšŒ ìš”ì²­: ì•ì„ ì¼€ì–´ ê´€ë¦¬ìì—ê²Œ ì§ì ‘ ì—°ë½</li>
                        </ul>
                    </div>

                    <h4>6. ë°ì´í„° ë³´í˜¸</h4>
                    <p>ìˆ˜ì§‘ëœ í†µê³„ ë°ì´í„°ëŠ” ì ‘ê·¼ ê¶Œí•œì´ ì œí•œëœ ë³´ì•ˆ í™˜ê²½ì—ì„œ ê´€ë¦¬ë˜ë©°, ì—°êµ¬ ì±…ì„ìë§Œ ì ‘ê·¼ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
                `
            }
        };

        function openTermsModal(type) {
            currentTermsType = type;
            const content = termsContent[type];
            document.getElementById('termsModalTitle').textContent = content.title;
            document.getElementById('termsModalBody').innerHTML = content.body;
            document.getElementById('termsModalOverlay').classList.add('show');
            document.body.style.overflow = 'hidden';

            // ë™ì˜ ë²„íŠ¼ í…ìŠ¤íŠ¸ ì„¤ì •
            const checkboxMap = { service: 'terms1', privacy: 'terms2', data: 'terms3' };
            const isChecked = document.getElementById(checkboxMap[type]).checked;
            document.getElementById('termsModalAgreeBtn').textContent = isChecked ? 'í™•ì¸' : 'ë™ì˜í•˜ê¸°';
        }

        function closeTermsModal() {
            document.getElementById('termsModalOverlay').classList.remove('show');
            document.body.style.overflow = '';
            currentTermsType = null;
        }

        function agreeAndClose() {
            if (currentTermsType) {
                const checkboxMap = { service: 'terms1', privacy: 'terms2', data: 'terms3' };
                document.getElementById(checkboxMap[currentTermsType]).checked = true;
                // ì „ì²´ ë™ì˜ ìƒíƒœ ì—…ë°ì´íŠ¸
                const allChecked = Array.from(document.querySelectorAll('.term-item')).every(i => i.checked);
                document.getElementById('termsAll').checked = allChecked;
            }
            closeTermsModal();
        }

        // ==================== ìœ í‹¸ë¦¬í‹° ====================
        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            const btn = event.target;
            if (input.type === 'password') {
                input.type = 'text';
                btn.textContent = 'ğŸ™ˆ';
            } else {
                input.type = 'password';
                btn.textContent = 'ğŸ‘ï¸';
            }
        }

        function showLoading(text) {
            document.getElementById('loadingText').textContent = text;
            document.getElementById('loadingOverlay').classList.add('show');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('show');
        }

        function showError(message) {
            const el = document.getElementById('errorMessage');
            el.textContent = message;
            el.classList.add('show');
        }

        function hideError() {
            document.getElementById('errorMessage').classList.remove('show');
        }

        function showToast(message, type) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast ' + type + ' show';
            setTimeout(() => toast.classList.remove('show'), 3500);
        }
    </script>
</body>
</html>
