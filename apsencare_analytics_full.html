<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì•ì„ ì¼€ì–´ - ì„±ê³¼ ë¶„ì„</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', 'Noto Sans KR', sans-serif;
            background: #f9fafb;
            color: #1a1a1a;
            line-height: 1.6;
            font-size: 14px;
        }

        .app-layout { display: flex; min-height: 100vh; }

        /* ì‚¬ì´ë“œë°” */
        .sidebar {
            width: 260px; background: white; border-right: 1px solid #e5e7eb;
            display: flex; flex-direction: column; position: fixed; height: 100vh; z-index: 100;
        }
        .sidebar-header { padding: 20px; border-bottom: 1px solid #e5e7eb; }
        .logo { display: flex; align-items: center; gap: 10px; }
        .logo-circle { width: 40px; height: 40px; background: linear-gradient(135deg, #fce7f3, #fbcfe8); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; border: 2px solid #ec4899; }
        .logo-text-group { text-align: left; }
        .logo-main { font-size: 18px; font-weight: 700; color: #1f2937; }
        .logo-sub { font-size: 9px; color: #ec4899; font-weight: 600; text-transform: uppercase; }
        .sidebar-nav { flex: 1; padding: 16px 0; overflow-y: auto; }
        .nav-item { display: flex; align-items: center; gap: 12px; padding: 12px 20px; color: #4b5563; text-decoration: none; font-size: 14px; transition: all 0.2s; border-left: 3px solid transparent; }
        .nav-item:hover { background: #fdf2f8; color: #ec4899; }
        .nav-item.active { background: #fdf2f8; color: #ec4899; border-left-color: #ec4899; font-weight: 600; }
        .nav-icon { width: 20px; text-align: center; font-size: 16px; }
        .nav-label { flex: 1; }
        .nav-badge { background: #10b981; color: white; font-size: 10px; padding: 2px 8px; border-radius: 10px; font-weight: 600; }
        .nav-divider { height: 1px; background: #e5e7eb; margin: 12px 20px; }
        .sidebar-footer { padding: 16px 20px; border-top: 1px solid #e5e7eb; background: #f9fafb; }
        .user-card { display: flex; align-items: center; gap: 12px; }
        .user-avatar { width: 36px; height: 36px; background: linear-gradient(135deg, #f472b6, #ec4899); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 14px; font-weight: 600; }
        .user-info { flex: 1; }
        .user-name { font-size: 13px; font-weight: 600; color: #1f2937; }
        .user-role { font-size: 11px; color: #6b7280; }
        .logout-btn { background: none; border: none; cursor: pointer; font-size: 16px; color: #6b7280; padding: 4px; }
        .logout-btn:hover { color: #ef4444; }

        /* ë©”ì¸ ì½˜í…ì¸  */
        .main-content { flex: 1; margin-left: 260px; padding: 24px; }
        .page-header { margin-bottom: 24px; }
        .page-title { font-size: 24px; font-weight: 700; color: #1f2937; margin-bottom: 4px; }
        .page-desc { color: #6b7280; font-size: 14px; }

        /* ë©”ì¸ íƒ­ */
        .main-tabs { display: flex; gap: 8px; margin-bottom: 24px; background: white; padding: 8px; border-radius: 12px; border: 1px solid #e5e7eb; }
        .main-tab { flex: 1; padding: 14px 20px; border: none; background: transparent; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; color: #6b7280; }
        .main-tab:hover { color: #ec4899; background: #fdf2f8; }
        .main-tab.active { background: linear-gradient(135deg, #f472b6, #ec4899); color: white; }

        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* âš ï¸ ì—…ë¡œë“œ ì²´í¬ë¦¬ìŠ¤íŠ¸ */
        .upload-checklist {
            background: #fef3c7; border: 2px solid #f59e0b; border-radius: 12px;
            padding: 20px; margin-bottom: 20px; text-align: left;
        }
        .upload-checklist.complete { background: #dcfce7; border-color: #16a34a; }
        .upload-checklist-title { color: #92400e; font-size: 16px; font-weight: 700; margin-bottom: 16px; }
        .upload-checklist.complete .upload-checklist-title { color: #166534; }
        .checklist-item { display: flex; align-items: flex-start; gap: 12px; padding: 10px 0; border-bottom: 1px solid rgba(245, 158, 11, 0.3); }
        .upload-checklist.complete .checklist-item { border-bottom-color: rgba(22, 163, 74, 0.3); }
        .checklist-item:last-child { border-bottom: none; }
        .checklist-item input[type="checkbox"] { width: 20px; height: 20px; accent-color: #16a34a; cursor: pointer; margin-top: 2px; flex-shrink: 0; }
        .checklist-item label { color: #78350f; font-size: 14px; cursor: pointer; flex: 1; line-height: 1.5; }
        .upload-checklist.complete .checklist-item label { color: #166534; }
        .checklist-item .warning-icon { color: #dc2626; font-weight: bold; }
        .checklist-help { margin-top: 12px; padding: 12px; background: white; border-radius: 8px; font-size: 13px; color: #78350f; line-height: 1.7; }
        .upload-checklist.complete .checklist-help { color: #166534; }

        /* ì²´í¬ë¦¬ìŠ¤íŠ¸ ì¹´í…Œê³ ë¦¬ êµ¬ë¶„ */
        .checklist-category {
            font-size: 13px; font-weight: 700; color: #b45309; margin-top: 14px; margin-bottom: 6px;
            padding: 6px 12px; background: rgba(245, 158, 11, 0.15); border-radius: 6px; display: inline-block;
        }
        .upload-checklist.complete .checklist-category { color: #15803d; background: rgba(22, 163, 74, 0.15); }

        /* ì—…ë¡œë“œ ì„¤ëª… */
        .upload-description {
            background: white; border: 1px solid #e5e7eb; border-radius: 12px;
            padding: 20px; margin-bottom: 20px; font-size: 14px; line-height: 1.8;
        }

        /* ì—…ë¡œë“œ ë²„íŠ¼ */
        .upload-button {
            width: 100%; padding: 16px; background: linear-gradient(135deg, #f472b6, #ec4899);
            color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 600;
            cursor: pointer; transition: all 0.2s;
        }
        .upload-button:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(236, 72, 153, 0.3); }
        .upload-button:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

        /* ë¶„ì„ ê²°ê³¼ ë°°ë„ˆ */
        .analysis-banner {
            background: linear-gradient(135deg, #ec4899, #be185d); color: white;
            padding: 16px 24px; border-radius: 12px; margin-bottom: 24px; text-align: center;
        }
        .analysis-banner h2 { margin: 0; font-size: 18px; }
        .analysis-banner p { margin: 8px 0 0 0; opacity: 0.9; font-size: 14px; }

        /* KPI ì¹´ë“œ */
        .kpi-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 24px; }
        .kpi-card { background: white; border: 1px solid #e5e7eb; border-radius: 12px; padding: 20px; text-align: center; }
        .kpi-value { font-size: 28px; font-weight: 700; color: #1f2937; margin-bottom: 4px; }
        .kpi-label { color: #6b7280; font-size: 13px; margin-bottom: 4px; }
        .kpi-change { font-size: 11px; }
        .kpi-change.up { color: #10b981; }
        .kpi-change.down { color: #ef4444; }

        /* 5ê°œ KPI ê·¸ë¦¬ë“œ */
        .kpi-grid-5 { display: grid; grid-template-columns: repeat(5, 1fr); gap: 16px; margin-bottom: 24px; }

        /* ì°¨íŠ¸ ì„¹ì…˜ */
        .chart-section { background: white; border: 1px solid #e5e7eb; border-radius: 12px; padding: 24px; margin-bottom: 24px; }
        .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .chart-title { color: #1f2937; margin: 0; font-size: 16px; }
        .chart-subtitle { color: #6b7280; font-size: 12px; margin-top: 4px; }
        .filter-btn { padding: 6px 12px; background: #f3f4f6; border: none; border-radius: 6px; font-size: 12px; cursor: pointer; margin-left: 8px; }
        .filter-btn.active { background: #ec4899; color: white; }

        /* ì°¨íŠ¸ ê·¸ë¦¬ë“œ */
        .charts-row { display: grid; grid-template-columns: 2fr 1fr; gap: 24px; margin-bottom: 24px; }
        .charts-row-equal { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px; }
        .donut-wrapper { position: relative; height: 200px; display: flex; align-items: center; justify-content: center; }
        .donut-center { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; }
        .donut-center-label { font-size: 12px; color: #6b7280; }
        .donut-center-value { font-size: 24px; font-weight: 700; color: #ec4899; }
        .donut-center-sub { font-size: 12px; color: #6b7280; margin-top: 4px; }
        .donut-center-sub-value { font-size: 14px; color: #374151; }

        /* í…Œì´ë¸” */
        .data-table-section { background: white; border: 1px solid #e5e7eb; border-radius: 12px; padding: 20px; margin-bottom: 24px; }
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th { padding: 12px 8px; text-align: left; color: #374151; font-size: 13px; border-bottom: 1px solid #e5e7eb; background: #f9fafb; white-space: nowrap; }
        .data-table td { padding: 12px 8px; border-bottom: 1px solid #f3f4f6; font-size: 13px; white-space: nowrap; }
        .data-table tr:hover { background: #fdf2f8; }
        .data-table-wrapper { overflow-x: auto; }

        .status-badge { padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; }
        .status-excellent { background: #d1fae5; color: #065f46; }
        .status-good { background: #dbeafe; color: #1e40af; }
        .status-average { background: #fef3c7; color: #92400e; }
        .status-below { background: #fee2e2; color: #991b1b; }
        .status-warning { background: #fee2e2; color: #991b1b; }

        /* ë¶„ì„ ê²°ê³¼ ì˜ì—­ */
        .analysis-result { display: none; }
        .analysis-result.show { display: block; }

        /* íŒŒì¼ ëª©ë¡ */
        .file-list { margin: 16px 0; }
        .file-item { display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: #f3f4f6; border-radius: 6px; margin-bottom: 8px; font-size: 13px; }
        .file-item .remove-btn { margin-left: auto; background: none; border: none; color: #ef4444; cursor: pointer; }

        /* ì„œë¸Œíƒ­ */
        .sub-tabs { display: flex; gap: 4px; margin-bottom: 20px; background: #f3f4f6; padding: 4px; border-radius: 10px; }
        .sub-tab { flex: 1; padding: 10px 16px; border: none; background: transparent; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; color: #6b7280; transition: all 0.2s; }
        .sub-tab:hover { color: #ec4899; }
        .sub-tab.active { background: white; color: #ec4899; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .sub-content { display: none; }
        .sub-content.active { display: block; animation: fadeIn 0.3s ease; }

        /* ì¸ì‚¬ì´íŠ¸ ë°•ìŠ¤ */
        .insight-box {
            background: linear-gradient(135deg, #fdf2f8, #fce7f3); border: 1px solid #f9a8d4;
            border-radius: 12px; padding: 16px 20px; margin-bottom: 20px;
        }
        .insight-box .insight-title { font-weight: 700; color: #be185d; margin-bottom: 8px; font-size: 14px; }
        .insight-box .insight-text { color: #9d174d; font-size: 13px; line-height: 1.7; white-space: pre-line; }

        /* ë¡œë”© & í† ìŠ¤íŠ¸ */
        .loading-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.9); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; opacity: 0; visibility: hidden; transition: all 0.3s; }
        .loading-overlay.show { opacity: 1; visibility: visible; }
        .loading-spinner { width: 48px; height: 48px; border: 4px solid #fce7f3; border-top-color: #ec4899; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 16px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { color: #6b7280; font-size: 14px; }
        .toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(100px); padding: 14px 28px; border-radius: 10px; font-size: 14px; font-weight: 500; z-index: 9999; opacity: 0; transition: all 0.3s ease; box-shadow: 0 4px 20px rgba(0,0,0,0.15); }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        .toast.success { background: #10b981; color: white; }
        .toast.error { background: #ef4444; color: white; }

        /* ë°˜ì‘í˜• */
        @media (max-width: 1200px) {
            .kpi-grid, .kpi-grid-5 { grid-template-columns: repeat(2, 1fr); }
            .charts-row, .charts-row-equal { grid-template-columns: 1fr; }
        }
        @media (max-width: 768px) {
            .sidebar { width: 60px; }
            .logo-text-group, .nav-label, .nav-badge, .user-info { display: none; }
            .nav-item { justify-content: center; padding: 14px; }
            .main-content { margin-left: 60px; }
            .kpi-grid, .kpi-grid-5 { grid-template-columns: 1fr; }
            .main-tabs { flex-direction: column; }
            .sub-tabs { flex-direction: column; }
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">ë°ì´í„° ë¶„ì„ ì¤‘...</div>
    </div>
    <div class="toast" id="toast"></div>

    <div class="app-layout">
        <!-- ì‚¬ì´ë“œë°” -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <div class="logo-circle">ğŸ¦·</div>
                    <div class="logo-text-group">
                        <div class="logo-main">ì•ì„ ì¼€ì–´</div>
                        <div class="logo-sub">Dental Care Analytics</div>
                    </div>
                </div>
            </div>
            <nav class="sidebar-nav">
                <a class="nav-item" href="apsencare_hospital_home_firebase.html"><span class="nav-icon">ğŸ </span><span class="nav-label">í™ˆ</span></a>
                <a class="nav-item" href="#"><span class="nav-icon">ğŸ“–</span><span class="nav-label">ì•ì„ ì¼€ì–´ ì†Œê°œ</span></a>
                <a class="nav-item" href="apsencare_process_full.html"><span class="nav-icon">ğŸ¦·</span><span class="nav-label">ì¹˜ì£¼ê´€ë¦¬ í”„ë¡œì„¸ìŠ¤</span></a>
                <a class="nav-item active" href="apsencare_analytics_full.html"><span class="nav-icon">ğŸ“Š</span><span class="nav-label">ì„±ê³¼ ë¶„ì„</span><span class="nav-badge">NEW</span></a>
                <div class="nav-divider"></div>
                <a class="nav-item" href="#"><span class="nav-icon">ğŸ””</span><span class="nav-label">ë¦¬ì½œì‹œìŠ¤í…œ</span></a>
                <a class="nav-item" href="#"><span class="nav-icon">ğŸ“š</span><span class="nav-label">ì„ìƒêµìœ¡ìê³¼ì •</span></a>
                <div class="nav-divider"></div>
                <a class="nav-item" href="#"><span class="nav-icon">âš™ï¸</span><span class="nav-label">ì„¤ì •</span></a>
            </nav>
            <div class="sidebar-footer">
                <div class="user-card">
                    <div class="user-avatar" id="userAvatar">-</div>
                    <div class="user-info">
                        <div class="user-name" id="userName">ë¡œë”© ì¤‘...</div>
                        <div class="user-role" id="userRole">-</div>
                    </div>
                    <button class="logout-btn" onclick="handleLogout()" title="ë¡œê·¸ì•„ì›ƒ">ğŸšª</button>
                </div>
            </div>
        </aside>

        <!-- ë©”ì¸ ì½˜í…ì¸  -->
        <main class="main-content">
            <div class="page-header">
                <h1 class="page-title">ğŸ“Š ì„±ê³¼ ë¶„ì„</h1>
                <p class="page-desc">ë³‘ì› ìˆ˜ë‚©ì•¡ ì„±ì¥ë¥ ê³¼ í™˜ì ìœ ì§€ìœ¨ì„ ë¶„ì„í•©ë‹ˆë‹¤</p>
            </div>

            <div class="main-tabs">
                <button class="main-tab active" onclick="switchMainTab('growth')">ğŸ’° ìˆ˜ë‚©ì•¡ ì„±ì¥ë¥ </button>
                <button class="main-tab" onclick="switchMainTab('retention')">ğŸ‘¥ ìœ ì§€ìœ¨ / ì´íƒˆìœ¨</button>
            </div>

            <!-- ==================== ìˆ˜ë‚©ì•¡ ì„±ì¥ë¥  íƒ­ ==================== -->
            <div class="tab-content active" id="growth-tab">
                
                <!-- ğŸ“‚ ë´íŠ¸ì›¹ ì¶”ì¶œ ê²½ë¡œ ì•ˆë‚´ -->
                <div style="margin-bottom: 20px; padding: 20px; background: linear-gradient(135deg, #eff6ff 0%, #f0fdf4 100%); border: 2px solid #93c5fd; border-radius: 12px;">
                    <div style="font-weight: 700; color: #1e40af; margin-bottom: 12px; font-size: 15px;">ğŸ“‚ ë°ì´í„° ì¶”ì¶œ ê²½ë¡œ (ë´íŠ¸ì›¹)</div>
                    <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap; padding: 12px 16px; background: white; border-radius: 10px; border: 1px solid #bfdbfe;">
                        <span style="background: #dbeafe; color: #1e40af; padding: 5px 12px; border-radius: 6px; font-weight: 600; font-size: 13px;">ê²½ì˜/í†µê³„</span>
                        <span style="color: #93c5fd; font-weight: 700;">â†’</span>
                        <span style="background: #dbeafe; color: #1e40af; padding: 5px 12px; border-radius: 6px; font-weight: 600; font-size: 13px;">ì˜ì‚¬ë³„ ìˆ˜ë‚©ì•¡ í†µê³„</span>
                        <span style="color: #93c5fd; font-weight: 700;">â†’</span>
                        <span style="background: #dcfce7; color: #166534; padding: 5px 12px; border-radius: 6px; font-weight: 600; font-size: 13px;">í•´ë‹¹ ì˜ì‚¬ ì„ íƒ</span>
                        <span style="color: #93c5fd; font-weight: 700;">â†’</span>
                        <span style="background: #fef3c7; color: #92400e; padding: 5px 12px; border-radius: 6px; font-weight: 600; font-size: 13px;">ğŸ“¥ ì—‘ì…€ ì €ì¥</span>
                        <span style="color: #93c5fd; font-weight: 700;">â†’</span>
                        <span style="background: #fce7f3; color: #9d174d; padding: 5px 12px; border-radius: 6px; font-weight: 700; font-size: 13px;">ğŸ’¾ ì›”ê°„ ìë£Œ ì €ì¥</span>
                    </div>
                    <div style="margin-top: 10px; font-size: 12px; color: #6b7280; line-height: 1.6;">
                        ğŸ’¡ ì˜ˆì‹œ: <strong>êµ¬ê°•ê´€ë¦¬íŒ€ â†’ ê°€ìƒì˜ì‚¬</strong> ì„¤ì • í›„ ì›”ë³„ë¡œ ì—‘ì…€ ì €ì¥<br>
                        âš ï¸ ì €ì¥í•œ íŒŒì¼ì„ <strong>ì•„ë˜ ì•ˆë‚´ì— ë”°ë¼ ë°˜ë“œì‹œ ì •ì œ(ì—´ ì‚­ì œ)</strong>í•œ í›„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”
                    </div>
                </div>

                <!-- âœ‚ï¸ ì—‘ì…€ ì—´ ì •ì œ ì•ˆë‚´ -->
                <div style="margin-bottom: 20px; padding: 20px; background: #fff; border: 2px solid #16a34a; border-radius: 12px;">
                    <div style="font-weight: 700; color: #166534; margin-bottom: 14px; font-size: 15px;">âœ… ì—…ë¡œë“œ ì „ ì—‘ì…€ ì—´ ì •ì œ ì•ˆë‚´</div>
                    <div style="font-size: 13px; color: #6b7280; margin-bottom: 14px; line-height: 1.6;">
                        ë´íŠ¸ì›¹ì—ì„œ ì¶”ì¶œí•œ íŒŒì¼ì—ì„œ <strong style="color: #16a34a;">ì•„ë˜ 5ê°œ ì—´ë§Œ ë‚¨ê¸°ê³ </strong> ë‚˜ë¨¸ì§€ ì—´ì€ ëª¨ë‘ ì‚­ì œí•´ì£¼ì„¸ìš”.
                    </div>
                    <table style="width: 100%; border-collapse: collapse; font-size: 13px; border-radius: 8px; overflow: hidden;">
                        <thead>
                            <tr style="background: #f0fdf4;">
                                <th style="padding: 10px 12px; text-align: left; border-bottom: 2px solid #bbf7d0; color: #166534;">ìœ ì§€í•  ì—´</th>
                                <th style="padding: 10px 12px; text-align: left; border-bottom: 2px solid #bbf7d0; color: #166534;">ìš©ë„</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr style="background: #f0fdf4;">
                                <td style="padding: 10px 12px; border-bottom: 1px solid #bbf7d0; font-weight: 600; color: #1f2937;">ì§„ë£Œì¼</td>
                                <td style="padding: 10px 12px; border-bottom: 1px solid #bbf7d0; color: #6b7280;">ë‚´ì›ê±´ìˆ˜ ì§‘ê³„ <span style="font-size:11px;">(ë¶„ì„ í›„ ì¦‰ì‹œ ì‚­ì œ)</span></td>
                            </tr>
                            <tr style="background: #f0fdf4;">
                                <td style="padding: 10px 12px; border-bottom: 1px solid #bbf7d0; font-weight: 600; color: #1f2937;">ì°¨íŠ¸ë²ˆí˜¸</td>
                                <td style="padding: 10px 12px; border-bottom: 1px solid #bbf7d0; color: #6b7280;">ë‚´ì›ê±´ìˆ˜ ì§‘ê³„ <span style="font-size:11px;">(ë¶„ì„ í›„ ì¦‰ì‹œ ì‚­ì œ)</span></td>
                            </tr>
                            <tr style="background: #f0fdf4;">
                                <td style="padding: 10px 12px; border-bottom: 1px solid #bbf7d0; font-weight: 600; color: #1f2937;">ìˆ˜ë‚©êµ¬ë¶„</td>
                                <td style="padding: 10px 12px; border-bottom: 1px solid #bbf7d0; color: #6b7280;">ë³´í—˜ë³¸ì¸ë¶€ë‹´ / ë¹„ê¸‰ì—¬ ë¶„ë¥˜</td>
                            </tr>
                            <tr style="background: #f0fdf4;">
                                <td style="padding: 10px 12px; border-bottom: 1px solid #bbf7d0; font-weight: 600; color: #1f2937;">ì§„ë£Œê¸ˆì•¡</td>
                                <td style="padding: 10px 12px; border-bottom: 1px solid #bbf7d0; color: #6b7280;">ê¸ˆì•¡ í•©ì‚°</td>
                            </tr>
                            <tr style="background: #f0fdf4;">
                                <td style="padding: 10px 12px; font-weight: 600; color: #1f2937;">ì´ìˆ˜ë‚©ì•¡</td>
                                <td style="padding: 10px 12px; color: #6b7280;">ë¯¸ìˆ˜/í™˜ë¶ˆ ì°¨ì´ ë¶„ì„</td>
                            </tr>
                        </tbody>
                    </table>
                    <div style="margin-top: 12px; padding: 10px 14px; background: #fef2f2; border-radius: 8px; font-size: 12px; color: #991b1b; line-height: 1.6;">
                        ğŸ—‘ <strong>ìœ„ 5ê°œ ì—´ ì™¸ ë‚˜ë¨¸ì§€ëŠ” ëª¨ë‘ ì‚­ì œ</strong> (ìˆœë²ˆ, ìˆ˜ë‚©ì¼, ë³´í—˜êµ¬ë¶„, ìµœì´ˆë‚´ì›, ê³ ê°êµ¬ë¶„2 ë“±)<br>
                        ğŸ“Œ íŒŒì¼ëª…ì€ <strong>ê¸°ê°„ì´ í¬í•¨ëœ ì›ë³¸ íŒŒì¼ëª…ì„ ê·¸ëŒ€ë¡œ ìœ ì§€</strong>í•´ì£¼ì„¸ìš” (ë‚ ì§œ ìë™ ì¸ì‹)
                    </div>
                </div>

                <!-- ğŸ”’ ë³´ì•ˆ & ê°œì¸ì •ë³´ ì²´í¬ë¦¬ìŠ¤íŠ¸ -->
                <div class="upload-checklist" id="growthChecklist">
                    <div class="upload-checklist-title">ğŸ”’ ì—…ë¡œë“œ ì „ ë³´ì•ˆ & ê°œì¸ì •ë³´ í•„ìˆ˜ í™•ì¸ì‚¬í•­</div>
                    
                    <div class="checklist-category">âœ‚ï¸ ì—´ ì •ì œ í™•ì¸</div>
                    <div class="checklist-item">
                        <input type="checkbox" id="gCheck1" onchange="updateGrowthChecklist()">
                        <label for="gCheck1"><span class="warning-icon">âŒ</span> <strong>ì§„ë£Œì¼, ì°¨íŠ¸ë²ˆí˜¸, ìˆ˜ë‚©êµ¬ë¶„, ì§„ë£Œê¸ˆì•¡, ì´ìˆ˜ë‚©ì•¡</strong> 5ê°œ ì—´ë§Œ ë‚¨ê¸°ê³  <strong>ë‚˜ë¨¸ì§€ëŠ” ëª¨ë‘ ì‚­ì œ</strong>í–ˆìŠµë‹ˆë‹¤</label>
                    </div>
                    <div class="checklist-item">
                        <input type="checkbox" id="gCheck2" onchange="updateGrowthChecklist()">
                        <label for="gCheck2"><span class="warning-icon">âŒ</span> ì§„ë£Œì¼Â·ì°¨íŠ¸ë²ˆí˜¸ëŠ” ë‚´ì›ê±´ìˆ˜ ì§‘ê³„ì—ë§Œ ì‚¬ìš©ë˜ë©°, <strong>ë¶„ì„ í›„ ì¦‰ì‹œ ë©”ëª¨ë¦¬ì—ì„œ ì‚­ì œ</strong>ë¨ì„ ì´í•´í•©ë‹ˆë‹¤</label>
                    </div>

                    <div class="checklist-category">ğŸ“‹ ê°œì¸ì •ë³´ ë¯¸í¬í•¨ í™•ì¸</div>
                    <div class="checklist-item">
                        <input type="checkbox" id="gCheck3" onchange="updateGrowthChecklist()">
                        <label for="gCheck3"><span class="warning-icon">âŒ</span> í™˜ì <strong>ì´ë¦„, ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸, ì „í™”ë²ˆí˜¸, ì£¼ì†Œ</strong> ë“± ê°œì¸ ì‹ë³„ì •ë³´ê°€ í¬í•¨ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤</label>
                    </div>
                    <div class="checklist-item">
                        <input type="checkbox" id="gCheck4" onchange="updateGrowthChecklist()">
                        <label for="gCheck4"><span class="warning-icon">âŒ</span> <strong>ì§„ë‹¨ëª…, ì²˜ë°©, ì²˜ì¹˜ì½”ë“œ, ë³´í—˜ ì²­êµ¬ ìƒì„¸ë‚´ì—­</strong>(EDI ì½”ë“œ ë“±)ì´ í¬í•¨ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤</label>
                    </div>

                    <div class="checklist-category">ğŸ¥ ì˜ë£Œê¸°ê´€ ë³´ì•ˆ í™•ì¸</div>
                    <div class="checklist-item">
                        <input type="checkbox" id="gCheck5" onchange="updateGrowthChecklist()">
                        <label for="gCheck5"><span class="warning-icon">âŒ</span> <strong>ì›ì¥/ê´€ë¦¬ì ìŠ¹ì¸</strong> í•˜ì— ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•˜ë©°, ë‚´ë¶€ ë°ì´í„° ìœ ì¶œì— ì£¼ì˜í•©ë‹ˆë‹¤</label>
                    </div>
                    <div class="checklist-item">
                        <input type="checkbox" id="gCheck6" onchange="updateGrowthChecklist()">
                        <label for="gCheck6"><span class="warning-icon">âŒ</span> ì—…ë¡œë“œ ë°ì´í„°ëŠ” <strong>ë¸Œë¼ìš°ì € ë‚´ì—ì„œë§Œ ë¶„ì„</strong>ë˜ë©°, ì™¸ë¶€ ì„œë²„ë¡œ ì „ì†¡ë˜ì§€ ì•ŠìŒì„ í™•ì¸í•©ë‹ˆë‹¤</label>
                    </div>

                    <div class="checklist-help">
                        âœ… <strong>ì •ì œ í›„ í—ˆìš© ë°ì´í„°:</strong> ì§„ë£Œì¼(ë‚´ì›ê±´ìˆ˜ ì§‘ê³„), ì°¨íŠ¸ë²ˆí˜¸(ë‚´ì›ê±´ìˆ˜ ì§‘ê³„), ìˆ˜ë‚©êµ¬ë¶„(ë³´í—˜/ë¹„ê¸‰ì—¬ ë¶„ë¥˜), ì§„ë£Œê¸ˆì•¡(ê¸ˆì•¡ í•©ì‚°), ì´ìˆ˜ë‚©ì•¡(ë¯¸ìˆ˜/í™˜ë¶ˆ ë¶„ì„) <strong>5ê°œ ì—´ë§Œ</strong><br>
                        ğŸ›¡ï¸ <strong>ì•ˆì „ ë³´ì¥:</strong> ëª¨ë“  ë¶„ì„ì€ ë¸Œë¼ìš°ì €(í´ë¼ì´ì–¸íŠ¸) ë‚´ì—ì„œ ì²˜ë¦¬ë˜ë©°, íŒŒì¼ì´ ì„œë²„ì— ì—…ë¡œë“œë˜ê±°ë‚˜ ì €ì¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤<br>
                        âš–ï¸ <strong>ë²•ì  ê·¼ê±°:</strong> ê°œì¸ì •ë³´ë³´í˜¸ë²• ì œ17ì¡°, ì˜ë£Œë²• ì œ21ì¡°ì— ì˜ê±° í™˜ì ì‹ë³„ì •ë³´ëŠ” ë°˜ë“œì‹œ ì œê±° í›„ ì—…ë¡œë“œí•´ì•¼ í•©ë‹ˆë‹¤
                    </div>
                </div>

                <!-- ì˜ë£Œê¸°ê´€ ìœ í˜• ì„ íƒ -->
                <div id="facilityTypeSelector" style="margin-top: 20px; padding: 20px; background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 12px;">
                    <div style="font-weight: 700; color: #1f2937; margin-bottom: 12px; font-size: 15px;">ğŸ¥ ì˜ë£Œê¸°ê´€ ìœ í˜• ì„ íƒ</div>
                    <div style="display: flex; gap: 12px;">
                        <label id="facilityHospital" style="flex: 1; display: flex; align-items: center; gap: 10px; padding: 14px 16px; background: white; border: 2px solid #ec4899; border-radius: 10px; cursor: pointer; transition: all 0.2s;">
                            <input type="radio" name="facilityType" value="hospital" checked onchange="updateFacilityType()" style="accent-color: #ec4899; width: 18px; height: 18px;">
                            <div>
                                <div style="font-weight: 700; color: #1f2937; font-size: 14px;">ğŸ¥ ë³‘ì›</div>
                                <div style="color: #6b7280; font-size: 12px; margin-top: 2px;">ë³¸ì¸ë¶€ë‹´ <strong style="color:#ec4899;">40%</strong> Â· ê³µë‹¨ë¶€ë‹´ 60%</div>
                            </div>
                        </label>
                        <label id="facilityClinic" style="flex: 1; display: flex; align-items: center; gap: 10px; padding: 14px 16px; background: white; border: 2px solid #e2e8f0; border-radius: 10px; cursor: pointer; transition: all 0.2s;">
                            <input type="radio" name="facilityType" value="clinic" onchange="updateFacilityType()" style="accent-color: #ec4899; width: 18px; height: 18px;">
                            <div>
                                <div style="font-weight: 700; color: #1f2937; font-size: 14px;">ğŸ¨ ì˜ì›</div>
                                <div style="color: #6b7280; font-size: 12px; margin-top: 2px;">ë³¸ì¸ë¶€ë‹´ <strong style="color:#6366f1;">30%</strong> Â· ê³µë‹¨ë¶€ë‹´ 70%</div>
                            </div>
                        </label>
                    </div>
                    <div id="facilityDesc" style="margin-top: 10px; padding: 8px 12px; background: #fdf2f8; border-radius: 8px; font-size: 12px; color: #9d174d;">
                        ğŸ’¡ ê³µë‹¨ë¶€ë‹´ê¸ˆ = ë³¸ì¸ë¶€ë‹´ê¸ˆ Ã· 0.4 Ã— 0.6 ìœ¼ë¡œ ì¶”ì‚°ë©ë‹ˆë‹¤
                    </div>
                </div>

                <!-- ì—…ë¡œë“œ ì„¤ëª… -->
                <div class="upload-description">
                    <strong>ğŸ“Š ì •ì œëœ ì›”ë³„ ìˆ˜ë‚©í†µê³„ Excel íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”</strong> <span style="color:#6366f1; font-weight:600;">(ì—¬ëŸ¬ íŒŒì¼ ë™ì‹œ ì„ íƒ ê°€ëŠ¥)</span><br><br>
                    â€¢ íŒŒì¼ëª…ì€ ì›ë³¸ ê·¸ëŒ€ë¡œ ìœ ì§€: <span style="color: #059669; font-weight: 600;">2024-01-01_2024-01-31ìˆ˜ë‚©í†µê³„.xlsx</span> (ê¸°ê°„ ìë™ ì¸ì‹)<br>
                    â€¢ ìœ ì§€ ì—´ 5ê°œ: <strong style="color:#16a34a;">ì§„ë£Œì¼, ì°¨íŠ¸ë²ˆí˜¸, ìˆ˜ë‚©êµ¬ë¶„, ì§„ë£Œê¸ˆì•¡, ì´ìˆ˜ë‚©ì•¡</strong> â€” ë‚˜ë¨¸ì§€ëŠ” ëª¨ë‘ ì‚­ì œ<br>
                    â€¢ ê³µë‹¨ë¶€ë‹´ê¸ˆì€ ìœ„ì—ì„œ ì„ íƒí•œ <strong>ì˜ë£Œê¸°ê´€ ìœ í˜• ë¹„ìœ¨</strong>ë¡œ ìë™ ì¶”ì‚°ë©ë‹ˆë‹¤<br>
                    â€¢ <span style="color: #dc2626; font-weight: 600;">ìµœì†Œ 2ê°œì›”</span> ì´ìƒì˜ íŒŒì¼ì„ ì—…ë¡œë“œí•´ì•¼ ì¶”ì´ ë¶„ì„ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤
                </div>

                <!-- ì—…ë¡œë“œ ë²„íŠ¼ -->
                <button class="upload-button" id="growthUploadBtn" disabled>ğŸ”’ ë³´ì•ˆ ì²´í¬ë¦¬ìŠ¤íŠ¸ë¥¼ ë¨¼ì € í™•ì¸í•´ì£¼ì„¸ìš”</button>
                <input type="file" id="growthFileInput" accept=".xlsx,.xls" multiple style="display: none;">

                <!-- ì—…ë¡œë“œëœ íŒŒì¼ -->
                <div id="growthUploadedFiles" style="margin-top: 16px; display: none;">
                    <h4 style="color: #1f2937; margin-bottom: 8px; font-size: 14px;">ğŸ“ ì—…ë¡œë“œëœ íŒŒì¼</h4>
                    <div id="growthFileList" class="file-list"></div>
                    <button id="growthAnalyzeBtn" style="background: #ec4899; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; margin-top: 8px;">
                        ğŸ” ìˆ˜ë‚©ì•¡ ë¶„ì„ ì‹œì‘
                    </button>
                </div>

                <!-- ========== ë¶„ì„ ê²°ê³¼ ========== -->
                <div class="analysis-result" id="growthResults">
                    
                    <!-- ë°°ë„ˆ -->
                    <div class="analysis-banner">
                        <h2>ğŸ’° ìˆ˜ë‚©ì•¡ ì„±ì¥ë¥  ë¶„ì„ ì™„ë£Œ!</h2>
                        <p id="growthBannerDesc">ì›”ë³„ ìˆ˜ë‚© ì¶”ì´ì™€ ì„±ì¥ë¥ ì„ í™•ì¸í•˜ì„¸ìš”</p>
                    </div>

                    <!-- KPI ì¹´ë“œ 5ê°œ -->
                    <div class="kpi-grid-5">
                        <div class="kpi-card">
                            <div class="kpi-value" id="kpiTotalRevenue">-</div>
                            <div class="kpi-label">ìµœê·¼ ì›” ì´ìˆ˜ë‚©</div>
                            <div class="kpi-change" id="kpiTotalRevenueChange"></div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-value" id="kpiYoyGrowth">-</div>
                            <div class="kpi-label">YoY ìˆ˜ë‚© ì„±ì¥ë¥ </div>
                            <div class="kpi-change" id="kpiYoyGrowthChange"></div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-value" id="kpiNonInsRatio">-</div>
                            <div class="kpi-label">ë¹„ê¸‰ì—¬ ë¹„ìœ¨</div>
                            <div class="kpi-change" id="kpiNonInsRatioChange"></div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-value" id="kpiPerPatient">-</div>
                            <div class="kpi-label">ê°ë‹¨ê°€</div>
                            <div class="kpi-change" id="kpiPerPatientChange"></div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-value" id="kpiPatientCount">-</div>
                            <div class="kpi-label">ìµœê·¼ ì›” ë‚´ì›ê±´ìˆ˜</div>
                            <div class="kpi-change" id="kpiPatientCountChange"></div>
                        </div>
                    </div>

                    <!-- ì„œë¸Œíƒ­ -->
                    <div class="sub-tabs">
                        <button class="sub-tab active" onclick="switchGrowthSub('trend')">ğŸ“ˆ ê¸ˆì•¡ ì¶”ì´</button>
                        <button class="sub-tab" onclick="switchGrowthSub('yoy')">ğŸ“… YoY ë™ì›” ë¹„êµ</button>
                        <button class="sub-tab" onclick="switchGrowthSub('unit')">ğŸ’ ê°ë‹¨ê°€ & ë¹„ê¸‰ì—¬</button>
                    </div>

                    <!-- ì„œë¸Œíƒ­ 1: ê¸ˆì•¡ ì¶”ì´ -->
                    <div class="sub-content active" id="trend-sub">
                        <div class="chart-section">
                            <div class="chart-header">
                                <div>
                                    <h3 class="chart-title">ğŸ“Š ì›”ë³„ ìˆ˜ë‚© êµ¬ì„± ì¶”ì´</h3>
                                    <p class="chart-subtitle">ë³´í—˜ ìˆ˜ë‚©(ë³¸ì¸ë¶€ë‹´) + ë¹„ê¸‰ì—¬ ìˆ˜ë‚©</p>
                                </div>
                            </div>
                            <div style="height: 350px;"><canvas id="revenueStackedChart"></canvas></div>
                        </div>

                        <div class="charts-row-equal">
                            <div class="chart-section">
                                <h3 class="chart-title">ğŸ“Š í•­ëª©ë³„ ê¸ˆì•¡ ë¹„êµ</h3>
                                <p class="chart-subtitle">ë³¸ì¸ë¶€ë‹´ê¸ˆ Â· ê³µë‹¨ë¶€ë‹´ê¸ˆ Â· ë¹„ê¸‰ì—¬</p>
                                <div style="height: 300px; margin-top: 12px;"><canvas id="revenueLineChart"></canvas></div>
                            </div>
                            <div class="chart-section">
                                <h3 class="chart-title">ğŸ“Š ì´ì§„ë£Œë¹„ ì¶”ì´</h3>
                                <p class="chart-subtitle">ì´ì§„ë£Œë¹„ = (ë³¸ì¸ë¶€ë‹´ + ê³µë‹¨ë¶€ë‹´) + ë¹„ê¸‰ì—¬</p>
                                <div style="height: 300px; margin-top: 12px;"><canvas id="totalFeeChart"></canvas></div>
                            </div>
                        </div>

                        <!-- ë°ì´í„° í…Œì´ë¸” -->
                        <div class="data-table-section">
                            <h3 class="chart-title" style="margin-bottom: 16px;">ğŸ“‹ ì›”ë³„ ìƒì„¸ ë°ì´í„°</h3>
                            <div class="data-table-wrapper">
                                <table class="data-table" id="growthDataTable">
                                    <thead>
                                        <tr>
                                            <th>ì›”</th>
                                            <th style="text-align:right;">ë³¸ì¸ë¶€ë‹´ê¸ˆ</th>
                                            <th style="text-align:right;" id="nhisColumnHeader">ê³µë‹¨ë¶€ë‹´ê¸ˆ<span style="color:#6366f1;font-size:10px;"> (ì¶”ì •)</span></th>
                                            <th style="text-align:right;">ë¹„ê¸‰ì—¬</th>
                                            <th style="text-align:right;">ì´ì§„ë£Œë¹„</th>
                                            <th style="text-align:right;">ë‚´ì›ê±´ìˆ˜</th>
                                            <th style="text-align:right;">ìˆ˜ë‚©í•©ê³„</th>
                                            <th style="text-align:right;">ê°ë‹¨ê°€</th>
                                            <th style="text-align:center;">ë¹„ê¸‰ì—¬ë¹„ìœ¨</th>
                                        </tr>
                                    </thead>
                                    <tbody id="growthTableBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- ì„œë¸Œíƒ­ 2: ì—°ë„ë³„ ë¹„êµ -->
                    <div class="sub-content" id="yoy-sub">
                        <div style="padding: 16px 20px; background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 12px; margin-bottom: 20px;">
                            <div style="font-weight: 700; color: #1f2937; margin-bottom: 10px; font-size: 14px;">ğŸ“… ë¹„êµí•  ì—°ë„ ì„ íƒ</div>
                            <div id="yearSelectorBox" style="display: flex; flex-wrap: wrap; gap: 8px;"></div>
                            <div style="margin-top: 8px; font-size: 11px; color: #6b7280;">ë™ì¼ ì›”(1~12ì›”)ì„ Xì¶•ìœ¼ë¡œ ì„ íƒí•œ ì—°ë„ë“¤ì„ ê²¹ì³ ë¹„êµí•©ë‹ˆë‹¤</div>
                        </div>

                        <div class="charts-row-equal">
                            <div class="chart-section">
                                <h3 class="chart-title">ğŸ’° ìˆ˜ë‚©í•©ê³„ ë¹„êµ</h3>
                                <p class="chart-subtitle">ë³¸ì¸ë¶€ë‹´ + ë¹„ê¸‰ì—¬</p>
                                <div style="height: 300px; margin-top: 12px;"><canvas id="yrCmpSunapChart"></canvas></div>
                            </div>
                            <div class="chart-section">
                                <h3 class="chart-title">ğŸ¥ ë‚´ì›ê±´ìˆ˜ ë¹„êµ</h3>
                                <p class="chart-subtitle">ì°¨íŠ¸ë²ˆí˜¸+ì§„ë£Œì¼ ê¸°ì¤€</p>
                                <div style="height: 300px; margin-top: 12px;"><canvas id="yrCmpPatientChart"></canvas></div>
                            </div>
                        </div>

                        <div class="charts-row-equal">
                            <div class="chart-section">
                                <h3 class="chart-title">ğŸ’ ê°ë‹¨ê°€ ë¹„êµ</h3>
                                <p class="chart-subtitle">ì´ì§„ë£Œë¹„ Ã· ë‚´ì›ê±´ìˆ˜</p>
                                <div style="height: 300px; margin-top: 12px;"><canvas id="yrCmpUnitChart"></canvas></div>
                            </div>
                            <div class="chart-section">
                                <h3 class="chart-title">ğŸ§¡ ë¹„ê¸‰ì—¬ë¹„ìœ¨ ë¹„êµ</h3>
                                <p class="chart-subtitle">ë¹„ê¸‰ì—¬ Ã· ì´ì§„ë£Œë¹„ Ã— 100 Â· <span style="color:#16a34a; font-weight:600;">ëª©í‘œ 30%</span></p>
                                <div style="height: 300px; margin-top: 12px;"><canvas id="yrCmpRatioChart"></canvas></div>
                            </div>
                        </div>

                        <!-- ì—°ë„ë³„ ë¹„êµ í…Œì´ë¸” -->
                        <div class="data-table-section">
                            <h3 class="chart-title" style="margin-bottom: 16px;">ğŸ“‹ ì—°ë„ë³„ ì›”ê°„ ë¹„êµí‘œ</h3>
                            <div class="data-table-wrapper">
                                <table class="data-table" id="yrCmpTable">
                                    <thead id="yrCmpTableHead"></thead>
                                    <tbody id="yrCmpTableBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- ì„œë¸Œíƒ­ 3: ê°ë‹¨ê°€ & ë¹„ê¸‰ì—¬ -->
                    <div class="sub-content" id="unit-sub">
                        <div class="charts-row-equal">
                            <div class="chart-section">
                                <h3 class="chart-title">ğŸ’ ê°ë‹¨ê°€ ì¶”ì´</h3>
                                <p class="chart-subtitle">ì´ì§„ë£Œë¹„ Ã· ë‚´ì›ê±´ìˆ˜ (ì°¨íŠ¸ë²ˆí˜¸+ì§„ë£Œì¼ ê¸°ì¤€)</p>
                                <div style="height: 300px; margin-top: 12px;"><canvas id="perPatientChart"></canvas></div>
                            </div>
                            <div class="chart-section">
                                <h3 class="chart-title">ğŸ”¥ ë¹„ê¸‰ì—¬ ë¹„ìœ¨ ì¶”ì´</h3>
                                <p class="chart-subtitle">ë¹„ê¸‰ì—¬ Ã· ì´ì§„ë£Œë¹„ Ã— 100 Â· <span style="color:#16a34a; font-weight:600;">ëª©í‘œ 30% ì´ìƒ</span></p>
                                <div style="height: 300px; margin-top: 12px;"><canvas id="nonInsRatioChart"></canvas></div>
                            </div>
                        </div>

                        <div class="chart-section">
                            <div class="chart-header">
                                <div>
                                    <h3 class="chart-title">ğŸ“Š ë‚´ì›ê±´ìˆ˜ vs ê°ë‹¨ê°€</h3>
                                    <p class="chart-subtitle">ì„±ì¥ ì›ì¸ ë¶„í•´: í™˜ì ì¦ê°€ vs ë‹¨ê°€ ìƒìŠ¹</p>
                                </div>
                            </div>
                            <div style="height: 350px;"><canvas id="volumePriceChart"></canvas></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ==================== ìœ ì§€ìœ¨/ì´íƒˆìœ¨ íƒ­ ==================== -->
            <div class="tab-content" id="retention-tab">

                <!-- ğŸ“‚ ë´íŠ¸ì›¹ ë°ì´í„° ì¶”ì¶œ ê²½ë¡œ -->
                <div style="margin-bottom: 20px; padding: 20px; background: linear-gradient(135deg, #eff6ff 0%, #f0fdf4 100%); border: 2px solid #93c5fd; border-radius: 12px;">
                    <div style="font-weight: 700; color: #1e40af; margin-bottom: 12px; font-size: 15px;">ğŸ“‚ ë°ì´í„° ì¶”ì¶œ ê²½ë¡œ (ë´íŠ¸ì›¹)</div>
                    <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap; padding: 12px 16px; background: white; border-radius: 10px; border: 1px solid #bfdbfe;">
                        <span style="background: #dbeafe; color: #1e40af; padding: 5px 12px; border-radius: 6px; font-weight: 600; font-size: 13px;">ê²½ì˜/í†µê³„</span>
                        <span style="color: #93c5fd; font-weight: 700;">â†’</span>
                        <span style="background: #dbeafe; color: #1e40af; padding: 5px 12px; border-radius: 6px; font-weight: 600; font-size: 13px;">í™˜ì ê´€ë ¨ í†µê³„</span>
                        <span style="color: #93c5fd; font-weight: 700;">â†’</span>
                        <span style="background: #dbeafe; color: #1e40af; padding: 5px 12px; border-radius: 6px; font-weight: 600; font-size: 13px;">ì ‘ìˆ˜í™˜ì ìˆ˜</span>
                        <span style="color: #93c5fd; font-weight: 700;">â†’</span>
                        <span style="background: #dcfce7; color: #166534; padding: 5px 12px; border-radius: 6px; font-weight: 600; font-size: 13px;">ğŸ–±ï¸ íœ  í´ë¦­</span>
                        <span style="color: #93c5fd; font-weight: 700;">â†’</span>
                        <span style="background: #fef3c7; color: #92400e; padding: 5px 12px; border-radius: 6px; font-weight: 600; font-size: 13px;">ê¸°ê°„ë³„ ì ‘ìˆ˜í™˜ì ëª©ë¡</span>
                        <span style="color: #93c5fd; font-weight: 700;">â†’</span>
                        <span style="background: #fce7f3; color: #9d174d; padding: 5px 12px; border-radius: 6px; font-weight: 700; font-size: 13px;">ğŸ’¾ ì—°ê°„ ìë£Œ ì €ì¥</span>
                    </div>
                    <div style="margin-top: 10px; font-size: 12px; color: #6b7280; line-height: 1.6;">
                        ğŸ’¡ ì—°ë„ë³„ë¡œ ê°ê° ì €ì¥í•˜ê±°ë‚˜, ì—¬ëŸ¬ ì—°ë„ë¥¼ í•˜ë‚˜ì˜ íŒŒì¼ë¡œ ì €ì¥í•´ë„ ë©ë‹ˆë‹¤ Â· ìµœì†Œ <strong>2ê°œ ì—°ë„ ì´ìƒ</strong> í•„ìš”<br>
                        âš ï¸ ì €ì¥í•œ íŒŒì¼ì„ <strong>ì•„ë˜ ì•ˆë‚´ì— ë”°ë¼ ë°˜ë“œì‹œ ì •ì œ(ì—´ ì‚­ì œ)</strong>í•œ í›„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”
                    </div>
                </div>

                <!-- âœ… ì—‘ì…€ ì—´ ì •ì œ ì•ˆë‚´ -->
                <div style="margin-bottom: 20px; padding: 20px; background: #fff; border: 2px solid #16a34a; border-radius: 12px;">
                    <div style="font-weight: 700; color: #166534; margin-bottom: 14px; font-size: 15px;">âœ… ì—…ë¡œë“œ ì „ ì—‘ì…€ ì—´ ì •ì œ ì•ˆë‚´</div>
                    <div style="font-size: 13px; color: #6b7280; margin-bottom: 14px; line-height: 1.6;">
                        ì¶”ì¶œí•œ íŒŒì¼ì—ì„œ <strong style="color: #16a34a;">ì•„ë˜ 2ê°œ ì—´ë§Œ ë‚¨ê¸°ê³ </strong> ë‚˜ë¨¸ì§€ ì—´ì€ ëª¨ë‘ ì‚­ì œí•´ì£¼ì„¸ìš”.
                    </div>
                    <table style="width: 100%; border-collapse: collapse; font-size: 13px; border-radius: 8px; overflow: hidden;">
                        <thead>
                            <tr style="background: #f0fdf4;">
                                <th style="padding: 10px 12px; text-align: left; border-bottom: 2px solid #bbf7d0; color: #166534;">ìœ ì§€í•  ì—´</th>
                                <th style="padding: 10px 12px; text-align: left; border-bottom: 2px solid #bbf7d0; color: #166534;">ìš©ë„</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr style="background: #f0fdf4;">
                                <td style="padding: 10px 12px; border-bottom: 1px solid #bbf7d0; font-weight: 600; color: #1f2937;">ì°¨íŠ¸ë²ˆí˜¸</td>
                                <td style="padding: 10px 12px; border-bottom: 1px solid #bbf7d0; color: #6b7280;">í™˜ì ì‹ë³„ â€” ì—°ë„ë³„ ë‚´ì› ì¶”ì  <span style="font-size:11px;">(ë¶„ì„ í›„ ì¦‰ì‹œ ì‚­ì œ)</span></td>
                            </tr>
                            <tr style="background: #f0fdf4;">
                                <td style="padding: 10px 12px; font-weight: 600; color: #1f2937;">ì§„ë£Œì¼ <span style="font-weight:400; color:#6b7280;">ë˜ëŠ”</span> ì ‘ìˆ˜ì‹œê°</td>
                                <td style="padding: 10px 12px; color: #6b7280;">ì—°ë„ ì¶”ì¶œ â€” ì–´ëŠ í•´ì— ë‚´ì›í–ˆëŠ”ì§€ íŒë³„ <span style="font-size:11px;">(ë¶„ì„ í›„ ì¦‰ì‹œ ì‚­ì œ)</span></td>
                            </tr>
                        </tbody>
                    </table>
                    <div style="margin-top: 12px; padding: 10px 14px; background: #fef2f2; border-radius: 8px; font-size: 12px; color: #991b1b; line-height: 1.6;">
                        ğŸ—‘ <strong>ìœ„ 2ê°œ ì—´ ì™¸ ë‚˜ë¨¸ì§€ëŠ” ëª¨ë‘ ì‚­ì œ</strong> (ìˆœë²ˆ, ìˆ˜ë‚©ì¼, ì´ë¦„, ë³´í—˜êµ¬ë¶„, ìˆ˜ë‚©êµ¬ë¶„, ìˆ˜ì…ì§‘ê³„, ìˆ˜ë‚©ì, ì§„ë£Œê¸ˆì•¡, ì´ìˆ˜ë‚©, ìµœì´ˆë‚´ì›ì¼, ë‚´ì›ê²½ë¡œ, ë¦¬ì½œêµ¬ë¶„, ê³ ê°êµ¬ë¶„ ë“±)<br>
                        âš ï¸ íŠ¹íˆ <strong style="color:#dc2626;">ì´ë¦„</strong>ì€ ê°œì¸ì •ë³´ì´ë¯€ë¡œ ë°˜ë“œì‹œ ì‚­ì œí•´ì£¼ì„¸ìš”
                    </div>
                </div>

                <!-- ğŸ”’ ë³´ì•ˆ & ê°œì¸ì •ë³´ ì²´í¬ë¦¬ìŠ¤íŠ¸ -->
                <div class="upload-checklist" id="uploadChecklist">
                    <div class="upload-checklist-title">ğŸ”’ ì—…ë¡œë“œ ì „ ë³´ì•ˆ & ê°œì¸ì •ë³´ í•„ìˆ˜ í™•ì¸ì‚¬í•­</div>
                    
                    <div class="checklist-category">âœ‚ï¸ ì—´ ì •ì œ í™•ì¸</div>
                    <div class="checklist-item">
                        <input type="checkbox" id="check1" onchange="updateChecklist()">
                        <label for="check1"><span class="warning-icon">âŒ</span> <strong>ì°¨íŠ¸ë²ˆí˜¸</strong>ì™€ <strong>ë‚ ì§œ ì—´</strong>(ì§„ë£Œì¼ ë˜ëŠ” ì ‘ìˆ˜ì‹œê°) 2ê°œë§Œ ë‚¨ê¸°ê³  <strong>ë‚˜ë¨¸ì§€ëŠ” ëª¨ë‘ ì‚­ì œ</strong>í–ˆìŠµë‹ˆë‹¤</label>
                    </div>
                    <div class="checklist-item">
                        <input type="checkbox" id="check2" onchange="updateChecklist()">
                        <label for="check2"><span class="warning-icon">âŒ</span> ì°¨íŠ¸ë²ˆí˜¸Â·ë‚ ì§œ ì—´ì€ ìœ ì§€/ì´íƒˆ ë¶„ì„ì—ë§Œ ì‚¬ìš©ë˜ë©°, <strong>ë¶„ì„ í›„ ì¦‰ì‹œ ë©”ëª¨ë¦¬ì—ì„œ ì‚­ì œ</strong>ë¨ì„ ì´í•´í•©ë‹ˆë‹¤</label>
                    </div>

                    <div class="checklist-category">ğŸ“‹ ê°œì¸ì •ë³´ ë¯¸í¬í•¨ í™•ì¸</div>
                    <div class="checklist-item">
                        <input type="checkbox" id="check3" onchange="updateChecklist()">
                        <label for="check3"><span class="warning-icon">âŒ</span> í™˜ì <strong>ì´ë¦„, ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸, ì „í™”ë²ˆí˜¸, ì£¼ì†Œ</strong> ë“± ê°œì¸ ì‹ë³„ì •ë³´ê°€ í¬í•¨ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤</label>
                    </div>
                    <div class="checklist-item">
                        <input type="checkbox" id="check4" onchange="updateChecklist()">
                        <label for="check4"><span class="warning-icon">âŒ</span> <strong>ì§„ë‹¨ëª…, ì²˜ë°©, ì²˜ì¹˜ì½”ë“œ, ë³´í—˜ ì²­êµ¬ ìƒì„¸ë‚´ì—­</strong>(EDI ì½”ë“œ ë“±)ì´ í¬í•¨ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤</label>
                    </div>

                    <div class="checklist-category">ğŸ¥ ì˜ë£Œê¸°ê´€ ë³´ì•ˆ í™•ì¸</div>
                    <div class="checklist-item">
                        <input type="checkbox" id="check5" onchange="updateChecklist()">
                        <label for="check5"><span class="warning-icon">âŒ</span> <strong>ì›ì¥/ê´€ë¦¬ì ìŠ¹ì¸</strong> í•˜ì— ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•˜ë©°, ë‚´ë¶€ ë°ì´í„° ìœ ì¶œì— ì£¼ì˜í•©ë‹ˆë‹¤</label>
                    </div>
                    <div class="checklist-item">
                        <input type="checkbox" id="check6" onchange="updateChecklist()">
                        <label for="check6"><span class="warning-icon">âŒ</span> ì—…ë¡œë“œ ë°ì´í„°ëŠ” <strong>ë¸Œë¼ìš°ì € ë‚´ì—ì„œë§Œ ë¶„ì„</strong>ë˜ë©°, ì™¸ë¶€ ì„œë²„ë¡œ ì „ì†¡ë˜ì§€ ì•ŠìŒì„ í™•ì¸í•©ë‹ˆë‹¤</label>
                    </div>

                    <div class="checklist-help">
                        âœ… <strong>ì •ì œ í›„ í—ˆìš© ë°ì´í„°:</strong> ì°¨íŠ¸ë²ˆí˜¸(í™˜ì ì‹ë³„) + ë‚ ì§œ ì—´(ì§„ë£Œì¼ ë˜ëŠ” ì ‘ìˆ˜ì‹œê°) <strong>2ê°œ ì—´ë§Œ</strong><br>
                        ğŸ›¡ï¸ <strong>ì•ˆì „ ë³´ì¥:</strong> ëª¨ë“  ë¶„ì„ì€ ë¸Œë¼ìš°ì €(í´ë¼ì´ì–¸íŠ¸) ë‚´ì—ì„œ ì²˜ë¦¬ë˜ë©°, íŒŒì¼ì´ ì„œë²„ì— ì—…ë¡œë“œë˜ê±°ë‚˜ ì €ì¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤<br>
                        âš–ï¸ <strong>ë²•ì  ê·¼ê±°:</strong> ê°œì¸ì •ë³´ë³´í˜¸ë²• ì œ17ì¡°, ì˜ë£Œë²• ì œ21ì¡°ì— ì˜ê±° í™˜ì ì‹ë³„ì •ë³´ëŠ” ë°˜ë“œì‹œ ì œê±° í›„ ì—…ë¡œë“œí•´ì•¼ í•©ë‹ˆë‹¤
                    </div>
                </div>

                <div class="upload-description">
                    <strong>ğŸ¯ ì—°ë„ë³„ ì ‘ìˆ˜í™˜ì ëª©ë¡ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”</strong><br>
                    â€¢ ìœ ì§€ ì—´ 2ê°œ: <strong style="color:#16a34a;">ì°¨íŠ¸ë²ˆí˜¸</strong> + <strong style="color:#16a34a;">ë‚ ì§œ ì—´</strong>(ì§„ë£Œì¼ ë˜ëŠ” ì ‘ìˆ˜ì‹œê°) â€” ë‚˜ë¨¸ì§€ëŠ” ëª¨ë‘ ì‚­ì œ<br>
                    â€¢ ìµœì†Œ <strong>2ê°œ ì—°ë„ ì´ìƒ</strong> ë°ì´í„°ê°€ ìˆì–´ì•¼ ì „ë…„ë„ ëŒ€ë¹„ ë¶„ì„ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤<br>
                    â€¢ íŒŒì¼ëª…ì€ ììœ  â€” ì‹œìŠ¤í…œì´ Excel ë‚´ìš©ì„ ìë™ ë¶„ì„í•©ë‹ˆë‹¤
                </div>

                <button class="upload-button" id="uploadBtn" disabled>ğŸ”’ ì²´í¬ë¦¬ìŠ¤íŠ¸ë¥¼ ë¨¼ì € í™•ì¸í•´ì£¼ì„¸ìš”</button>
                <input type="file" id="fileInput" accept=".xlsx,.xls" multiple style="display: none;">

                <div id="uploadedFiles" style="margin-top: 16px; display: none;">
                    <h4 style="color: #1f2937; margin-bottom: 8px; font-size: 14px;">ğŸ“ ì—…ë¡œë“œëœ íŒŒì¼ë“¤</h4>
                    <div id="fileList" class="file-list"></div>
                    <button id="analyzeBtn" style="background: #ec4899; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                        ğŸ” ì—°ë„ë³„ ë¶„ì„ ì‹œì‘
                    </button>
                </div>

                <div class="analysis-result" id="analysisResults">
                    <div class="analysis-banner">
                        <h2>âœ¨ ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!</h2>
                        <p>AI ê¸°ë°˜ ë¶„ì„ìœ¼ë¡œ í™˜ì ì´íƒˆì„ ë¯¸ë¦¬ ë°©ì§€í•˜ê³  ìˆ˜ìµì„ ìµœì í™”í•˜ì„¸ìš”</p>
                    </div>
                    <div class="kpi-grid">
                        <div class="kpi-card"><div class="kpi-value" id="currentRetention">-</div><div class="kpi-label">í˜„ì¬ ìœ ì§€ìœ¨</div><div class="kpi-change up" id="retentionChange"></div></div>
                        <div class="kpi-card"><div class="kpi-value" id="totalPatients">-</div><div class="kpi-label">ì´ í™˜ì ìˆ˜</div><div class="kpi-change" id="patientChange"></div></div>
                        <div class="kpi-card"><div class="kpi-value" id="churnedPatients">-</div><div class="kpi-label">ì´íƒˆ í™˜ì</div><div class="kpi-change down" id="churnChange"></div></div>
                        <div class="kpi-card"><div class="kpi-value" id="newPatients">-</div><div class="kpi-label">ì‹ ê·œ í™˜ì</div><div class="kpi-change" id="newChange"></div></div>
                    </div>
                    <div class="chart-section">
                        <div class="chart-header"><h3 class="chart-title">ğŸ“Š ìœ ì§€ìœ¨ ë° ì´íƒˆìœ¨ ì¶”ì´</h3></div>
                        <canvas id="retentionTrendChart" style="max-height: 300px;"></canvas>
                    </div>
                    <div class="charts-row">
                        <div class="chart-section"><h3 class="chart-title">ğŸ“Š ì—°ë„ë³„ í™˜ì í˜„í™©</h3><canvas id="monthlyPatientsChart" style="max-height: 320px;"></canvas></div>
                        <div class="chart-section">
                            <h3 class="chart-title">â­• ìµœì‹  ì—°ë„ ìœ ì§€/ì´íƒˆ</h3>
                            <div class="donut-wrapper">
                                <canvas id="retentionDonutChart" style="max-height: 200px;"></canvas>
                                <div class="donut-center">
                                    <div class="donut-center-label">ìœ ì§€ìœ¨</div>
                                    <div class="donut-center-value" id="donutCenterValue">-</div>
                                    <div class="donut-center-sub">ì´íƒˆ</div>
                                    <div class="donut-center-sub-value" id="donutSubValue">-</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="data-table-section">
                        <h3 class="chart-title" style="margin-bottom: 16px;">ğŸ“‹ ì—°ë„ë³„ ìƒì„¸ ë°ì´í„°</h3>
                        <table class="data-table"><thead><tr><th>ì—°ë„</th><th style="text-align: center;">ì´ì›” í™˜ì</th><th style="text-align: center;">ì´íƒˆ í™˜ì</th><th style="text-align: center;">ì´ í™˜ììˆ˜</th><th style="text-align: center;">ìœ ì§€ìœ¨</th><th style="text-align: center;">ì‹¤ì </th></tr></thead><tbody id="analysisTableBody"></tbody></table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // ==================== Firebase ì´ˆê¸°í™” ====================
        const firebaseConfig = {
            apiKey: "AIzaSyDrU3rYs4fxlMkr8r0sjo70Mt0Al-HUtyg",
            authDomain: "apseoncare-platform.firebaseapp.com",
            projectId: "apseoncare-platform",
            storageBucket: "apseoncare-platform.firebasestorage.app",
            messagingSenderId: "515333523928",
            appId: "1:515333523928:web:e19a9db63c522d8484caad"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // ì „ì—­ ë³€ìˆ˜
        let retentionTrendChart = null, monthlyPatientsChart = null, retentionDonutChart = null;
        let selectedFiles = [], currentUser = null;
        let growthCharts = {}, growthSelectedFiles = [];

        // ==================== ë¡œê·¸ì¸ ====================
        auth.onAuthStateChanged(async (user) => {
            if (!user) { window.location.href = 'apsencare_login_firebase.html'; return; }
            await loadUserInfo(user.uid);
        });

        async function loadUserInfo(uid) {
            try {
                const userDoc = await db.collection('users').doc(uid).get();
                if (userDoc.exists) {
                    const d = userDoc.data();
                    currentUser = { ...d, uid };
                    document.getElementById('userName').textContent = d.name || d.email;
                    document.getElementById('userAvatar').textContent = d.name ? d.name.charAt(0) : '?';
                    document.getElementById('userRole').textContent = d.userType === 'admin' ? 'ê´€ë¦¬ì' : 'íŒŒíŠ¸ë„ˆ ë³‘ì›';
                }
            } catch (e) { console.error('ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ì˜¤ë¥˜:', e); }
        }

        async function handleLogout() {
            if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) { await auth.signOut(); window.location.href = 'apsencare_login_firebase.html'; }
        }

        // ====================================================================
        //  Firestore í†µê³„ ê²°ê³¼ê°’ ì €ì¥ (ê°œì¸ì •ë³´ ì—†ìŒ, ì§‘ê³„ í†µê³„ë§Œ)
        // ====================================================================
        async function saveGrowthStats(data, facilityLabel) {
            if (!currentUser || !currentUser.hospitalId) {
                console.warn('âš ï¸ ì‚¬ìš©ì ì •ë³´ ì—†ìŒ - í†µê³„ ì €ì¥ ê±´ë„ˆëœ€');
                return;
            }
            try {
                const latest = data[data.length - 1];
                const prev = data.length >= 2 ? data[data.length - 2] : null;
                const latestYoY = data.find(d => d.year === latest.year - 1 && d.month === latest.month);

                // YoY ì„±ì¥ë¥  ê³„ì‚°
                let yoyGrowth = null;
                if (latestYoY && latestYoY.sunap > 0) {
                    yoyGrowth = parseFloat(((latest.sunap - latestYoY.sunap) / latestYoY.sunap * 100).toFixed(1));
                }

                // ì›”ë³„ ìš”ì•½ (ê°œì¸ì •ë³´ ì—†ëŠ” ì§‘ê³„ê°’ë§Œ)
                const monthlySummary = data.map(d => ({
                    year: d.year,
                    month: d.month,
                    label: d.label,
                    sunap: d.sunap,              // ìˆ˜ë‚©í•©ê³„
                    patients: d.patients,         // ë‚´ì›ê±´ìˆ˜
                    perPatient: d.perPatient,     // ê°ë‹¨ê°€
                    nonInsRatio: parseFloat(d.nonInsRatio.toFixed(1)),  // ë¹„ê¸‰ì—¬ ë¹„ìœ¨
                    totalFee: d.totalFee,         // ì´ì§„ë£Œë¹„
                    copay: d.copay,               // ë³¸ì¸ë¶€ë‹´ê¸ˆ
                    nhis: d.nhis,                 // ê³µë‹¨ë¶€ë‹´ê¸ˆ
                    nonIns: d.nonIns              // ë¹„ê¸‰ì—¬
                }));

                const statsDoc = {
                    hospitalId: currentUser.hospitalId,
                    hospitalName: currentUser.hospitalName || currentUser.name || '',
                    analysisType: 'growth',
                    // í•µì‹¬ KPI
                    latestMonth: latest.label,
                    latestSunap: latest.sunap,
                    latestPatients: latest.patients,
                    latestPerPatient: latest.perPatient,
                    latestNonInsRatio: parseFloat(latest.nonInsRatio.toFixed(1)),
                    yoyGrowth: yoyGrowth,
                    momGrowth: prev && prev.sunap > 0 ? parseFloat(((latest.sunap - prev.sunap) / prev.sunap * 100).toFixed(1)) : null,
                    // ë¶„ì„ ë²”ìœ„
                    periodStart: data[0].label,
                    periodEnd: latest.label,
                    totalMonths: data.length,
                    facilityType: facilityLabel || 'ë³‘ì›(40:60)',
                    // ì›”ë³„ ìƒì„¸ (ì§‘ê³„ê°’ë§Œ)
                    monthlySummary: monthlySummary,
                    // ë©”íƒ€
                    analyzedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    analyzedBy: currentUser.uid
                };

                await db.collection('hospitalStats').doc(currentUser.hospitalId)
                    .collection('growth').add(statsDoc);

                // ìµœì‹  ìš”ì•½ë„ ë³‘ì› ë¬¸ì„œì— ì—…ë°ì´íŠ¸
                await db.collection('hospitalStats').doc(currentUser.hospitalId).set({
                    hospitalId: currentUser.hospitalId,
                    hospitalName: currentUser.hospitalName || currentUser.name || '',
                    lastGrowthAnalysis: {
                        latestMonth: latest.label,
                        sunap: latest.sunap,
                        yoyGrowth: yoyGrowth,
                        patients: latest.patients,
                        perPatient: latest.perPatient,
                        nonInsRatio: parseFloat(latest.nonInsRatio.toFixed(1)),
                        analyzedAt: firebase.firestore.FieldValue.serverTimestamp()
                    },
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });

                console.log('âœ… ìˆ˜ë‚© ì„±ì¥ë¥  í†µê³„ Firestore ì €ì¥ ì™„ë£Œ');
                showToast('ğŸ“Š ë¶„ì„ ê²°ê³¼ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
            } catch (err) {
                console.error('âŒ ìˆ˜ë‚© í†µê³„ ì €ì¥ ì‹¤íŒ¨:', err);
                // ì €ì¥ ì‹¤íŒ¨í•´ë„ ë¶„ì„ ê²°ê³¼ í‘œì‹œëŠ” ìœ ì§€
            }
        }

        async function saveRetentionStats(analysisData) {
            if (!currentUser || !currentUser.hospitalId) {
                console.warn('âš ï¸ ì‚¬ìš©ì ì •ë³´ ì—†ìŒ - í†µê³„ ì €ì¥ ê±´ë„ˆëœ€');
                return;
            }
            try {
                const { years, yearlyStats, latestRetentionRate, totalUniquePatients } = analysisData;
                const latestYear = years[years.length - 1];
                const latestStat = yearlyStats[latestYear];

                // ì—°ë„ë³„ ìš”ì•½ (ê°œì¸ì •ë³´ ì—†ëŠ” ì§‘ê³„ê°’ë§Œ)
                const yearlySummary = years.map(y => ({
                    year: y,
                    totalPatients: yearlyStats[y].totalPatients,
                    retainedFromPrevious: yearlyStats[y].retainedFromPrevious,
                    newPatients: yearlyStats[y].newPatients,
                    churned: yearlyStats[y].churned,
                    retentionRate: yearlyStats[y].retentionRate
                }));

                const statsDoc = {
                    hospitalId: currentUser.hospitalId,
                    hospitalName: currentUser.hospitalName || currentUser.name || '',
                    analysisType: 'retention',
                    // í•µì‹¬ KPI
                    latestRetentionRate: latestRetentionRate,
                    latestChurnRate: latestRetentionRate !== 'ì‹ ê·œ' ? parseFloat((100 - parseFloat(latestRetentionRate)).toFixed(1)) : null,
                    totalUniquePatients: totalUniquePatients,
                    latestChurned: latestStat.churned,
                    latestNewPatients: latestStat.newPatients,
                    // ë¶„ì„ ë²”ìœ„
                    periodStart: years[0] + 'ë…„',
                    periodEnd: latestYear + 'ë…„',
                    totalYears: years.length,
                    // ì—°ë„ë³„ ìƒì„¸ (ì§‘ê³„ê°’ë§Œ)
                    yearlySummary: yearlySummary,
                    // ë©”íƒ€
                    analyzedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    analyzedBy: currentUser.uid
                };

                await db.collection('hospitalStats').doc(currentUser.hospitalId)
                    .collection('retention').add(statsDoc);

                // ìµœì‹  ìš”ì•½ë„ ë³‘ì› ë¬¸ì„œì— ì—…ë°ì´íŠ¸
                await db.collection('hospitalStats').doc(currentUser.hospitalId).set({
                    hospitalId: currentUser.hospitalId,
                    hospitalName: currentUser.hospitalName || currentUser.name || '',
                    lastRetentionAnalysis: {
                        retentionRate: latestRetentionRate,
                        churnRate: latestRetentionRate !== 'ì‹ ê·œ' ? parseFloat((100 - parseFloat(latestRetentionRate)).toFixed(1)) : null,
                        totalPatients: totalUniquePatients,
                        churned: latestStat.churned,
                        analyzedAt: firebase.firestore.FieldValue.serverTimestamp()
                    },
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });

                console.log('âœ… ìœ ì§€ìœ¨/ì´íƒˆìœ¨ í†µê³„ Firestore ì €ì¥ ì™„ë£Œ');
                showToast('ğŸ“Š ë¶„ì„ ê²°ê³¼ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
            } catch (err) {
                console.error('âŒ ìœ ì§€ìœ¨ í†µê³„ ì €ì¥ ì‹¤íŒ¨:', err);
            }
        }

        // ==================== ì´ˆê¸°í™” ====================
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('uploadBtn').addEventListener('click', () => document.getElementById('fileInput').click());
            document.getElementById('fileInput').addEventListener('change', handleFileSelect);
            document.getElementById('analyzeBtn').addEventListener('click', startAnalysis);
            document.getElementById('growthUploadBtn').addEventListener('click', () => document.getElementById('growthFileInput').click());
            document.getElementById('growthFileInput').addEventListener('change', handleGrowthFileSelect);
            document.getElementById('growthAnalyzeBtn').addEventListener('click', startGrowthAnalysis);
        });

        // ==================== íƒ­ ì „í™˜ ====================
        function switchMainTab(tabId) {
            document.querySelectorAll('.main-tab').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById(tabId + '-tab').classList.add('active');
        }
        function switchGrowthSub(subId) {
            document.querySelectorAll('.sub-tab').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            document.querySelectorAll('.sub-content').forEach(c => c.classList.remove('active'));
            document.getElementById(subId + '-sub').classList.add('active');
        }

        // ====================================================================
        //  ìˆ˜ë‚©ì•¡ ì„±ì¥ë¥  - ì²´í¬ë¦¬ìŠ¤íŠ¸
        // ====================================================================
        function updateGrowthChecklist() {
            const checks = [];
            for (let i = 1; i <= 6; i++) checks.push(document.getElementById('gCheck' + i).checked);
            document.querySelectorAll('#growthChecklist .checklist-item').forEach((item, idx) => {
                item.querySelector('.warning-icon').textContent = checks[idx] ? 'âœ…' : 'âŒ';
            });
            const allChecked = checks.every(c => c);
            const cl = document.getElementById('growthChecklist');
            const btn = document.getElementById('growthUploadBtn');
            if (allChecked) { cl.classList.add('complete'); btn.disabled = false; btn.textContent = 'ğŸ“¤ ì›”ë³„ ìˆ˜ë‚©í†µê³„ íŒŒì¼ ì„ íƒí•˜ê¸° (ë‹¤ì¤‘ ì„ íƒ ê°€ëŠ¥)'; }
            else { cl.classList.remove('complete'); btn.disabled = true; btn.textContent = 'ğŸ”’ ë³´ì•ˆ ì²´í¬ë¦¬ìŠ¤íŠ¸ë¥¼ ë¨¼ì € í™•ì¸í•´ì£¼ì„¸ìš”'; }
        }

        // ====================================================================
        //  ì˜ë£Œê¸°ê´€ ìœ í˜• ì„ íƒ (ë³‘ì›/ì˜ì›)
        // ====================================================================
        function getSelectedCopayRatio() {
            const val = document.querySelector('input[name="facilityType"]:checked').value;
            return val === 'hospital' ? 0.4 : 0.3;
        }
        function updateFacilityType() {
            const isHospital = document.querySelector('input[name="facilityType"]:checked').value === 'hospital';
            const hospEl = document.getElementById('facilityHospital');
            const clinicEl = document.getElementById('facilityClinic');
            hospEl.style.borderColor = isHospital ? '#ec4899' : '#e2e8f0';
            hospEl.style.background = isHospital ? '#fdf2f8' : 'white';
            clinicEl.style.borderColor = isHospital ? '#e2e8f0' : '#6366f1';
            clinicEl.style.background = isHospital ? 'white' : '#eef2ff';
            const pct = isHospital ? '40' : '30';
            const nhisRatio = isHospital ? '60' : '70';
            const ratio = isHospital ? 0.4 : 0.3;
            document.getElementById('facilityDesc').innerHTML = `ğŸ’¡ ê³µë‹¨ë¶€ë‹´ê¸ˆ = ë³¸ì¸ë¶€ë‹´ê¸ˆ Ã· ${ratio} Ã— ${(1-ratio).toFixed(1)} ìœ¼ë¡œ ì¶”ì‚°ë©ë‹ˆë‹¤ <span style="font-weight:600;">(ë³¸ì¸ë¶€ë‹´ ${pct}% : ê³µë‹¨ë¶€ë‹´ ${nhisRatio}%)</span>`;
        }

        // ====================================================================
        //  ìˆ˜ë‚©ì•¡ ì„±ì¥ë¥  - íŒŒì¼ ì—…ë¡œë“œ (ë‹¤ì¤‘ íŒŒì¼)
        // ====================================================================
        function handleGrowthFileSelect(e) {
            const newFiles = Array.from(e.target.files);
            if (!newFiles.length) return;
            // Append to existing selection (avoid duplicates by name)
            newFiles.forEach(f => {
                if (!growthSelectedFiles.some(ex => ex.name === f.name)) growthSelectedFiles.push(f);
            });
            renderGrowthFileList();
        }
        function renderGrowthFileList() {
            const listEl = document.getElementById('growthFileList');
            if (!growthSelectedFiles.length) {
                document.getElementById('growthUploadedFiles').style.display = 'none';
                return;
            }
            // Sort files by name for readability
            growthSelectedFiles.sort((a, b) => a.name.localeCompare(b.name));
            let html = `<div style="color:#6b7280;font-size:12px;margin-bottom:6px;">ì´ ${growthSelectedFiles.length}ê°œ íŒŒì¼ ì„ íƒë¨</div>`;
            growthSelectedFiles.forEach((f, i) => {
                html += `<div class="file-item"><span>ğŸ“„ ${f.name}</span><span style="color:#6b7280;font-size:12px;">(${(f.size/1024).toFixed(1)} KB)</span><button class="remove-btn" onclick="removeGrowthFileAt(${i})">âœ•</button></div>`;
            });
            listEl.innerHTML = html;
            document.getElementById('growthUploadedFiles').style.display = 'block';
        }
        function removeGrowthFileAt(idx) {
            growthSelectedFiles.splice(idx, 1);
            renderGrowthFileList();
            if (!growthSelectedFiles.length) document.getElementById('growthFileInput').value = '';
        }
        function removeGrowthFile() {
            growthSelectedFiles = [];
            document.getElementById('growthUploadedFiles').style.display = 'none';
            document.getElementById('growthFileInput').value = '';
        }

        // ====================================================================
        //  ìˆ˜ë‚©ì•¡ ì„±ì¥ë¥  - ë¶„ì„ ì‹œì‘
        // ====================================================================
        async function startGrowthAnalysis() {
            if (!growthSelectedFiles.length) { showToast('íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error'); return; }
            showLoading(`${growthSelectedFiles.length}ê°œ íŒŒì¼ ë¶„ì„ ì¤‘...`);
            try {
                // Parse all files and merge monthly data
                const allMonthly = [];
                for (const file of growthSelectedFiles) {
                    const parsed = await parseRevenueExcel(file);
                    parsed.forEach(p => {
                        // Check if month already exists (from another file), merge if so
                        const existing = allMonthly.find(e => e.year === p.year && e.month === p.month);
                        if (existing) {
                            existing.copay += p.copay;
                            existing.nonIns += p.nonIns;
                            existing.totalCollect += p.totalCollect;
                            p.chartNos.forEach(c => existing.chartNos.add(c));
                        } else {
                            allMonthly.push(p);
                        }
                    });
                }
                if (allMonthly.length < 2) { hideLoading(); showToast('ìµœì†Œ 2ê°œì›” ì´ìƒì˜ ë°ì´í„°ê°€ í•„ìš”í•©ë‹ˆë‹¤. ë” ë§ì€ íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.', 'error'); return; }
                allMonthly.sort((a, b) => a.year !== b.year ? a.year - b.year : a.month - b.month);
                // Calculate derived fields (ì„ íƒëœ ì˜ë£Œê¸°ê´€ ìœ í˜• ë¹„ìœ¨ ì ìš©)
                const COPAY_RATIO = getSelectedCopayRatio();
                const facilityLabel = COPAY_RATIO === 0.4 ? 'ë³‘ì›(40:60)' : 'ì˜ì›(30:70)';
                allMonthly.forEach(d => {
                    d.patients = d.chartNos.size;       // ë‚´ì›ê±´ìˆ˜ (ì°¨íŠ¸ë²ˆí˜¸+ì§„ë£Œì¼ ê³ ìœ  ì¡°í•©)
                    d.nhis = Math.round(d.copay / COPAY_RATIO * (1 - COPAY_RATIO)); // ê³µë‹¨ë¶€ë‹´ê¸ˆ ì—­ì‚°
                    d.insFee = d.copay + d.nhis;         // ë³´í—˜ë¹„ìš© = ë³¸ì¸ë¶€ë‹´ + ê³µë‹¨ë¶€ë‹´
                    d.totalFee = d.insFee + d.nonIns;    // ì´ì§„ë£Œë¹„ = ë³´í—˜ë¹„ìš© + ë¹„ê¸‰ì—¬
                    d.sunap = d.copay + d.nonIns;        // ìˆ˜ë‚©í•©ê³„ = ë³¸ì¸ë¶€ë‹´ + ë¹„ê¸‰ì—¬
                    d.perPatient = d.patients > 0 ? Math.round(d.totalFee / d.patients) : 0; // ê°ë‹¨ê°€ = ì´ì§„ë£Œë¹„ Ã· ë‚´ì›ê±´ìˆ˜
                    d.nonInsRatio = d.totalFee > 0 ? (d.nonIns / d.totalFee * 100) : 0; // ë¹„ê¸‰ì—¬ ë¹„ìœ¨ (ì´ì§„ë£Œë¹„ ëŒ€ë¹„)
                    delete d.chartNos; // ì§„ë£Œì¼Â·ì°¨íŠ¸ë²ˆí˜¸ ì¡°í•© ë©”ëª¨ë¦¬ì—ì„œ ì œê±°
                });
                hideLoading();
                showGrowthResults(allMonthly, facilityLabel);
                showToast(`ìˆ˜ë‚©ì•¡ ë¶„ì„ ì™„ë£Œ! (${allMonthly.length}ê°œì›”) ğŸ‰`, 'success');
                // ğŸ”¥ Firestoreì— í†µê³„ ê²°ê³¼ê°’ ì €ì¥ (ê°œì¸ì •ë³´ ì—†ìŒ)
                saveGrowthStats(allMonthly, facilityLabel);
            } catch (error) { hideLoading(); showToast('ë¶„ì„ ì˜¤ë¥˜: ' + error.message, 'error'); console.error(error); }
        }

        // ====================================================================
        //  Excel íŒŒì‹± (ìˆ˜ë‚©í†µê³„ - ê±´ë³„ íŠ¸ëœì­ì…˜ ë°ì´í„°)
        // ====================================================================
        async function parseRevenueExcel(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const wb = XLSX.read(e.target.result, { type: 'binary' });
                        const monthlyMap = {}; // key: "YYYY-MM"

                        wb.SheetNames.forEach(sheetName => {
                            // 1) ì‹œíŠ¸ ì´ë¦„ ë˜ëŠ” íŒŒì¼ëª…ì—ì„œ ì—°ì›” ì¶”ì¶œ
                            let dateInfo = extractDateFromSheetName(sheetName);
                            if (!dateInfo) dateInfo = extractDateFromFileName(file.name);
                            if (!dateInfo) return;

                            const key = `${dateInfo.year}-${String(dateInfo.month).padStart(2, '0')}`;
                            if (!monthlyMap[key]) {
                                monthlyMap[key] = {
                                    year: dateInfo.year,
                                    month: dateInfo.month,
                                    label: `${dateInfo.year}.${dateInfo.month}ì›”`,
                                    copay: 0,    // ë³´í—˜ë³¸ì¸ë¶€ë‹´ ì§„ë£Œê¸ˆì•¡ í•©
                                    nonIns: 0,   // ë¹„ê¸‰ì—¬ ì§„ë£Œê¸ˆì•¡ í•©
                                    totalCollect: 0, // ì´ìˆ˜ë‚©ì•¡ í•© (ì‹¤ì œ ìˆ˜ë‚©, í™˜ë¶ˆ í¬í•¨)
                                    chartNos: new Set()
                                };
                            }
                            const rec = monthlyMap[key];

                            // 2) ì‹œíŠ¸ ë°ì´í„°ë¥¼ í–‰ë³„ë¡œ íŒŒì‹±
                            const sheet = wb.Sheets[sheetName];
                            const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                            if (rows.length < 2) return;

                            // 3) í—¤ë” í–‰ì—ì„œ ì»¬ëŸ¼ ì¸ë±ìŠ¤ ìë™ ë§¤í•‘
                            const header = rows[0].map(h => String(h || '').trim());
                            const colIdx = {
                                sunapType: -1,  // ìˆ˜ë‚©êµ¬ë¶„ (F)
                                amount: -1,     // ì§„ë£Œê¸ˆì•¡ (G)
                                chartNo: -1,    // ì°¨íŠ¸ë²ˆí˜¸ (D)
                                totalCollect: -1, // ì´ìˆ˜ë‚©ì•¡ (H)
                                treatDate: -1,  // ì§„ë£Œì¼ (C)
                            };
                            header.forEach((h, i) => {
                                const hl = h.toLowerCase();
                                if (h === 'ìˆ˜ë‚©êµ¬ë¶„' || hl.includes('ìˆ˜ë‚©êµ¬ë¶„')) colIdx.sunapType = i;
                                else if (h === 'ì§„ë£Œê¸ˆì•¡' || hl.includes('ì§„ë£Œê¸ˆì•¡')) colIdx.amount = i;
                                else if (h === 'ì´ìˆ˜ë‚©ì•¡' || hl.includes('ì´ìˆ˜ë‚©ì•¡')) colIdx.totalCollect = i;
                                else if (h === 'ì°¨íŠ¸ë²ˆí˜¸' || hl.includes('ì°¨íŠ¸ë²ˆí˜¸') || hl.includes('ì°¨íŠ¸no')) colIdx.chartNo = i;
                                else if (h === 'ì§„ë£Œì¼' || hl.includes('ì§„ë£Œì¼')) colIdx.treatDate = i;
                            });

                            // í•„ìˆ˜ ì»¬ëŸ¼ í™•ì¸
                            if (colIdx.sunapType < 0 || colIdx.amount < 0) {
                                console.warn(`ì‹œíŠ¸ "${sheetName}": ìˆ˜ë‚©êµ¬ë¶„ ë˜ëŠ” ì§„ë£Œê¸ˆì•¡ ì»¬ëŸ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ`);
                                return;
                            }

                            // 4) ë°ì´í„° í–‰ ì²˜ë¦¬
                            for (let r = 1; r < rows.length; r++) {
                                const row = rows[r];
                                if (!row || row.length < 2) continue;

                                const sunapType = String(row[colIdx.sunapType] || '').trim();
                                const amount = parseFloat(String(row[colIdx.amount] || '0').replace(/,/g, '')) || 0;
                                const chartNo = colIdx.chartNo >= 0 ? String(row[colIdx.chartNo] || '').trim() : '';
                                const treatDate = colIdx.treatDate >= 0 ? String(row[colIdx.treatDate] || '').trim() : '';
                                const collect = colIdx.totalCollect >= 0
                                    ? (parseFloat(String(row[colIdx.totalCollect] || '0').replace(/,/g, '')) || 0)
                                    : 0;

                                // ë‚´ì›ê±´ìˆ˜: ì°¨íŠ¸ë²ˆí˜¸+ì§„ë£Œì¼ ì¡°í•©ìœ¼ë¡œ ë™ì¼ í™˜ì ê°™ì€ë‚  ì¤‘ë³µ ì œê±°
                                if (chartNo && treatDate) rec.chartNos.add(chartNo + '|' + treatDate);

                                // ì´ìˆ˜ë‚©ì•¡ì€ í™˜ë¶ˆ(ìŒìˆ˜) í¬í•¨ ì „ì²´ í•©ì‚°
                                rec.totalCollect += collect;

                                // ì§„ë£Œê¸ˆì•¡: 0 ì´í•˜ëŠ” í•©ì‚° ìŠ¤í‚µ
                                if (amount <= 0) continue;

                                if (sunapType.includes('ë³¸ì¸ë¶€ë‹´') || sunapType === 'ë³´í—˜ë³¸ì¸ë¶€ë‹´') {
                                    rec.copay += amount;
                                } else if (sunapType.includes('ë¹„ê¸‰ì—¬')) {
                                    rec.nonIns += amount;
                                }
                            }
                        });

                        resolve(Object.values(monthlyMap).filter(d => d.copay > 0 || d.nonIns > 0));
                    } catch (err) { reject(err); }
                };
                reader.readAsBinaryString(file);
            });
        }

        function extractDateFromSheetName(name) {
            name = name.trim();
            let m = name.match(/(\d{4})\s*[\.\-\/]\s*(\d{1,2})\s*ì›”?/);
            if (m) return { year: parseInt(m[1]), month: parseInt(m[2]) };
            m = name.match(/(\d{4})\s*ë…„\s*(\d{1,2})\s*ì›”?/);
            if (m) return { year: parseInt(m[1]), month: parseInt(m[2]) };
            m = name.match(/(\d{2})\s*[\.\-\/]\s*(\d{1,2})/);
            if (m) { const yr = parseInt(m[1]); return { year: yr < 50 ? 2000+yr : 1900+yr, month: parseInt(m[2]) }; }
            m = name.match(/(\d{4})\s*[\.\-]?\s*(\d{2})/);
            if (m) { const mo = parseInt(m[2]); if (mo >= 1 && mo <= 12) return { year: parseInt(m[1]), month: mo }; }
            return null;
        }

        function extractDateFromFileName(filename) {
            // íŒŒì¼ëª… íŒ¨í„´: 2024-01-01_2024-01-31ìˆ˜ë‚©í†µê³„.xlsx
            let m = filename.match(/(\d{4})-(\d{2})-\d{2}[_~](\d{4})-(\d{2})-\d{2}/);
            if (m) return { year: parseInt(m[1]), month: parseInt(m[2]) };
            // íŒŒì¼ëª… íŒ¨í„´: 202401_ìˆ˜ë‚©í†µê³„.xlsx
            m = filename.match(/(\d{4})(\d{2})/);
            if (m) { const mo = parseInt(m[2]); if (mo >= 1 && mo <= 12) return { year: parseInt(m[1]), month: mo }; }
            return null;
        }

        // ====================================================================
        //  ìˆ˜ë‚© ë¶„ì„ ê²°ê³¼ í‘œì‹œ
        // ====================================================================
        function showGrowthResults(data, facilityLabel) {
            document.getElementById('growthResults').classList.add('show');
            const latest = data[data.length - 1];
            const prev = data.length >= 2 ? data[data.length - 2] : null;
            const latestYoY = data.find(d => d.year === latest.year - 1 && d.month === latest.month);

            const fmtWon = v => { if (v >= 1e8) return (v/1e8).toFixed(2)+'ì–µ'; if (v >= 1e4) return (v/1e4).toFixed(0)+'ë§Œ'; return v.toLocaleString(); };
            const fmtM = v => v >= 1e4 ? (v/1e4).toFixed(1)+'ë§Œ' : v.toLocaleString();

            document.getElementById('kpiTotalRevenue').textContent = fmtWon(latest.sunap);
            document.getElementById('kpiPatientCount').textContent = latest.patients.toLocaleString() + 'ê±´';
            document.getElementById('kpiPerPatient').textContent = fmtM(latest.perPatient) + 'ì›';
            document.getElementById('kpiNonInsRatio').textContent = latest.nonInsRatio.toFixed(1) + '%';

            if (latestYoY && latestYoY.sunap > 0) {
                const g = ((latest.sunap - latestYoY.sunap) / latestYoY.sunap * 100).toFixed(1);
                document.getElementById('kpiYoyGrowth').textContent = (g > 0 ? '+' : '') + g + '%';
                document.getElementById('kpiYoyGrowth').style.color = g >= 0 ? '#10b981' : '#ef4444';
                document.getElementById('kpiYoyGrowthChange').textContent = `ì „ë…„ ë™ì›”(${latestYoY.label}) ëŒ€ë¹„`;
            } else {
                document.getElementById('kpiYoyGrowth').textContent = '-';
                document.getElementById('kpiYoyGrowthChange').textContent = 'ì „ë…„ ë™ì›” ë°ì´í„° ì—†ìŒ';
            }

            if (prev) {
                const pctChg = (cur, prv) => prv > 0 ? ((cur - prv) / prv * 100).toFixed(1) : '0';
                const setChg = (id, val) => { const el = document.getElementById(id); el.textContent = `ì „ì›” ëŒ€ë¹„ ${val > 0 ? '+' : ''}${val}%`; el.className = 'kpi-change ' + (val >= 0 ? 'up' : 'down'); };
                setChg('kpiTotalRevenueChange', pctChg(latest.sunap, prev.sunap));
                setChg('kpiPatientCountChange', pctChg(latest.patients, prev.patients));
                setChg('kpiPerPatientChange', pctChg(latest.perPatient, prev.perPatient));
                const rc = (latest.nonInsRatio - prev.nonInsRatio).toFixed(1);
                const el = document.getElementById('kpiNonInsRatioChange');
                el.textContent = `ì „ì›” ëŒ€ë¹„ ${rc > 0 ? '+' : ''}${rc}%p`;
                el.className = 'kpi-change ' + (rc >= 0 ? 'up' : 'down');
            }

            document.getElementById('growthBannerDesc').textContent = `${data[0].label} ~ ${latest.label} | ${data.length}ê°œì›” ë°ì´í„° ë¶„ì„ | ì ìš© ê¸°ì¤€: ${facilityLabel || 'ë³‘ì›(40:60)'}`;
            const ratioText = facilityLabel || 'ë³‘ì› 40:60';
            document.getElementById('nhisColumnHeader').innerHTML = `ê³µë‹¨ë¶€ë‹´ê¸ˆ<span style="color:#6366f1;font-size:10px;"> (${ratioText} ì¶”ì •)</span>`;
            renderGrowthCharts(data);
            renderGrowthTable(data);
        }

        // ====================================================================
        //  ì°¨íŠ¸ ë Œë”ë§ (ìˆ˜ë‚© ì„±ì¥ë¥ )
        // ====================================================================
        function renderGrowthCharts(data) {
            const labels = data.map(d => d.label);
            const C = { copay:'#6BC5A0', nhis:'#4F8FD8', nonIns:'#F2994A', total:'#1f2937', sunap:'#ec4899', perPat:'#8B5CF6', ratio:'#EB5757', patient:'#60A5FA' };
            Object.values(growthCharts).forEach(c => c && c.destroy());
            growthCharts = {};

            // 1) ìˆ˜ë‚© êµ¬ì„± ìŠ¤íƒ ë°”
            growthCharts.stacked = new Chart(document.getElementById('revenueStackedChart'), {
                type: 'bar', data: { labels, datasets: [
                    { label: 'ë³¸ì¸ë¶€ë‹´ê¸ˆ(ë³´í—˜)', data: data.map(d => d.copay), backgroundColor: C.copay, borderRadius: 2 },
                    { label: 'ë¹„ê¸‰ì—¬', data: data.map(d => d.nonIns), backgroundColor: C.nonIns, borderRadius: 2 }
                ]},
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top', labels: { usePointStyle: true, font: { size: 12 } } } },
                    scales: { x: { stacked: true, ticks: { font: { size: 11 }, maxRotation: 45 } }, y: { stacked: true, ticks: { callback: v => (v/1e4).toFixed(0)+'ë§Œ' } } } }
            });

            // 2) í•­ëª©ë³„ ë¼ì¸
            growthCharts.line = new Chart(document.getElementById('revenueLineChart'), {
                type: 'line', data: { labels, datasets: [
                    { label: 'ë³¸ì¸ë¶€ë‹´ê¸ˆ', data: data.map(d => d.copay), borderColor: C.copay, borderWidth: 2, tension: 0.3, pointRadius: 3, fill: false },
                    { label: 'ê³µë‹¨ë¶€ë‹´ê¸ˆ', data: data.map(d => d.nhis), borderColor: C.nhis, borderWidth: 2, tension: 0.3, pointRadius: 3, fill: false },
                    { label: 'ë¹„ê¸‰ì—¬', data: data.map(d => d.nonIns), borderColor: C.nonIns, borderWidth: 2, tension: 0.3, pointRadius: 3, fill: false }
                ]},
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top', labels: { usePointStyle: true, font: { size: 11 } } } },
                    scales: { x: { ticks: { font: { size: 10 }, maxRotation: 45 } }, y: { ticks: { callback: v => (v/1e4).toFixed(0)+'ë§Œ' } } } }
            });

            // 3) ì´ì§„ë£Œë¹„
            growthCharts.totalFee = new Chart(document.getElementById('totalFeeChart'), {
                type: 'line', data: { labels, datasets: [{ label: 'ì´ì§„ë£Œë¹„', data: data.map(d => d.totalFee), borderColor: C.total, backgroundColor: C.total+'15', borderWidth: 3, tension: 0.3, pointRadius: 4, pointBackgroundColor: C.total, fill: true }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } },
                    scales: { x: { ticks: { font: { size: 10 }, maxRotation: 45 } }, y: { ticks: { callback: v => (v/1e4).toFixed(0)+'ë§Œ' } } } }
            });

            // 4) ì—°ë„ë³„ ë¹„êµ íƒ­ ì´ˆê¸°í™”
            window._growthData = data; // ì—°ë„ ì„ íƒ ì‹œ ì¬ë Œë”ë§ìš©
            initYearComparison(data);

            // 5) ê°ë‹¨ê°€
            growthCharts.perPatient = new Chart(document.getElementById('perPatientChart'), {
                type: 'line', data: { labels, datasets: [{ label: 'ê°ë‹¨ê°€', data: data.map(d => d.perPatient), borderColor: C.perPat, backgroundColor: C.perPat+'15', borderWidth: 3, tension: 0.3, pointRadius: 4, pointBackgroundColor: C.perPat, fill: true }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } },
                    scales: { x: { ticks: { font: { size: 10 }, maxRotation: 45 } }, y: { ticks: { callback: v => (v/1e4).toFixed(1)+'ë§Œ' } } } }
            });

            // 6) ë¹„ê¸‰ì—¬ ë¹„ìœ¨ (30% ëª©í‘œì„  í¬í•¨)
            growthCharts.nonInsRatio = new Chart(document.getElementById('nonInsRatioChart'), {
                type: 'line', data: { labels, datasets: [
                    { label: 'ë¹„ê¸‰ì—¬ ë¹„ìœ¨', data: data.map(d => d.nonInsRatio), borderColor: C.ratio, backgroundColor: C.ratio+'15', borderWidth: 3, tension: 0.3, pointRadius: 4, pointBackgroundColor: data.map(d => d.nonInsRatio >= 30 ? '#16a34a' : '#ef4444'), fill: true },
                    { label: 'ëª©í‘œ 30%', data: data.map(() => 30), borderColor: '#16a34a', borderWidth: 2, borderDash: [8, 4], pointRadius: 0, fill: false }
                ] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top', labels: { usePointStyle: true, font: { size: 11 } } } },
                    scales: { x: { ticks: { font: { size: 10 }, maxRotation: 45 } }, y: { min: 0, max: 100, ticks: { callback: v => v+'%' } } } }
            });

            // 7) ë‚´ì›ê±´ìˆ˜ vs ê°ë‹¨ê°€
            growthCharts.volumePrice = new Chart(document.getElementById('volumePriceChart'), {
                type: 'bar', data: { labels, datasets: [
                    { label: 'ë‚´ì›ê±´ìˆ˜', data: data.map(d => d.patients), backgroundColor: C.patient+'60', borderColor: C.patient, borderWidth: 1, borderRadius: 4, yAxisID: 'y' },
                    { label: 'ê°ë‹¨ê°€', data: data.map(d => d.perPatient), type: 'line', borderColor: C.perPat, backgroundColor: C.perPat, borderWidth: 3, tension: 0.3, pointRadius: 4, pointBackgroundColor: C.perPat, yAxisID: 'y1' }
                ]},
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top', labels: { usePointStyle: true } } },
                    scales: { x: { ticks: { font: { size: 10 }, maxRotation: 45 } }, y: { position: 'left', title: { display: true, text: 'ë‚´ì›ê±´ìˆ˜' }, ticks: { callback: v => v+'ê±´' } },
                        y1: { position: 'right', title: { display: true, text: 'ê°ë‹¨ê°€' }, ticks: { callback: v => (v/1e4).toFixed(1)+'ë§Œ' }, grid: { drawOnChartArea: false } } } }
            });
        }

        function renderGrowthTable(data) {
            const fK = v => { const abs = Math.abs(v); const s = v < 0 ? '-' : ''; return abs >= 1e4 ? s+(abs/1e4).toFixed(0)+'ë§Œ' : s+abs.toLocaleString(); };
            document.getElementById('growthTableBody').innerHTML = data.map(d => {
                let rc = 'status-below'; if (d.nonInsRatio >= 40) rc = 'status-excellent'; else if (d.nonInsRatio >= 30) rc = 'status-good';
                return `<tr><td style="font-weight:600;">${d.label}</td><td style="text-align:right;">${fK(d.copay)}</td><td style="text-align:right;">${fK(d.nhis)}</td><td style="text-align:right;color:#F2994A;font-weight:600;">${fK(d.nonIns)}</td><td style="text-align:right;">${fK(d.totalFee)}</td><td style="text-align:right;">${d.patients.toLocaleString()}ê±´</td><td style="text-align:right;font-weight:600;color:#ec4899;">${fK(d.sunap)}</td><td style="text-align:right;">${fK(d.perPatient)}ì›</td><td style="text-align:center;"><span class="status-badge ${rc}">${d.nonInsRatio.toFixed(1)}%</span></td></tr>`;
            }).join('');
        }

        // ====================================================================
        //  ì—°ë„ë³„ ë¹„êµ ê¸°ëŠ¥
        // ====================================================================
        const yearColors = ['#6366f1', '#ec4899', '#f59e0b', '#10b981', '#ef4444', '#8b5cf6'];
        const yrCmpCharts = {};

        function initYearComparison(data) {
            const years = [...new Set(data.map(d => d.year))].sort();
            const box = document.getElementById('yearSelectorBox');
            box.innerHTML = years.map((y, i) => {
                const checked = i >= years.length - 2; // ìµœê·¼ 2ë…„ ê¸°ë³¸ ì„ íƒ
                const color = yearColors[i % yearColors.length];
                return `<label style="display:flex;align-items:center;gap:6px;padding:8px 14px;background:${checked?'white':'#f8fafc'};border:2px solid ${checked?color:'#e2e8f0'};border-radius:8px;cursor:pointer;transition:all 0.2s;" id="yrLabel_${y}">
                    <input type="checkbox" value="${y}" ${checked?'checked':''} onchange="onYearToggle()" style="accent-color:${color};width:16px;height:16px;">
                    <span style="font-weight:600;color:${color};font-size:13px;">${y}ë…„</span>
                </label>`;
            }).join('');
            renderYearComparison();
        }

        function onYearToggle() {
            // ì²´í¬ë°•ìŠ¤ ìƒíƒœì— ë”°ë¼ ë¼ë²¨ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
            const years = [...new Set(window._growthData.map(d => d.year))].sort();
            years.forEach((y, i) => {
                const label = document.getElementById('yrLabel_' + y);
                const cb = label.querySelector('input');
                const color = yearColors[i % yearColors.length];
                label.style.borderColor = cb.checked ? color : '#e2e8f0';
                label.style.background = cb.checked ? 'white' : '#f8fafc';
            });
            renderYearComparison();
        }

        function renderYearComparison() {
            const data = window._growthData;
            if (!data) return;
            const allYears = [...new Set(data.map(d => d.year))].sort();
            const checks = document.querySelectorAll('#yearSelectorBox input[type=checkbox]:checked');
            const selectedYears = [...checks].map(c => parseInt(c.value)).sort();
            if (selectedYears.length === 0) return;

            const months = ['1ì›”','2ì›”','3ì›”','4ì›”','5ì›”','6ì›”','7ì›”','8ì›”','9ì›”','10ì›”','11ì›”','12ì›”'];

            // ì—°ë„ë³„ ë°ì´í„° ì •ë¦¬ (month -> value)
            const byYear = {};
            selectedYears.forEach(y => {
                byYear[y] = {};
                data.filter(d => d.year === y).forEach(d => { byYear[y][d.month] = d; });
            });

            // ì°¨íŠ¸ ë°ì´í„°ì…‹ ìƒì„± í•¨ìˆ˜
            function makeDatasets(field, unit) {
                return selectedYears.map((y, i) => {
                    const ci = allYears.indexOf(y);
                    const color = yearColors[ci % yearColors.length];
                    return {
                        label: y + 'ë…„',
                        data: months.map((_, mi) => byYear[y][mi+1] ? byYear[y][mi+1][field] : null),
                        borderColor: color, backgroundColor: color + '20',
                        borderWidth: 3, tension: 0.3, pointRadius: 5,
                        pointBackgroundColor: color, fill: false, spanGaps: true
                    };
                });
            }

            // ì°¨íŠ¸ ê³µí†µ ì˜µì…˜
            function chartOpts(tickCb) {
                return { responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { position: 'top', labels: { usePointStyle: true, font: { size: 12 } } } },
                    scales: { x: { ticks: { font: { size: 11 } } }, y: { ticks: { callback: tickCb } } }
                };
            }

            // ê¸°ì¡´ ì°¨íŠ¸ ì œê±°
            Object.values(yrCmpCharts).forEach(c => c.destroy());

            // ìˆ˜ë‚©í•©ê³„ ë¹„êµ
            yrCmpCharts.sunap = new Chart(document.getElementById('yrCmpSunapChart'), {
                type: 'line', data: { labels: months, datasets: makeDatasets('sunap') },
                options: chartOpts(v => (v/1e4).toFixed(0)+'ë§Œ')
            });

            // ë‚´ì›ê±´ìˆ˜ ë¹„êµ
            yrCmpCharts.patient = new Chart(document.getElementById('yrCmpPatientChart'), {
                type: 'line', data: { labels: months, datasets: makeDatasets('patients') },
                options: chartOpts(v => v+'ê±´')
            });

            // ê°ë‹¨ê°€ ë¹„êµ
            yrCmpCharts.unit = new Chart(document.getElementById('yrCmpUnitChart'), {
                type: 'line', data: { labels: months, datasets: makeDatasets('perPatient') },
                options: chartOpts(v => (v/1e4).toFixed(1)+'ë§Œ')
            });

            // ë¹„ê¸‰ì—¬ë¹„ìœ¨ ë¹„êµ (30% ëª©í‘œì„  ì¶”ê°€)
            const ratioDs = makeDatasets('nonInsRatio');
            ratioDs.push({ label: 'ëª©í‘œ 30%', data: months.map(() => 30), borderColor: '#16a34a', borderWidth: 2, borderDash: [8, 4], pointRadius: 0, fill: false });
            yrCmpCharts.ratio = new Chart(document.getElementById('yrCmpRatioChart'), {
                type: 'line', data: { labels: months, datasets: ratioDs },
                options: { responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { position: 'top', labels: { usePointStyle: true, font: { size: 12 } } } },
                    scales: { x: { ticks: { font: { size: 11 } } }, y: { min: 0, ticks: { callback: v => v+'%' } } }
                }
            });

            // ë¹„êµ í…Œì´ë¸” ë Œë”ë§
            renderYearCmpTable(selectedYears, byYear, months);
        }

        function renderYearCmpTable(years, byYear, months) {
            const fK = v => { if (v === null || v === undefined) return '-'; const abs = Math.abs(v); const s = v < 0 ? '-' : ''; return abs >= 1e4 ? s+(abs/1e4).toFixed(0)+'ë§Œ' : s+abs.toLocaleString(); };
            // í—¤ë”: ì›” | ì—°ë„1-ìˆ˜ë‚© | ì—°ë„1-ê±´ìˆ˜ | ì—°ë„1-ë¹„ê¸‰ì—¬% | ì—°ë„2-ìˆ˜ë‚© | ...
            let headHtml = '<tr><th rowspan="2" style="vertical-align:middle;">ì›”</th>';
            years.forEach((y, i) => {
                const ci = [...new Set(window._growthData.map(d => d.year))].sort().indexOf(y);
                const color = yearColors[ci % yearColors.length];
                headHtml += `<th colspan="4" style="text-align:center;color:${color};border-bottom:2px solid ${color};">${y}ë…„</th>`;
            });
            headHtml += '</tr><tr>';
            years.forEach(() => {
                headHtml += '<th style="text-align:right;font-size:11px;">ìˆ˜ë‚©</th><th style="text-align:right;font-size:11px;">ë‚´ì›</th><th style="text-align:right;font-size:11px;">ê°ë‹¨ê°€</th><th style="text-align:center;font-size:11px;">ë¹„ê¸‰ì—¬%</th>';
            });
            headHtml += '</tr>';
            document.getElementById('yrCmpTableHead').innerHTML = headHtml;

            // ë°”ë””
            let bodyHtml = '';
            for (let m = 1; m <= 12; m++) {
                bodyHtml += `<tr><td style="font-weight:600;">${m}ì›”</td>`;
                years.forEach(y => {
                    const d = byYear[y][m];
                    if (d) {
                        let rc = 'status-below'; if (d.nonInsRatio >= 40) rc = 'status-excellent'; else if (d.nonInsRatio >= 30) rc = 'status-good';
                        bodyHtml += `<td style="text-align:right;">${fK(d.sunap)}</td>`;
                        bodyHtml += `<td style="text-align:right;">${d.patients.toLocaleString()}ê±´</td>`;
                        bodyHtml += `<td style="text-align:right;">${fK(d.perPatient)}ì›</td>`;
                        bodyHtml += `<td style="text-align:center;"><span class="status-badge ${rc}">${d.nonInsRatio.toFixed(1)}%</span></td>`;
                    } else {
                        bodyHtml += '<td style="text-align:center;color:#d1d5db;">-</td>'.repeat(4);
                    }
                });
                bodyHtml += '</tr>';
            }
            document.getElementById('yrCmpTableBody').innerHTML = bodyHtml;
        }

        // ====================================================================
        //  ìœ ì§€ìœ¨/ì´íƒˆìœ¨ íƒ­ (ê¸°ì¡´ ë¡œì§ ê·¸ëŒ€ë¡œ)
        // ====================================================================
        function updateChecklist() {
            const checks = [document.getElementById('check1').checked, document.getElementById('check2').checked, document.getElementById('check3').checked, document.getElementById('check4').checked, document.getElementById('check5').checked, document.getElementById('check6').checked];
            document.querySelectorAll('#uploadChecklist .checklist-item').forEach((item, i) => { item.querySelector('.warning-icon').textContent = checks[i] ? 'âœ…' : 'âŒ'; });
            const allChecked = checks.every(c => c);
            const cl = document.getElementById('uploadChecklist'), btn = document.getElementById('uploadBtn');
            if (allChecked) { cl.classList.add('complete'); btn.disabled = false; btn.textContent = 'ğŸ“¤ íŒŒì¼ ì„ íƒí•˜ê¸°'; }
            else { cl.classList.remove('complete'); btn.disabled = true; btn.textContent = 'ğŸ”’ ì²´í¬ë¦¬ìŠ¤íŠ¸ë¥¼ ë¨¼ì € í™•ì¸í•´ì£¼ì„¸ìš”'; }
        }

        function handleFileSelect(e) {
            selectedFiles = Array.from(e.target.files);
            if (selectedFiles.length === 0) return;
            document.getElementById('fileList').innerHTML = selectedFiles.map((f, i) => `<div class="file-item"><span>ğŸ“„ ${f.name}</span><span style="color:#6b7280;font-size:12px;">(${(f.size/1024).toFixed(1)} KB)</span><button class="remove-btn" onclick="removeFile(${i})">âœ•</button></div>`).join('');
            document.getElementById('uploadedFiles').style.display = 'block';
        }
        function removeFile(i) { selectedFiles.splice(i, 1); if (selectedFiles.length === 0) document.getElementById('uploadedFiles').style.display = 'none'; else handleFileSelect({ target: { files: selectedFiles } }); }

        async function startAnalysis() {
            if (selectedFiles.length === 0) { showToast('íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error'); return; }
            showLoading('ë°ì´í„° ë¶„ì„ ì¤‘...');
            try {
                const allYearlyData = {};
                for (const file of selectedFiles) {
                    const fd = await parseExcelFile(file);
                    for (const [year, patients] of Object.entries(fd)) { if (!allYearlyData[year]) allYearlyData[year] = new Set(); patients.forEach(p => allYearlyData[year].add(p)); }
                }
                const years = Object.keys(allYearlyData).map(Number).sort((a,b)=>a-b);
                if (years.length === 0) { hideLoading(); showToast('ì—°ë„ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error'); return; }
                const yearlyStats = {}; let totalUnique = new Set();
                years.forEach((year, idx) => {
                    const cur = allYearlyData[year]; Array.from(cur).forEach(p => totalUnique.add(p));
                    if (idx === 0) { yearlyStats[year] = { totalPatients: cur.size, retainedFromPrevious: 0, newPatients: cur.size, churned: 0, retentionRate: 'ì‹ ê·œ' }; }
                    else {
                        const prev = allYearlyData[years[idx-1]];
                        const retained = Array.from(cur).filter(p => prev.has(p)).length;
                        const churned = Array.from(prev).filter(p => !cur.has(p)).length;
                        const newP = Array.from(cur).filter(p => !prev.has(p)).length;
                        yearlyStats[year] = { totalPatients: cur.size, retainedFromPrevious: retained, newPatients: newP, churned, retentionRate: prev.size > 0 ? ((retained/prev.size)*100).toFixed(1) : '0.0' };
                    }
                });
                hideLoading();
                showAnalysisResults({ years, yearlyStats, latestRetentionRate: yearlyStats[years[years.length-1]].retentionRate, totalUniquePatients: totalUnique.size });
                showToast('ë¶„ì„ ì™„ë£Œ! ğŸ‰', 'success');
                // ğŸ”¥ Firestoreì— í†µê³„ ê²°ê³¼ê°’ ì €ì¥ (ê°œì¸ì •ë³´ ì—†ìŒ)
                saveRetentionStats({ years, yearlyStats, latestRetentionRate: yearlyStats[years[years.length-1]].retentionRate, totalUniquePatients: totalUnique.size });
            } catch (err) { hideLoading(); showToast('ë¶„ì„ ì˜¤ë¥˜: ' + err.message, 'error'); console.error(err); }
        }

        async function parseExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const wb = XLSX.read(e.target.result, { type: 'binary' }), sheet = wb.Sheets[wb.SheetNames[0]], json = XLSX.utils.sheet_to_json(sheet), yp = {};
                        json.forEach(row => {
                            const pk = Object.keys(row).find(k => k.includes('í™˜ì')||k.includes('ID')||k.includes('id')||k.includes('ì°¨íŠ¸'));
                            const dk = Object.keys(row).find(k => k.includes('ì—°ë„')||k.includes('ë…„')||k.includes('ë‚ ì§œ')||k.includes('date')||k.includes('ì ‘ìˆ˜')||k.includes('ì§„ë£Œì¼')||k.includes('ìˆ˜ë‚©ì¼')||k.includes('ì‹œê°')||k.includes('ì¼ì‹œ')||k.includes('ì¼ì'));
                            if (pk && row[pk]) {
                                const pid = String(row[pk]).trim(); let yr;
                                if (dk && row[dk]) {
                                    const dv = row[dk];
                                    if (dv instanceof Date) { yr = dv.getFullYear(); }
                                    else if (typeof dv === 'number') { if (dv > 2000 && dv < 2100) yr = dv; else { try { const d = XLSX.SSF.parse_date_code(dv); yr = d.y; } catch(e) { yr = null; } } }
                                    else { const m = String(dv).match(/20\d{2}/); yr = m ? parseInt(m[0]) : null; }
                                }
                                if (yr && pid) { if (!yp[yr]) yp[yr] = new Set(); yp[yr].add(pid); }
                            }
                        });
                        const result = {}; for (const [y, p] of Object.entries(yp)) result[y] = Array.from(p);
                        resolve(result);
                    } catch (err) { reject(err); }
                };
                reader.readAsBinaryString(file);
            });
        }

        function showAnalysisResults(data) {
            document.getElementById('analysisResults').classList.add('show');
            const ly = data.years[data.years.length-1], ls = data.yearlyStats[ly];
            document.getElementById('currentRetention').textContent = data.latestRetentionRate + (data.latestRetentionRate !== 'ì‹ ê·œ' ? '%' : '');
            document.getElementById('totalPatients').textContent = data.totalUniquePatients.toLocaleString();
            document.getElementById('churnedPatients').textContent = ls.churned.toLocaleString();
            document.getElementById('newPatients').textContent = ls.newPatients.toLocaleString();
            document.getElementById('analysisTableBody').innerHTML = data.years.map(y => {
                const s = data.yearlyStats[y], r = parseFloat(s.retentionRate)||0;
                let gt, gc;
                if (s.retentionRate==='ì‹ ê·œ') { gt='ì‹ ê·œ'; gc='status-good'; } else if (r>=55) { gt='ìš°ìˆ˜'; gc='status-excellent'; } else if (r>=50) { gt='ì–‘í˜¸'; gc='status-good'; } else { gt='ë³´í†µ'; gc='status-average'; }
                return `<tr><td style="font-weight:600;">${y}ë…„</td><td style="text-align:center;">${s.retainedFromPrevious.toLocaleString()}ëª…</td><td style="text-align:center;color:#ef4444;">${s.churned.toLocaleString()}ëª…</td><td style="text-align:center;font-weight:600;">${s.totalPatients.toLocaleString()}ëª…</td><td style="text-align:center;font-weight:600;color:#ec4899;">${s.retentionRate}${s.retentionRate!=='ì‹ ê·œ'?'%':''}</td><td style="text-align:center;"><span class="status-badge ${gc}">${gt}</span></td></tr>`;
            }).join('');
            renderRetentionCharts(data);
        }

        function renderRetentionCharts(data) {
            const yrs = data.years;
            const rr = yrs.map(y => { const r = data.yearlyStats[y].retentionRate; return r==='ì‹ ê·œ'?null:parseFloat(r); });
            const cr = rr.map(r => r===null?null:(100-r));
            if (retentionTrendChart) retentionTrendChart.destroy();
            retentionTrendChart = new Chart(document.getElementById('retentionTrendChart'), { type: 'line', data: { labels: yrs.map(y=>y+'ë…„'), datasets: [{ label: 'ìœ ì§€ìœ¨ (%)', data: rr, borderColor: '#ec4899', backgroundColor: 'rgba(236,72,153,0.1)', borderWidth: 3, fill: true, tension: 0.4, pointRadius: 6, pointBackgroundColor: '#ec4899' }, { label: 'ì´íƒˆìœ¨ (%)', data: cr, borderColor: '#6b7280', backgroundColor: 'rgba(107,114,128,0.1)', borderWidth: 2, borderDash: [5,5], tension: 0.4, pointRadius: 4, pointBackgroundColor: '#6b7280' }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top', labels: { usePointStyle: true } } }, scales: { y: { min: 0, max: 100, ticks: { callback: v=>v+'%' } } } } });
            if (monthlyPatientsChart) monthlyPatientsChart.destroy();
            monthlyPatientsChart = new Chart(document.getElementById('monthlyPatientsChart'), { type: 'bar', data: { labels: yrs.map(y=>y+'ë…„'), datasets: [{ label: 'ì´ì›” í™˜ì', data: yrs.map(y=>data.yearlyStats[y].retainedFromPrevious), backgroundColor: '#ec4899', borderRadius: 4 }, { label: 'ì‹ ê·œ í™˜ì', data: yrs.map(y=>data.yearlyStats[y].newPatients), backgroundColor: '#f9a8d4', borderRadius: 4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top', labels: { usePointStyle: true } } }, scales: { x: { stacked: true }, y: { stacked: true } } } });
            if (retentionDonutChart) retentionDonutChart.destroy();
            const ly = yrs[yrs.length-1], ls = data.yearlyStats[ly];
            document.getElementById('donutCenterValue').textContent = ls.retentionRate + (ls.retentionRate!=='ì‹ ê·œ'?'%':'');
            document.getElementById('donutSubValue').textContent = ls.churned.toLocaleString()+'ëª…';
            retentionDonutChart = new Chart(document.getElementById('retentionDonutChart'), { type: 'doughnut', data: { labels: ['ìœ ì§€ í™˜ì','ì´íƒˆ í™˜ì'], datasets: [{ data: [ls.retainedFromPrevious, ls.churned], backgroundColor: ['#ec4899','#e5e7eb'], borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: { display: false } } } });
        }

        // ==================== ìœ í‹¸ë¦¬í‹° ====================
        function showLoading(text) { document.getElementById('loadingText').textContent = text; document.getElementById('loadingOverlay').classList.add('show'); }
        function hideLoading() { document.getElementById('loadingOverlay').classList.remove('show'); }
        function showToast(msg, type) { const t = document.getElementById('toast'); t.textContent = msg; t.className = 'toast ' + type + ' show'; setTimeout(() => t.classList.remove('show'), 3000); }
    </script>
</body>
</html>
